<!DOCTYPE html>
<html lang="es">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script>
        // Simple version check to force reload when file changes
        const version = 'v3';
        if (localStorage.getItem('app_version') !== version) {
            localStorage.setItem('app_version', version);
            location.reload();
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XELONIA uptime - Gestión de Mantenimiento</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="XELONIA uptime">
    <link rel="apple-touch-icon" href="icon-192.png">
    <!-- Fuentes e Iconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Sync Module -->
    <script src="js/firebase-sync.js"></script>

    <!-- Monthly Closure Module -->
    <script src="js/monthly-closure.js" defer></script>




    <style>
        :root {
            --color-bg: #0f172a;
            --color-surface: #1e293b;
            --color-surface-hover: #334155;
            --color-primary: #3b82f6;
            --color-primary-hover: #2563eb;
            --color-accent: #06b6d4;
            --color-text-main: #f8fafc;
            --color-text-muted: #94a3b8;
            --color-border: #334155;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --header-height: 60px;
            --nav-height: 64px;
            --sidebar-width: 240px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            height: 100vh;
            height: 100dvh;
            grid-template-rows: var(--header-height) 1fr var(--nav-height);
            grid-template-areas: "header" "content" "nav";
            overflow: hidden;
            position: fixed;
            /* Evitar scroll rebote del body */
            width: 100%;
        }

        @media (min-width: 768px) {
            .app-container {
                grid-template-columns: var(--sidebar-width) 1fr;
                grid-template-rows: var(--header-height) 1fr;
                grid-template-areas: "sidebar header" "sidebar content";
            }

            .mobile-nav {
                display: none !important;
            }
        }

        @media (max-width: 767px) {
            .sidebar-nav {
                display: none !important;
            }

            /* Force single column grid on mobile */
            .app-container {
                grid-template-columns: 1fr !important;
                grid-template-rows: var(--header-height) 1fr var(--nav-height) !important;
                grid-template-areas: "header" "content" "nav" !important;
            }
        }

        /* FOCUSED TECHNICIAN VIEW - Improved */
        .tecnico-mode.app-container {
            /* Handled by applyRolePermissions and Grid logic */
            background-color: var(--color-bg);
        }

        /* Responsive adjustments for Mobile - Refined */
        @media (max-width: 767px) {
            :root {
                --header-height: 54px;
                --nav-height: 60px;
            }

            body {
                font-size: 13px;
            }

            .branding-logo-header {
                height: 28px !important;
                margin-right: 0.4rem !important;
            }

            #app-title {
                display: none;
                /* Hide full name on mobile to save space */
            }

            .header-actions {
                gap: 5px !important;
            }

            .sos-btn-header {
                padding: 6px 10px !important;
                font-size: 0.7rem !important;
            }

            .role-badge {
                padding: 3px 6px !important;
                font-size: 0.6rem !important;
                white-space: nowrap;
                max-width: 60px;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .view-content {
                padding: 0.7rem;
            }

            .card {
                padding: 0.7rem;
                margin-bottom: 0.7rem;
            }

            /* Better modal sizing on mobile */
            .modal {
                padding: 1rem;
                max-height: 85vh;
                margin-bottom: 0;
            }


            /* CRITICAL: Full width on mobile */
            main {
                padding: 0.5rem !important;
                width: 100vw !important;
                max-width: 100vw !important;
                margin: 0 !important;
            }

            .app-container {
                width: 100vw !important;
                max-width: 100vw !important;
                margin: 0 !important;
            }

            header {
                padding: 0 0.5rem !important;
                width: 100vw !important;
                max-width: 100vw !important;
            }

            .view-content {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0.5rem !important;
                margin: 0 !important;
            }

            .card {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }

            /* Remove any container max-widths */
            * {
                max-width: 100vw !important;
            }
        }

        /* LAYOUT GRID - DESKTOP FIRST */
        .app-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: 70px 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar content";
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: var(--color-bg);
        }

        header {
            grid-area: header;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            border-bottom: 1px solid var(--color-border);
            z-index: 50;
        }

        nav.sidebar-nav {
            grid-area: sidebar;
            background: var(--color-surface);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            z-index: 60;
        }

        main {
            grid-area: content;
            overflow-y: auto;
            background-color: var(--color-bg);
            padding: 2rem;
            position: relative;
            /* Smooth scrolling */
            scroll-behavior: smooth;
        }

        /* MOBILE NAV (Base Styles) */
        nav.mobile-nav {
            grid-area: nav;
            /* Only used if we add a row for it in desktop, but usually hidden */
            display: none;
            /* Hidden on desktop by default */
            background: var(--color-surface);
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--color-border);
            z-index: 1000;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
            flex: 1;
        }

        .mobile-nav-item span {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .mobile-nav-item.active {
            color: var(--color-primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            gap: 0.5rem;
            background: transparent;
            color: var(--color-text-muted);
        }

        .btn-sidebar {
            justify-content: flex-start;
            width: 100%;
            text-align: left;
        }

        .btn-sidebar.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--color-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }

        .card {
            background-color: var(--color-surface);
            border-radius: 12px;
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .bg-success {
            background-color: var(--color-success);
        }

        .bg-warning {
            background-color: var(--color-warning);
        }

        .bg-danger {
            background-color: var(--color-danger);
        }

        .view-content {
            animation: fadeIn 0.3s ease-out;
            padding: 1.2rem;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #app-loader {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--color-bg);
            z-index: 1000;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: flex-start;
            /* Alineamos al inicio para que el scroll sea natural */
            z-index: 2000;
            padding: 2rem 1rem;
            overflow-y: auto;
            /* Habilitar scroll en el overlay */
        }

        .modal {
            background: var(--color-surface);
            padding: 1.5rem;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--color-border);
            margin-bottom: 2rem;
            /* Margen inferior para que no choque con el borde al scrollear */
            position: relative;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-bottom: 4px;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: white;
            font-family: inherit;
        }

        /* Login Overlay */
        #login-screen {
            position: fixed;
            inset: 0;
            background: var(--color-bg);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .login-card {
            background: var(--color-surface);
            padding: 2rem;
            border-radius: 20px;
            width: 100%;
            max-width: 360px;
            border: 1px solid var(--color-border);
            text-align: center;
        }

        /* --- RESPONSIVE DESIGN & MOBILE UX --- */

        /* Mobile Bottom Nav Styles */
        .mobile-nav {
            display: none;
            /* Hidden by default (Desktop) */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            z-index: 1000;
            align-items: center;
            justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
            /* iOS Safe Area */
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 0.7rem;
            gap: 4px;
            padding: 8px;
            width: 100%;
        }

        .mobile-nav-item.active {
            color: var(--color-primary);
        }

        .mobile-nav-item.active span.material-symbols-rounded {
            font-variation-settings: 'FILL' 1;
        }

        .qr-fab {
            background: var(--color-primary);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            margin-top: -30px;
            /* Float effect */
            border: 4px solid var(--color-bg);
        }

        /* MEDIA QUERIES */

        /* TABLET (768px - 1024px) */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 80px 1fr;
                /* Slim sidebar */
            }

            .sidebar-nav .btn-sidebar {
                justify-content: center;
                padding: 15px 0;
            }

            .btn-sidebar span:not(.material-symbols-rounded) {
                display: none;
                /* Hide text, icon only */
            }

            .branding-logo-header {
                display: none;
            }
        }

        /* MOBILE (< 768px) */
        @media (max-width: 767px) {

            /* Layout & Typography Scaling */
            html {
                font-size: 14px;
                /* Scale down base font 12.5% */
            }

            .app-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            /* Hide Desktop Sidebar */
            .sidebar-nav {
                display: none !important;
            }

            /* Show Mobile Nav */
            .mobile-nav {
                display: flex;
            }

            /* Header Adjustments */
            header {
                padding: 0 15px;
                height: 60px;
            }

            #header-avatar-container {
                width: 32px;
                height: 32px;
            }

            /* Content Area */
            main {
                padding: 15px !important;
                /* Reduce padding */
                padding-bottom: 90px !important;
                /* Space for Bottom Nav */
                flex: 1;
                overflow-y: auto;
            }

            /* Components */
            .stat-card {
                padding: 15px;
            }

            .dashboard-grid,
            .stats-grid {
                grid-template-columns: 1fr !important;
                /* Stack columns */
            }

            /* Modals - Bottom Sheet Style */
            .modal {
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 20px 20px 0 0 !important;
                margin: 0;
                position: absolute;
                bottom: 0;
                max-height: 90vh !important;
                animation: slideUp 0.3s ease-out;
            }

            .modal-overlay {
                align-items: flex-end;
                /* Align to bottom */
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }

                to {
                    transform: translateY(0);
                }
            }

            /* Login / User Selector adjustments */
            #user-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Buttons */
            .btn {
                padding: 12px;
                /* Touch target size */
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .sos-btn-header {
            background: var(--color-danger);
            color: white;
            font-weight: 900;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            animation: pulse-red 2s infinite;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: auto;
            /* Push to right */
            margin-right: 15px;
        }

        /* HEADER & MAIN CONTENT */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            height: 70px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-border);
            z-index: 50;
            grid-row: 1;
            grid-column: 2;
        }

        main {
            grid-row: 2;
            grid-column: 2;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }

        .tactical-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tactical-btn {
            padding: 20px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-main);
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .tactical-btn.selected {
            background: var(--color-primary);
            border-color: var(--color-primary-hover);
            color: white;
        }

        .tactical-btn:active {
            transform: scale(0.95);
        }

        .config-list-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--color-border);
            background: rgba(0, 0, 0, 0.2);
        }

        /* Audit Status Buttons */
        .btn-st {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .btn-st:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .audit-row:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Header Styles */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar-container {
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--color-surface-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .role-badge {
            cursor: pointer;
            background: rgba(59, 130, 246, 0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            transition: all 0.2s;
            user-select: none;
        }

        .role-badge:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .logout-btn {
            padding: 6px;
            color: var(--color-danger);
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Branding Enhancements - Cinematic Reveal */
        .branding-logo-loader {
            height: auto;
            width: auto;
            max-height: 250px;
            max-width: 80vw;
            object-fit: contain;
            /* No Border, No Circle - Pure floating asset */
            animation: cinematic-drift 5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            display: block;
            margin: auto;
            mix-blend-mode: lighten;
            /* Static filter removed because animation controls it */
        }

        @keyframes cinematic-drift {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(15px);
                /* High start contrast to hide bg, but brighter */
                filter: blur(12px) drop-shadow(0 0 0 rgba(6, 182, 212, 0)) brightness(1.1) contrast(1.1);
            }

            25% {
                opacity: 1;
                /* Peak glow with boosted saturation for text */
                filter: blur(0px) drop-shadow(0 0 50px rgba(6, 182, 212, 0.8)) brightness(1.3) contrast(1.05) saturate(1.5);
            }

            100% {
                opacity: 1;
                transform: scale(1.05) translateY(0);
                /* Balanced finish: clean text, no box */
                filter: blur(0px) drop-shadow(0 0 20px rgba(6, 182, 212, 0.5)) brightness(1.2) contrast(1.05) saturate(1.3);
            }
        }

        .branding-logo-login {
            height: 220px;
            margin-bottom: 2rem;
            filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.6));
            mix-blend-mode: lighten;
        }

        .branding-logo-header {
            height: 48px;
            width: auto;
            margin-right: 0.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            mix-blend-mode: lighten;
        }
    </style>
</head>

<body>
    <!-- SPLASH SCREEN -->
    <div id="splash-screen"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.6s ease-out;">
        <div style="text-align: center; animation: fadeInScale 0.8s ease-out;">
            <img src="file:///C:/Users/theli/.gemini/antigravity/brain/4aae52ec-39dd-4953-b2ff-323148e3d7b7/uploaded_image_1766761971434.jpg"
                alt="XELONIA Logo"
                style="width: 180px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 10px 30px rgba(59, 130, 246, 0.3));">
            <h1 style="color: #f8fafc; font-size: 2.5rem; font-weight: 300; letter-spacing: 3px; margin: 0;">
                XELONIA <span style="color: #06b6d4; font-weight: 600;">uptime</span>
            </h1>
            <div
                style="margin-top: 30px; width: 60px; height: 4px; background: linear-gradient(90deg, #3b82f6, #06b6d4); margin-left: auto; margin-right: auto; border-radius: 2px; animation: pulse 1.5s ease-in-out infinite;">
            </div>
        </div>
    </div>

    <style>
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>

    <script>
        // Baby Turtle Sound Synthesis
        function playBabyTurtleSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;

                // Create oscillators for a gentle, organic sound
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                // Soft, high-pitched tone (baby-like)
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(800, now); // Higher pitch
                osc1.frequency.exponentialRampToValueAtTime(1200, now + 0.15); // Quick chirp up
                osc1.frequency.exponentialRampToValueAtTime(900, now + 0.4); // Settle down

                // Subtle harmonic
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(1600, now);
                osc2.frequency.exponentialRampToValueAtTime(2000, now + 0.15);
                osc2.frequency.exponentialRampToValueAtTime(1400, now + 0.4);

                // Gentle volume envelope
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.15, now + 0.05); // Soft attack
                gainNode.gain.linearRampToValueAtTime(0.12, now + 0.2); // Sustain
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5); // Gentle fade

                // Connect nodes
                osc1.connect(gainNode);
                osc2.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Play
                osc1.start(now);
                osc2.start(now);
                osc1.stop(now + 0.6);
                osc2.stop(now + 0.6);
            } catch (e) {
                console.log('Audio not supported or blocked:', e);
            }
        }

        // Splash screen logic
        window.addEventListener('DOMContentLoaded', () => {
            const splash = document.getElementById('splash-screen');

            // Clear any previous session to force fresh login
            sessionStorage.removeItem('cmms_session');

            // Play sound after a tiny delay (helps with autoplay policies)
            setTimeout(() => {
                playBabyTurtleSound();
            }, 300);

            // Hide splash after 2.5 seconds and show user selector
            setTimeout(() => {
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    // Show user selector
                    showUserSelector();
                }, 600); // Wait for fade-out animation
            }, 2500);
        });
    </script>

    <style>
        #app-loader {
            position: fixed;
            inset: 0;
            background-color: #0f172a;
            /* Ensure the background matches the design */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    </style>

    <div id="app-loader" style="display: none;">
        <img src="logo.jpg" class="branding-logo-loader" alt="XELONIA Logo">
    </div>

    <style>
        @keyframes pulse-logo {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }
    </style>

    <!-- PANTALLA DE SELECTOR DE USUARIOS -->
    <div id="user-selector-screen"
        style="display: none; position: fixed; inset: 0; background: var(--color-bg); z-index: 3000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 0 auto; padding: 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <img src="logo.jpg"
                    style="width: 120px; height: auto; margin-bottom: 1rem; filter: drop_shadow(0 10px 30px rgba(59, 130, 246, 0.3));">
                <h2 style="margin-top: 0; letter-spacing: 2px; color: white;">XELONIA <span
                        style="font-weight: 300; font-size: 1rem; color: var(--color-accent);">uptime</span></h2>
                <p style="color: var(--color-text-muted); font-size: 0.9rem;">Selecciona tu usuario para acceder</p>
            </div>

            <div id="user-grid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-bottom: 2rem;">
                <!-- Generado dinámicamente -->
            </div>
        </div>
    </div>

    <style>
        .user-card {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-card:hover {
            transform: translateY(-4px);
            border-color: var(--color-primary);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .user-card.supervisor {
            border-color: var(--color-warning);
            background: linear-gradient(135deg, var(--color-surface), rgba(245, 158, 11, 0.05));
        }

        .user-card.supervisor:hover {
            border-color: var(--color-warning);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 12px;
            border: 3px solid var(--color-border);
            display: block;
        }

        .user-card:hover .user-avatar {
            border-color: var(--color-primary);
        }

        .user-card.supervisor .user-avatar {
            border-color: var(--color-warning);
        }
    </style>

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen" style="display: none;">
        <div class="login-card">
            <img src="file:///C:/Users/theli/.gemini/antigravity/brain/4aae52ec-39dd-4953-b2ff-323148e3d7b7/uploaded_image_1766761971434.jpg"
                class="branding-logo-login" alt="XELONIA Logo">
            <h2 style="margin-top: 0; letter-spacing: 2px;">XELONIA <span
                    style="font-weight: 300; font-size: 1rem; color: var(--color-accent);">uptime</span></h2>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 2rem;">Ingresa tus credenciales
                para acceder</p>

            <div class="form-group" style="text-align: left;">
                <label>Código de Usuario</label>
                <input type="text" id="login-user" class="form-control" placeholder="Ej: JP001 o admin">
            </div>

            <div class="form-group" style="text-align: left;">
                <label>Contraseña</label>
                <input type="password" id="login-pass" class="form-control" placeholder="••••••">
            </div>

            <button onclick="login()" class="btn btn-primary"
                style="width: 100%; margin-top: 1rem; padding: 1rem;">Entrar al Sistema</button>
            <div id="login-error"
                style="color: var(--color-danger); font-size: 0.8rem; margin-top: 10px; display: none;">Credenciales
                incorrectas</div>
        </div>
    </div>


    <!-- MODAL NUEVO/EDITAR TÉCNICO -->



    <!-- MODAL DETALLE DE EQUIPO (FICHA DE VIDA) -->
    <div id="modal-detalle" class="modal-overlay">
        <div class="modal" style="max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 0;">
            <div id="detalle-header" style="position: relative;">
                <img id="det-foto" src=""
                    style="width: 100%; height: 200px; object-fit: cover; display: none; border-radius: 16px 16px 0 0;">
                <div id="det-no-foto"
                    style="width: 100%; height: 120px; background: var(--color-surface-hover); display: flex; align-items: center; justify-content: center; border-radius: 16px 16px 0 0;">
                    <span class="material-symbols-rounded"
                        style="font-size: 48px; color: var(--color-primary);">precision_manufacturing</span>
                </div>
                <button onclick="closeDetails()" class="btn"
                    style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 36px; height: 36px; padding: 0;">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>

            <div style="padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <h2 id="det-nombre" style="margin: 0; font-size: 1.4rem;">Nombre Equipo</h2>
                        <div id="det-marca-modelo"
                            style="color: var(--color-text-muted); font-size: 0.9rem; margin-top: 4px;">Marca /
                            Modelo
                        </div>
                    </div>
                    <div id="det-status-badge"
                        style="padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;">
                        ACTIVO
                    </div>
                </div>

                <!-- MONITOR DE SALUD (GRAFICO DISPO + ALERTAS) -->
                <div id="salud-container"
                    style="margin: 1.2rem 0; padding: 1rem; border-radius: 12px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <div
                            style="position: relative; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="3" />
                                <path id="dispo-gauge"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none" stroke="var(--color-success)" stroke-width="3"
                                    stroke-dasharray="100, 100" />
                            </svg>
                            <div style="position: absolute; text-align: center;">
                                <div id="det-dispo-val" style="font-size: 1.1rem; font-weight: 800; color: white;">99%
                                </div>
                                <div
                                    style="font-size: 0.5rem; color: var(--color-text-muted); text-transform: uppercase;">
                                    Dispo</div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <h4 id="salud-title"
                                style="margin: 0 0 4px 0; font-size: 0.85rem; color: var(--color-success);">
                                Operación
                                Óptima</h4>
                            <p id="salud-msg"
                                style="margin: 0; font-size: 0.7rem; color: var(--color-text-muted); line-height: 1.3;">
                                El activo mantiene niveles de disponibilidad saludables para la operación.</p>
                        </div>
                    </div>
                    <!-- Alerta de Inversión (Hidden by default) -->
                    <div id="alerta-inversion"
                        style="display: none; margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">
                        <div
                            style="display: flex; align-items: center; gap: 8px; color: var(--color-danger); font-size: 0.75rem; font-weight: 700; margin-bottom: 4px;">
                            <span class="material-symbols-rounded" style="font-size: 16px;">warning</span>
                            ALERTA DE REEMPLAZO RECOMENDADO
                        </div>
                        <p style="margin: 0; font-size: 0.7rem; color: #fca5a5;">La disponibilidad es inferior
                            al 65%.
                            Se recomienda evaluar presupuesto **CAPEX** para sustitución o **OPEX mayor** para
                            reparación integral.</p>
                    </div>
                </div>

                <div class="dashboard-grid" style="padding: 1rem 0; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                    <div class="card"
                        style="margin: 0; padding: 0.6rem; background: var(--color-bg); border: 1px solid rgba(255,255,255,0.05);">
                        <div style="font-size: 0.6rem; color: var(--color-text-muted);">Horómetro</div>
                        <div id="det-horas" style="font-size: 0.9rem; font-weight: 700;">0 h</div>
                    </div>
                    <div class="card"
                        style="margin: 0; padding: 0.6rem; background: var(--color-bg); border: 1px solid rgba(255,255,255,0.05);">
                        <div style="font-size: 0.6rem; color: var(--color-text-muted);">Frecuencia</div>
                        <div id="det-freq" style="font-size: 0.9rem; font-weight: 700;">0 h</div>
                    </div>
                    <div class="card"
                        style="margin: 0; padding: 0.6rem; background: var(--color-bg); border: 1px solid rgba(255,255,255,0.05);">
                        <div style="font-size: 0.6rem; color: var(--color-text-muted);">Próxima</div>
                        <div id="det-prox" style="font-size: 0.9rem; font-weight: 700; color: var(--color-primary);">0 h
                        </div>
                    </div>
                </div>

                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 1rem; background: rgba(255,255,255,0.02); padding: 10px; border-radius: 8px;">
                    <div>
                        <h4
                            style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase;">
                            <span class="material-symbols-rounded"
                                style="font-size: 14px; vertical-align: middle;">location_on</span> Ubicación
                        </h4>
                        <p id="det-area" style="margin: 0; font-size: 0.85rem; font-weight: 500;">Área</p>
                    </div>
                    <div>
                        <h4
                            style="margin: 0 0 4px 0; font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase;">
                            <span class="material-symbols-rounded"
                                style="font-size: 14px; vertical-align: middle;">calendar_today</span> Inicio
                            Gestión
                        </h4>
                        <p id="det-fecha-inicio" style="margin: 0; font-size: 0.85rem; font-weight: 500;">
                            01/01/2026</p>
                    </div>
                </div>

                <div
                    style="margin-top: 1rem; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.1);">
                    <h4
                        style="margin: 0 0 10px 0; font-size: 0.75rem; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.5px;">
                        Especificaciones Técnicas</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Capacidad</div>
                            <div id="det-capacidad" style="font-size: 0.8rem; font-weight: 600;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Refrigerante</div>
                            <div id="det-refrigerante" style="font-size: 0.8rem; font-weight: 600;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Alimentación</div>
                            <div id="det-tension" style="font-size: 0.8rem; font-weight: 600;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Compresor</div>
                            <div id="det-compresor" style="font-size: 0.8rem; font-weight: 600;">-</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4
                        style="margin: 0 0 10px 0; font-size: 0.8rem; color: var(--color-primary); text-transform: uppercase;">
                        Curva de Disponibilidad</h4>
                    <div
                        style="height: 180px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,0.05);">
                        <canvas id="dispoChart"></canvas>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
                    <h4
                        style="margin: 0 0 8px 0; font-size: 0.8rem; color: var(--color-text-muted); text-transform: uppercase;">
                        Notas Técnicas</h4>
                    <p id="det-notes" style="margin: 0; font-size: 0.85rem; line-height: 1.4; color: #cbd5e1;">
                    </p>
                </div>

                <!-- QUICK-FIX BUTTON (Técnicos) -->
                <div id="quick-fix-container" style="margin-top: 1rem; margin-bottom: 1rem;"></div>

                <!-- DOCUMENTACIÓN TÉCNICA DEL EQUIPO -->
                <div id="equipment-manuals-section" style="margin-top: 1.5rem; margin-bottom: 1.5rem;"></div>

                <div>
                    <h4
                        style="margin: 0 0 12px 0; font-size: 0.8rem; border-bottom: 1px solid var(--color-border); padding-bottom: 8px; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.5px;">
                        Historial de Vida del Equipo</h4>
                    <div id="det-historial">
                        <!-- Items de historial -->
                        <div
                            style="display: flex; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.03);">
                            <div
                                style="color: var(--color-success); font-size: 0.7rem; font-weight: bold; width: 60px;">
                                12
                                DIC</div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.8rem; font-weight: 600;">Mantenimiento Preventivo</div>
                                <div style="font-size: 0.7rem; color: var(--color-text-muted);">Ajuste de
                                    correas y
                                    lubricación.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 10px;">
                    <button id="btn-edit-det" class="btn"
                        style="flex: 1; border: 1px solid var(--color-border); background: var(--color-surface);">
                        <span class="material-symbols-rounded">edit</span> Editar Ficha
                    </button>
                    <button id="btn-delete" class="btn"
                        style="background: rgba(239, 68, 68, 0.1); color: var(--color-danger); flex: 1; border: 1px solid rgba(239, 68, 68, 0.2);">
                        <span class="material-symbols-rounded">delete</span> Eliminar
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AUDITORÍA DE SEGURIDAD Y HERRAMIENTAS -->
    <div id="modal-auditoria" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin:0; display: flex; align-items: center; gap: 8px;">
                    <span class="material-symbols-rounded" style="color: var(--color-warning);">verified_user</span>
                    Auditoría de Seguridad
                </h3>
                <span onclick="closeModalAuditoria()" class="material-symbols-rounded"
                    style="cursor:pointer; color: var(--color-text-muted);">close</span>
            </div>

            <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 1.2rem;">
                Por favor, verifica el estado de tus herramientas y equipo de seguridad antes de iniciar la labor.
            </p>

            <div id="auditoria-content" style="max-height: 50vh; overflow-y: auto;">
                <!-- Se llena dinámicamente -->
            </div>

            <div style="margin-top: 1.5rem; border-top: 1px solid var(--color-border); padding-top: 1rem;">
                <label style="font-size: 0.7rem; color: var(--color-primary); font-weight: 700;">¿SUGERIR HERRAMIENTA O
                    EPP ADICIONAL?</label>
                <textarea id="audit-suggestion" class="form-control"
                    placeholder="Ej: Se requiere llave dinamométrica para este equipo..."
                    style="font-size: 0.75rem; height: 50px; margin-top: 5px;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="closeModalAuditoria()" class="btn"
                    style="flex: 1; border: 1px solid var(--color-border);">Cancelar</button>
                <button id="btn-confirmar-auditoria" class="btn btn-primary" style="flex: 2; font-weight: 900;">TODO
                    VERIFICADO, COMENZAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL REGISTRO DE TRABAJO (FOTOS + FEEDBACK) -->
    <div id="modal-registro-trabajo" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="reg-titulo" style="margin:0; display: flex; align-items: center; gap: 8px;">
                    <span class="material-symbols-rounded" style="color: var(--color-primary);">camera_alt</span>
                    Registro de Trabajo
                </h3>
                <span onclick="closeModalRegistro()" class="material-symbols-rounded"
                    style="cursor:pointer; color: var(--color-text-muted);">close</span>
            </div>

            <p id="reg-instruccion" style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 1rem;">
                Por favor, captura una imagen para documentar el estado del equipo.
            </p>

            <div class="form-group">
                <label id="reg-label-foto">Fotografía Obligatoria *</label>
                <input type="file" id="reg-foto-input" class="form-control" accept="image/*" capture="camera">
                <div id="reg-foto-preview" style="margin-top: 10px; display: none;">
                    <img id="reg-preview-img"
                        style="width: 100%; border-radius: 8px; border: 1px solid var(--color-border); max-height: 200px; object-fit: cover;">
                </div>
            </div>

            <div id="reg-feedback-container" style="display: none;">
                <div class="form-group" id="reg-levantamiento-group" style="display: none;">
                    <label id="reg-lev-label">¿Qué encontraste? (Reporte de Falla) *</label>
                    <textarea id="reg-levantamiento-val" class="form-control" rows="3"
                        placeholder="Describe el problema detectado..."></textarea>
                </div>
                <div class="form-group" id="reg-cond-group">
                    <label>Condiciones Encontradas</label>
                    <textarea id="reg-condiciones" class="form-control" rows="2"
                        placeholder="Ej: Filtros saturados por polvo ambiental..."></textarea>
                </div>
                <div class="form-group" id="reg-diag-group">
                    <label>Diagnóstico Técnico (CAPEX/OPEX)</label>
                    <textarea id="reg-diagnostico" class="form-control" rows="2"
                        placeholder="Ej: Se sugiere cambio de compresor para próximo trimestre..."></textarea>
                </div>

                <!-- SECCIÓN CONSUMO DE REPUESTOS -->
                <div id="reg-repuestos-group"
                    style="border-top: 1px solid var(--color-border); padding-top: 10px; margin-top: 10px;">
                    <label style="color: var(--color-primary); font-size: 0.75rem; font-weight: 800;">¿CONSUMISTE
                        REPUESTOS?</label>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <select id="reg-repuesto-select" class="form-control" style="flex: 2; font-size: 0.75rem;">
                            <option value="">Seleccionar Repuesto...</option>
                        </select>
                        <input type="number" id="reg-repuesto-cant" class="form-control" placeholder="Cant."
                            style="flex: 1; font-size: 0.75rem;">
                        <button onclick="addRepuestoRow()" class="btn btn-primary" style="padding: 0 10px;">+</button>
                    </div>
                    <div id="reg-repuestos-list" style="margin-top: 10px; font-size: 0.7rem;">
                        <!-- JS Injected Rows -->
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="closeModalRegistro()" class="btn"
                    style="flex: 1; border: 1px solid var(--color-border);">Cancelar</button>
                <button id="btn-confirmar-registro" class="btn btn-primary" style="flex: 2; font-weight: 700;">GUARDAR Y
                    CONTINUAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL DE EQUIPO (ADD/EDIT) -->
    <div id="modal-equipo" class="modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="modal-title" style="margin:0;">Nueva Ficha Técnica</h3>
                <span onclick="closeModal()" class="material-symbols-rounded"
                    style="cursor:pointer; color: var(--color-text-muted);">close</span>
            </div>
            <input type="hidden" id="eq-id">

            <div class="form-group">
                <label>Nombre del Equipo *</label>
                <input type="text" id="eq-nombre" class="form-control" placeholder="Ej: Chiller Central">
            </div>
            <div class="form-group">
                <label>Área / Ubicación *</label>
                <input type="text" id="eq-area" class="form-control" placeholder="Ej: Azotea">
            </div>

            <!-- Sección Managerial -->
            <div id="eq-financial-section"
                style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(59, 130, 246, 0.2);">
                <div
                    style="font-size: 0.65rem; font-weight: 800; color: var(--color-primary); margin-bottom: 8px; text-transform: uppercase;">
                    Gestión Financiera (CAPEX)</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label style="font-size: 0.6rem;">Valor Mercado</label>
                        <input type="number" id="eq-valor-mercado" class="form-control" placeholder="Ej: 8500000"
                            style="padding: 4px; font-size: 0.75rem;">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label style="font-size: 0.6rem;">Valor Adquisición</label>
                        <input type="number" id="eq-valor-adq" class="form-control" placeholder="Ej: 12000000"
                            style="padding: 4px; font-size: 0.75rem;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label>Horómetro (h)</label>
                    <input type="number" id="eq-horas" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label>Frecuencia (h)</label>
                    <input type="number" id="eq-freq" class="form-control" value="250">
                </div>
            </div>

            <div class="form-group">
                <label
                    style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem; cursor: pointer; margin: 10px 0;">
                    <input type="checkbox" id="eq-is-critico"> <strong>Equipo Vital (AA/AAA)</strong>
                </label>
            </div>

            <div class="form-group">
                <label>Especialidad Requerida</label>
                <select id="eq-especialidad" class="form-control">
                    <option value="Clima">Clima / HVAC</option>
                    <option value="Electricidad">Electricidad</option>
                    <option value="Mecánica">Mecánica</option>
                    <option value="Hidráulica">Hidráulica</option>
                    <option value="General">Mantenimiento General</option>
                    <option value="Termodinámica">Termodinámica</option>
                    <option value="Infraestructura">Infraestructura</option>
                </select>
            </div>

            <div class="form-group">
                <label>Estado Operativo</label>
                <select id="eq-estado" class="form-control" onchange="toggleDiagField()">
                    <option value="activo">Activo / Operativo</option>
                    <option value="alerta">Alerta (Requiere Atención)</option>
                    <option value="peligro">Peligro (Fuera de Servicio)</option>
                </select>
            </div>

            <div class="form-group" id="div-diag" style="display:none; transition: all 0.3s ease;">
                <label
                    style="color: var(--color-warning); font-weight: 800; display: flex; align-items: center; gap: 4px;">
                    <span class="material-symbols-rounded" style="font-size: 16px;">label_important</span>
                    ETIQUETA DE DIAGNÓSTICO
                </label>
                <input type="text" id="eq-diagnostico" class="form-control"
                    placeholder="Ej: Falla Rodamientos, Temp Alta..."
                    style="border-color: var(--color-warning)44; background: var(--color-warning)11;">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 4px;">
                    <span class="material-symbols-rounded" style="font-size: 16px;">notes</span>
                    Notas Adicionales
                </label>
                <textarea id="eq-notas" class="form-control" rows="2"
                    placeholder="Observaciones técnicas..."></textarea>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label style="display: flex; align-items: center; gap: 4px; margin-bottom: 0.8rem;">
                    <span class="material-symbols-rounded"
                        style="font-size: 16px; color: var(--color-primary);">photo_camera</span>
                    Fotografía de Referencia
                </label>
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <input type="file" id="eq-foto" class="form-control" accept="image/*"
                            style="font-size: 0.7rem; padding: 0.5rem;">
                        <p style="font-size: 0.6rem; color: var(--color-text-muted); margin-top: 4px;">Máx 2MB
                            (JPEG/PNG)</p>
                    </div>
                </div>
                <div id="foto-preview"
                    style="margin-top: 10px; display: none; text-align: center; background: rgba(0,0,0,0.4); border-radius: 12px; padding: 15px; border: 1px dashed rgba(255,255,255,0.1);">
                    <img id="preview-img"
                        style="max-width: 100%; max-height: 180px; border-radius: 8px; object-fit: contain; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                    <button
                        onclick="document.getElementById('eq-foto').value=''; document.getElementById('foto-preview').style.display='none';"
                        class="btn"
                        style="font-size: 0.7rem; margin-top: 8px; color: var(--color-danger); padding: 4px 8px;">
                        Eliminar Foto
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 2rem;">
                <button class="btn btn-primary" style="flex: 2; height: 48px; font-weight: 800; letter-spacing: 0.5px;"
                    onclick="saveEquipo()">GUARDAR ACTIVO</button>
                <button class="btn" style="flex: 1; border: 1px solid var(--color-border); height: 48px;"
                    onclick="closeModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo/Editar Técnico -->
    <div id="modal-tecnico" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="modal-tecnico-title" style="margin:0;">Nuevo Técnico</h3>
                <span onclick="closeModalTecnico()" class="material-symbols-rounded"
                    style="cursor:pointer; color: var(--color-text-muted);">close</span>
            </div>
            <input type="hidden" id="tec-id">

            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" id="tec-nombre" class="form-control" placeholder="Nombre del técnico">
            </div>

            <!-- PIN DE ACCESO -->
            <div class="form-group">
                <label style="display: flex; justify-content: space-between; align-items: center;">
                    <span>PIN de Acceso (4 dígitos)</span>
                    <button type="button" onclick="togglePinVisibility('tec-pin')"
                        style="background: none; border: none; color: var(--color-primary); cursor: pointer; padding: 0; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;"
                        title="Mostrar/Ocultar PIN">
                        <span class="material-symbols-rounded" id="tec-pin-eye"
                            style="font-size: 18px;">visibility</span>
                    </button>
                </label>
                <input type="password" id="tec-pin" class="form-control" placeholder="••••" maxlength="4"
                    pattern="[0-9]{4}"
                    style="font-size: 1.2rem; letter-spacing: 8px; text-align: center; font-weight: bold;">
                <div style="font-size: 0.65rem; color: var(--color-text-muted); margin-top: 4px;">El técnico creará su
                    PIN en su primer acceso</div>
            </div>

            <!-- NUEVOS CAMPOS: TITULAR Y TURNO -->
            <div
                style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--color-border);">
                <div class="form-group" style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer;">
                        <input type="checkbox" id="tec-is-titular"> ES TITULAR (Líder de Cuadrilla)
                    </label>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 0.7rem;">Inicia Turno</label>
                        <input type="time" id="tec-turno-inicio" class="form-control" style="font-size: 0.8rem;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 0.7rem;">Termina Turno</label>
                        <input type="time" id="tec-turno-fin" class="form-control" style="font-size: 0.8rem;">
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label id="lbl-especialidades">Especialidades (Seleccione todas las que apliquen)</label>
                    <div id="tec-skills-container"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; max-height: 120px; overflow-y: auto;">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="Clima"> Clima / HVAC</label>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="Electricidad"> Electricidad</label>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="Mecánica"> Mecánica</label>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="Hidráulica"> Hidráulica</label>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="Electrónica"> Electrónica</label>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="Soldadura"> Soldadura</label>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="Albañilería"> Albañilería</label>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;"><input
                                type="checkbox" value="General"> Mantenimiento General</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Eficacia %</label>
                    <input type="number" id="tec-eficacia" class="form-control" value="100">
                </div>
            </div>

            <!-- Sección OPEX Técnico -->
            <div
                style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid rgba(16, 185, 129, 0.2);">
                <div
                    style="font-size: 0.65rem; font-weight: 800; color: var(--color-success); margin-bottom: 8px; text-transform: uppercase;">
                    Valor HH (OPEX)</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label style="font-size: 0.6rem;">Sueldo Mensual</label>
                        <input type="number" id="tec-salario" class="form-control" placeholder="Ej: 850000"
                            style="padding: 4px; font-size: 0.75rem;">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label style="font-size: 0.6rem;">Valor Hora (Auto)</label>
                        <input type="number" id="tec-costo-hora-display" class="form-control" readonly
                            style="padding: 4px; font-size: 0.75rem; background: rgba(0,0,0,0.2);">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn btn-primary" style="flex: 2;" onclick="saveTecnico()">GUARDAR TÉCNICO</button>
                <button class="btn" style="flex: 1; border: 1px solid var(--color-border);"
                    onclick="closeModalTecnico()">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- BOTÓN DE RESET (SOLO PARA DESARROLLO/DEMO) -->
    <button id="btn-reset-demo" onclick="factoryReset()"
        style="position: fixed; bottom: 80px; right: 20px; z-index: 1000; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.2); border: none; font-size: 10px; cursor: pointer; padding: 5px; border-radius: 4px;">Reset
        Data</button>

    <!-- MODAL PIN SECURITY -->
    <div id="modal-pin" class="modal-overlay" style="display: none; align-items: center; justify-content: center;">
        <div class="login-card" style="max-width: 320px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <img id="pin-user-avatar" src=""
                    style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--color-primary); object-fit: cover; background: #333;">
                <h3 id="pin-title" style="margin-top: 10px; margin-bottom: 5px;">Acceso Seguro</h3>
                <p style="font-size: 0.8rem; color: var(--color-text-muted);">Seleccione usuario e ingrese PIN</p>
            </div>

            <!-- User Selector -->
            <div style="margin-bottom: 20px;">
                <select id="pin-user-select" class="form-control"
                    style="text-align: center; font-weight: bold; background: rgba(0,0,0,0.3); border-color: var(--color-border);">
                    <!-- Populated via JS -->
                </select>
            </div>

            <!-- PIN Dots -->
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;">
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
                <div class="pin-dot"></div>
            </div>

            <!-- Keypad -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('1')">1</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('2')">2</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('3')">3</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('4')">4</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('5')">5</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('6')">6</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('7')">7</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('8')">8</button>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('9')">9</button>
                <div></div>
                <button class="btn pin-key"
                    style="background: rgba(255,255,255,0.05); font-size: 1.2rem; padding: 15px;"
                    onclick="handlePinInput('0')">0</button>
                <button class="btn"
                    style="background: rgba(239, 68, 68, 0.2); color: var(--color-danger); font-size: 1.2rem; padding: 15px;"
                    onclick="backspacePin()">⌫</button>
            </div>

            <div id="pin-error"
                style="color: var(--color-danger); font-size: 0.8rem; display: none; margin-bottom: 10px;">PIN
                Incorrecto</div>

            <button onclick="closePinModal()" class="btn"
                style="background: transparent; color: var(--color-text-muted); font-size: 0.8rem;">CANCELAR</button>
        </div>
    </div>

    <!-- MODAL BALANCEO DE CARGA -->
    <div id="modal-balance" class="modal-overlay">
        <div class="modal" style="max-width: 500px; border-left: 6px solid var(--color-warning);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin:0; text-transform: uppercase; letter-spacing: 0.5px;">⚖️ Balanceo de Turno</h3>
                <span onclick="closeBalanceModal()" class="material-symbols-rounded"
                    style="cursor:pointer; color: var(--color-text-muted);">close</span>
            </div>

            <p style="font-size:0.8rem; color:var(--color-text-muted); margin-bottom: 15px;">
                El sistema ha detectado una oportunidad de optimización. Mueva tareas del técnico saturado al técnico
                disponible.
            </p>

            <div
                style="display: grid; grid-template-columns: 1fr 40px 1fr; gap: 5px; align-items: center; margin-bottom: 20px;">
                <!-- Source -->
                <div
                    style="background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <div style="font-size: 0.65rem; color: var(--color-danger); font-weight: bold;">SATURADO</div>
                    <div id="bal-src-name" style="font-weight: 800; font-size: 0.9rem;">Diego</div>
                    <div id="bal-src-count" style="font-size: 0.7rem; opacity: 0.8;">8 Tareas</div>
                </div>

                <div style="text-align: center;">
                    <span class="material-symbols-rounded" style="color: var(--color-text-muted);">arrow_forward</span>
                </div>

                <!-- Target -->
                <div
                    style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.3);">
                    <div style="font-size: 0.65rem; color: var(--color-success); font-weight: bold;">DISPONIBLE</div>
                    <div id="bal-tgt-name" style="font-weight: 800; font-size: 0.9rem;">Juan</div>
                    <div id="bal-tgt-count" style="font-size: 0.7rem; opacity: 0.8;">1 Tarea</div>
                </div>
            </div>

            <div style="font-size: 0.75rem; font-weight: bold; margin-bottom: 8px; color: var(--color-primary);">TAREAS
                SUGERIDAS PARA MOVER: (Compatibles con Especialidad)</div>
            <div id="balance-tasks-list"
                style="background: rgba(0,0,0,0.2); border-radius: 8px; max-height: 150px; overflow-y: auto; padding: 5px;">
                <!-- Injected via JS -->
            </div>

            <div style="margin-top: 1.5rem; display: flex; gap: 10px;">
                <button onclick="closeBalanceModal()" class="btn"
                    style="flex:1; border: 1px solid var(--color-border);">CANCELAR</button>
                <button onclick="executeBalance()" class="btn btn-primary"
                    style="flex:2; background: var(--color-warning); color: black; font-weight: 800;">CONFIRMAR
                    CAMBIOS</button>
            </div>
        </div>
    </div>

    <!-- MODAL NOTIFICACIÓN ENTRANTE (REUNIÓN / URGENCIA) -->
    <div id="modal-notificatoria" class="modal-overlay" style="background: rgba(15, 23, 42, 0.95);">
        <div class="modal" id="notif-modal-card"
            style="max-width: 400px; text-align: center; border: 4px solid var(--color-danger); animation: pulse-border 1s infinite;">
            <div id="notif-icon-container">
                <span class="material-symbols-rounded"
                    style="font-size: 80px; color: var(--color-danger);">notifications_active</span>
            </div>
            <h2 id="notif-titulo" style="margin-top: 1rem; color: white;">¡ALERTA URGENTE!</h2>
            <p id="notif-mensaje" style="font-size: 1.1rem; color: #cbd5e1; margin-bottom: 2rem;">Se requiere su
                presencia de inmediato en Recepción.</p>

            <button onclick="confirmarAsistencia()" class="btn btn-primary"
                style="width: 100%; padding: 1.5rem; font-size: 1.2rem; font-weight: 900;">ENTENDIDO, VOY EN
                CAMINO</button>
        </div>
    </div>

    <!-- MODAL IMPORTAR REQUERIMIENTOS -->
    <div id="modal-importar" class="modal-overlay">
        <div class="modal" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin:0;">Importar Requerimientos</h3>
                <span onclick="closeModalImportar()" class="material-symbols-rounded"
                    style="cursor:pointer; color: var(--color-text-muted);">close</span>
            </div>

            <div class="card" style="margin-bottom: 10px;">
                <label style="font-size: 0.7rem; font-weight: bold;">OPCIÓN A: PEGAR TEXTO (MAIL)</label>
                <textarea id="import-text" class="form-control" rows="4"
                    placeholder="Ej: Equipo: Chiller 01 | Descripción: Falla en presión de aceite"></textarea>
            </div>

            <div class="card" style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <div style="flex:1;">
                    <label style="font-size: 0.7rem; font-weight: bold;">OPCIÓN B: SUBIR EXCEL / CSV</label>
                    <input type="file" id="import-file" class="form-control" accept=".xlsx, .xls, .csv">
                </div>
            </div>

            <button onclick="procesarImportacion()" class="btn btn-primary"
                style="width: 100%; font-weight: 800;">ANALIZAR E IMPORTAR</button>

            <div id="import-preview" style="margin-top: 15px;">
                <!-- Resultados de parseo aqui -->
            </div>
        </div>
    </div>
    <div id="modal-perfil" class="modal-overlay">
        <div class="modal" style="max-width: 360px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin:0;">Mi Perfil de Gestión</h3>
                <span onclick="closeModalPerfil()" class="material-symbols-rounded"
                    style="cursor:pointer; color: var(--color-text-muted);">close</span>
            </div>

            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="position: relative; display: inline-block;">
                    <img id="perf-preview-img"
                        style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--color-primary); background: var(--color-surface);">
                    <label for="perf-foto-input"
                        style="position: absolute; bottom: 0; right: 0; background: var(--color-primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--color-surface);">
                        <span class="material-symbols-rounded" style="font-size: 18px;">photo_camera</span>
                    </label>
                    <input type="file" id="perf-foto-input" style="display: none;" accept="image/*">
                </div>
            </div>

            <div class="form-group">
                <label>Nombre del Supervisor</label>
                <input type="text" id="perf-nombre" class="form-control" placeholder="Tu nombre artístico o real">
            </div>

            <!-- PIN DE ACCESO SUPERVISOR -->\n <div class="form-group">
                <label style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Mi PIN de Acceso (4 dígitos)</span>
                    <button type="button" onclick="togglePinVisibility('perf-pin')"
                        style="background: none; border: none; color: var(--color-primary); cursor: pointer; padding: 0; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;"
                        title="Mostrar/Ocultar PIN">
                        <span class="material-symbols-rounded" id="perf-pin-eye"
                            style="font-size: 18px;">visibility</span>
                    </button>
                </label>
                <input type="password" id="perf-pin" class="form-control" placeholder="••••" maxlength="4"
                    pattern="[0-9]{4}"
                    style="font-size: 1.2rem; letter-spacing: 8px; text-align: center; font-weight: bold;">
                <div style="font-size: 0.65rem; color: var(--color-text-muted); margin-top: 4px;">PIN actual: 1234 (por
                    defecto)</div>
            </div>

            <!-- Notification Permission Container (Dynamic) -->
            <div id="perf-notif-container" style="margin-top: 15px;"></div>

            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

            <div
                style="background: rgba(59, 130, 246, 0.05); padding: 12px; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.1); margin: 15px 0;">
                <div
                    style="font-size: 0.6rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase; margin-bottom: 8px;">
                    Estadísticas de Liderazgo</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <div id="perf-ots-validadas" style="font-size: 1.2rem; font-weight: 800;">0</div>
                        <div style="font-size: 0.55rem; color: var(--color-text-muted);">OTS VALIDADAS</div>
                    </div>
                    <div>
                        <div id="perf-efectividad-equipo"
                            style="font-size: 1.2rem; font-weight: 800; color: var(--color-success);">100%</div>
                        <div style="font-size: 0.55rem; color: var(--color-text-muted);">EFECTIVIDAD EQUIPO</div>
                    </div>
                </div>
            </div>

            <button onclick="savePerfil()" class="btn btn-primary"
                style="width: 100%; margin-top: 10px; font-weight: 700;">GUARDAR PERFIL</button>

            <!-- CONFIGURACIÓN DE BRANDING -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                <h4
                    style="font-size: 0.7rem; color: var(--color-accent); margin-bottom: 10px; text-transform: uppercase;">
                    <span class="material-symbols-rounded"
                        style="font-size: 14px; vertical-align: middle;">domain</span>
                    Configuración PDF & Empresa
                </h4>
                <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.65rem;">Nombre Empresa</label>
                    <input type="text" id="conf-company-name" class="form-control"
                        style="font-size: 0.8rem; padding: 6px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label style="font-size: 0.65rem;">Dirección</label>
                        <input type="text" id="conf-company-address" class="form-control"
                            style="font-size: 0.8rem; padding: 6px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label style="font-size: 0.65rem;">Teléfono</label>
                        <input type="text" id="conf-company-phone" class="form-control"
                            style="font-size: 0.8rem; padding: 6px;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.65rem;">Firma: Nombre</label>
                    <input type="text" id="conf-signer-name" class="form-control"
                        style="font-size: 0.8rem; padding: 6px;">
                </div>
                <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-size: 0.65rem;">Firma: Cargo</label>
                    <input type="text" id="conf-signer-role" class="form-control"
                        style="font-size: 0.8rem; padding: 6px;">
                </div>
                <button onclick="saveBrandingConfig()" class="btn"
                    style="width: 100%; margin-top: 5px; background: rgba(6, 182, 212, 0.1); color: var(--color-accent); border: 1px solid rgba(6, 182, 212, 0.3);">
                    <span class="material-symbols-rounded">save</span> Guardar Config PDF
                </button>
            </div>

            <div
                style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--color-border); display: block;">
                <h4 style="font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 10px;">HERRAMIENTAS DE
                    DESARROLLO</h4>
                <button onclick="startShowroom()" class="btn"
                    style="width: 100%; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(168, 85, 247, 0.2)); border: 1px solid var(--color-primary); font-size: 0.7rem; color: var(--color-primary); font-weight: bold; margin-bottom: 10px;">
                    <span class="material-symbols-rounded">play_circle</span> 🎬 PRESENTACIÓN EJECUTIVA
                </button>
                <button onclick="generarDatosDemo()" class="btn"
                    style="width: 100%; border: 1px dashed var(--color-border); font-size: 0.7rem; color: var(--color-text-muted);">
                    <span class="material-symbols-rounded">science</span> GENERAR DATOS DE PRUEBA
                </button>
                <button onclick="simulateMajorIncident()" class="btn"
                    style="width: 100%; margin-top: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-danger); font-size: 0.7rem; color: var(--color-danger); font-weight: bold;">
                    <span class="material-symbols-rounded">warning</span> SIMULAR INCIDENTE MENOR
                </button>
                <button onclick="resetFactoryData()" class="btn"
                    style="width: 100%; margin-top: 10px; background: rgba(168, 85, 247, 0.1); border: 1px dashed rgba(168, 85, 247, 0.5); font-size: 0.7rem; color: #a855f7; font-weight: bold;">
                    <span class="material-symbols-rounded">restart_alt</span> RESET DE FÁBRICA
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse-border {
            0% {
                border-color: var(--color-danger);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            50% {
                border-color: #f87171;
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }

            100% {
                border-color: var(--color-danger);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>

    <!-- MODAL SELECCION EMULACION -->
    <div id="modal-emulate-tech" class="modal-overlay" style="z-index: 2000; display: none;">
        <div class="modal" style="width: 320px; padding: 24px;">
            <h3 style="margin-top:0;">Emular Vista Técnico</h3>
            <p style="color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Selecciona el técnico
                para ver sus tareas y estado:</p>
            <div id="emulate-tech-list"
                style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
                <!-- Generated dynamically -->
            </div>
            <button onclick="closeEmulateModal()" class="btn btn-secondary"
                style="margin-top: 16px; width: 100%;">Cancelar</button>
        </div>
    </div>

    <style>
        .emulate-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-text);
            text-align: left;
            width: 100%;
        }

        .emulate-btn:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }
    </style>

    <div id="app" style="display: none;">
        <div class="app-container" style="display: none;">
            <header>
                <img src="file:///C:/Users/theli/.gemini/antigravity/brain/4aae52ec-39dd-4953-b2ff-323148e3d7b7/uploaded_image_1766761971434.jpg"
                    class="branding-logo-header" alt="Logo">
                <h2 id="app-title" style="flex: 1; font-size: 1.1rem; margin: 0; letter-spacing: 1px;">XELONIA <span
                        style="font-weight: 300; font-size: 0.8rem; color: var(--color-accent);">uptime</span></h2>
                <!-- Login Status / Logout -->
                <!-- Login Status / Logout -->
                <div class="header-actions">
                    <div id="header-avatar-container" class="avatar-container" onclick="openModalPerfil()"
                        title="Mi Perfil"></div>
                    <div id="role-badge" class="role-badge" onclick="quickToggleRole()"
                        title="Click para cambiar de Rol" style="display: none;">
                        ADMIN
                    </div>
                    <button onclick="closeShift()" class="btn"
                        style="background: rgba(239, 68, 68, 0.15); color: var(--color-danger); border: 1px solid rgba(239, 68, 68, 0.3); padding: 6px 12px; font-size: 0.75rem; font-weight: 600;"
                        title="Cerrar Turno y Entregar Dispositivo">
                        <span class="material-symbols-rounded" style="font-size: 16px;">logout</span>
                        CERRAR TURNO
                    </button>
                </div>
                <button id="btn-global-sos" class="sos-btn-header" onclick="openSOSPanel()">
                    <span class="material-symbols-rounded">sos</span> SOS
                </button>
                <button id="btn-connectivity" class="sos-btn-header" onclick="toggleConnection()"
                    style="background: var(--color-success); border-color: var(--color-success); margin-left:10px;">
                    <span class="material-symbols-rounded">wifi</span>
                </button>
                <span id="offline-indicator"
                    style="display:none; color: var(--color-warning); font-size: 0.7rem; font-weight: bold; margin-left: 5px;">OFFLINE
                    (Cola: 0)</span>
            </header>

            <nav class="sidebar-nav">
                <button class="btn btn-sidebar" onclick="navigate('dashboard')" id="nav-dashboard">
                    <span class="material-symbols-rounded">dashboard</span> Dashboard
                </button>
                <button class="btn btn-sidebar" onclick="navigate('ots')" id="nav-ots">
                    <span class="material-symbols-rounded">assignment</span> Mis Tareas
                </button>
                <button class="btn btn-sidebar" onclick="navigate('bodega')" id="nav-bodega">
                    <span class="material-symbols-rounded">inventory_2</span> Bodega
                </button>
                <!-- Nueva navegación: Biblioteca Técnica -->
                <button class="btn btn-sidebar" onclick="navigate('biblioteca')" id="nav-biblioteca">
                    <span class="material-symbols-rounded">menu_book</span> Biblioteca
                </button>
                <button class="btn btn-sidebar" onclick="navigate('muro')" id="nav-muro">
                    <span class="material-symbols-rounded">forum</span> Muro Digital
                </button>
                <button class="btn btn-sidebar" onclick="navigate('reportes')" id="nav-reportes">
                    <span class="material-symbols-rounded">summarize</span> Reportes
                </button>
                <button class="btn btn-sidebar" onclick="navigate('personal')" id="nav-personal">
                    <span class="material-symbols-rounded">groups</span> Personal
                </button>
                <button class="btn btn-sidebar" onclick="navigate('compras')" id="nav-compras">
                    <span class="material-symbols-rounded">shopping_cart</span> Compras
                </button>
                <button class="btn btn-sidebar" onclick="navigate('contratistas')" id="nav-contratistas">
                    <span class="material-symbols-rounded">engineering</span> Contratistas
                </button>

                <!-- Version/Status -->
                <div
                    style="margin-top: auto; padding: 1rem; font-size: 0.7rem; color: var(--color-text-muted); text-align: center; opacity: 0.7;">
                    ACTUALIZACIÓN
                </div>
            </nav>

            <main id="main-content"></main>

            <nav class="mobile-nav">
                <div class="mobile-nav-item" onclick="navigate('dashboard')" id="nav-dashboard-mobile">
                    <span class="material-symbols-rounded">dashboard</span>
                    <span>Inicio</span>
                </div>
                <div class="mobile-nav-item" onclick="navigate('muro')" id="nav-muro-mobile">
                    <span class="material-symbols-rounded">analytics</span>
                    <span>Muro</span>
                </div>
                <div class="mobile-nav-item" onclick="navigate('activos')" id="nav-activos-mobile">
                    <span class="material-symbols-rounded">inventory_2</span>
                    <span>Activos</span>
                </div>
                <div class="mobile-nav-item" onclick="navigate('ots')" id="nav-ots-mobile">
                    <span class="material-symbols-rounded">assignment</span>
                    <span>Tareas</span>
                </div>
                <div class="mobile-nav-item" onclick="navigate('compras')" id="nav-compras-mobile">
                    <span class="material-symbols-rounded">shopping_bag</span>
                    <span>Compras</span>
                </div>
                <div class="mobile-nav-item" onclick="navigate('bodega')" id="nav-bodega-mobile">
                    <span class="material-symbols-rounded">warehouse</span>
                    <span>Bodega</span>
                </div>
                <div class="mobile-nav-item" onclick="navigate('gantt')" id="nav-gantt-mobile">
                    <span class="material-symbols-rounded">calendar_month</span>
                    <span>Gantt</span>
                </div>
                <div class="mobile-nav-item" onclick="navigate('contratistas')" id="nav-contratistas-mobile">
                    <span class="material-symbols-rounded">engineering</span>
                    <span>3ros</span>
                </div>
            </nav>
        </div>
    </div>

    <!-- MODAL SOS TÁCTICO -->
    <div id="modal-sos" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; border: 2px solid var(--color-danger);">
            <div class="modal-header" style="background: rgba(239, 68, 68, 0.1);">
                <h3 style="color: var(--color-danger); display: flex; align-items: center; gap: 10px;">
                    <span class="material-symbols-rounded">e911_emergency</span> PANEL TÁCTICO DE EMERGENCIA
                </h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="toggleSOSConfig()" class="btn"
                        style="color: var(--color-text-muted); padding: 4px;">
                        <span class="material-symbols-rounded">settings</span>
                    </button>
                    <button onclick="closeSOSPanel()" class="btn-close">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>

            <!-- VISTA TÁCTICA -->
            <div id="sos-view-tactical" class="modal-body">
                <div
                    style="margin-bottom: 15px; text-align: center; color: var(--color-text-muted); font-size: 0.8rem;">
                    SELECCIONA TIPO Y LUGAR PARA ACTIVAR ALERTA
                </div>

                <div class="tactical-grid">
                    <div id="sos-types-container" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- JS Injected -->
                    </div>
                    <div id="sos-locs-container" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- JS Injected -->
                    </div>
                </div>

                <div id="sos-preview"
                    style="margin-top: 20px; padding: 15px; background: rgba(239,68,68, 0.2); border-radius: 8px; text-align: center; display: none;">
                    <div style="font-size: 0.8rem; color: #fca5a5;">CONFIRMAR ALERTA DE:</div>
                    <h2 id="sos-msg-preview" style="margin: 5px 0; color: white;">INCENDIO EN COCINA</h2>
                    <button onclick="confirmSOS()" class="btn"
                        style="width: 100%; background: var(--color-danger); color: white; font-weight: 900; font-size: 1.2rem; padding: 15px; margin-top: 10px; animation: pulse-red 1s infinite;">
                        ¡ACTIVAR AHORA!
                    </button>
                </div>
            </div>

            <!-- VISTA CONFIGURACIÓN -->
            <div id="sos-view-config" class="modal-body" style="display: none;">
                <h4>Configuración de Protocolos</h4>
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <h5 style="color: var(--color-accent);">Tipos de Emergencia</h5>
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <input type="text" id="new-sos-type" class="form-control" placeholder="Nuevo Tipo...">
                            <button onclick="addSOSItem('types')" class="btn btn-primary">+</button>
                        </div>
                        <div id="config-types-list" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    <div>
                        <h5 style="color: var(--color-success);">Lugares / Zonas</h5>
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <input type="text" id="new-sos-loc" class="form-control" placeholder="Nueva Zona...">
                            <button onclick="addSOSItem('locs')" class="btn btn-primary">+</button>
                        </div>
                        <div id="config-locs-list" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                <button onclick="toggleSOSConfig()" class="btn"
                    style="width: 100%; margin-top: 20px; background: var(--color-surface-hover);">VOLVER AL PANEL
                    TÁCTICO</button>
            </div>
        </div>
    </div>

    <!-- MODAL RECHAZO OT -->
    <div id="modal-rechazo-ot" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><span class="material-symbols-rounded">cancel</span> Rechazar Trabajo</h3>
                <button onclick="closeModalRechazo()" class="btn-close">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rechazo-ot-id">
                <div class="form-group">
                    <label>Motivo del Rechazo / Comentarios para el Técnico</label>
                    <textarea id="rechazo-comentario" class="form-control" rows="4"
                        placeholder="Explique por qué se rechaza el trabajo y qué debe corregirse..."></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="confirmarRechazo()" class="btn btn-primary"
                        style="flex: 1; background: var(--color-danger);">CONFIRMAR RECHAZO</button>
                    <button onclick="closeModalRechazo()" class="btn"
                        style="flex: 1; background: var(--color-surface-hover);">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL RECEPCIÓN OC -->
    <div id="modal-recepcion-oc" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><span class="material-symbols-rounded">inventory</span> Confirmar Ingreso a Bodega</h3>
                <button onclick="closeModalRecepcion()" class="btn-close">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="recepcion-detalles"
                    style="margin-bottom: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                    <!-- JS Injected -->
                </div>
                <div class="form-group">
                    <label>Observaciones de Recepción</label>
                    <textarea id="recepcion-notas" class="form-control" rows="2"
                        placeholder="Ej: Material verificado, empaque original..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div class="form-group">
                        <label>Estado del Empaque</label>
                        <select id="recepcion-estado-empaque" class="form-control">
                            <option value="perfecto">📦 Perfecto</option>
                            <option value="danio_menor">⚠️ Daño Menor</option>
                            <option value="critico">🚫 Daño Crítico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ID Operador</label>
                        <input type="text" id="recepcion-operador-id" class="form-control" placeholder="Ej: OP-101">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 10px;">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Firma Digital de Recepción</span>
                        <button onclick="clearSignature()"
                            style="background: none; border: none; color: var(--color-danger); font-size: 0.7rem; cursor: pointer; text-decoration: underline;">Borrar
                            Firma</button>
                    </label>
                    <div
                        style="background: white; border-radius: 4px; overflow: hidden; height: 120px; position: relative;">
                        <!-- Canvas for signature -->
                        <canvas id="signature-pad" width="460" height="120"
                            style="cursor: crosshair; touch-action: none; display: block;"></canvas>
                        <div id="sig-placeholder"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ccc; pointer-events: none; font-size: 0.8rem;">
                            Firmar aquí</div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button id="btn-confirmar-ingreso" class="btn btn-primary" style="flex: 1;">CONFIRMAR Y CERRAR
                        OC</button>
                    <button onclick="closeModalRecepcion()" class="btn"
                        style="flex: 1; background: var(--color-surface-hover);">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL GENÉRICO (Para Biblioteca y otros usos) -->
    <div id="modal-generic"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div
            style="background: var(--color-surface); border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div id="modal-generic-content">
                <!-- Contenido inyectado dinámicamente -->
            </div>
        </div>
    </div>

    <!-- MODAL CHECKLIST DE SEGURIDAD (OBLIGATORIO) -->
    <div id="modal-safety-check" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; border: 2px solid var(--color-warning);">
            <div class="modal-header"
                style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1));">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <span class="material-symbols-rounded" style="color: var(--color-warning);">verified_user</span>
                    Declaración de Seguridad
                </h3>
            </div>
            <div class="modal-body">
                <input type="hidden" id="safety-ot-id">

                <div
                    style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                    <div
                        style="display: flex; align-items: center; gap: 8px; color: var(--color-danger); font-weight: 700; font-size: 0.8rem; margin-bottom: 6px;">
                        <span class="material-symbols-rounded" style="font-size: 18px;">warning</span>
                        IMPORTANTE: Responsabilidad Legal
                    </div>
                    <p style="margin: 0; font-size: 0.7rem; line-height: 1.4; color: #fca5a5;">
                        Antes de iniciar el trabajo, debes confirmar que cuentas con los Elementos de Protección
                        Personal (EPP) requeridos.
                        Esta declaración quedará registrada con fecha y hora para auditorías de seguridad.
                    </p>
                </div>

                <div class="form-group">
                    <label style="font-weight: 700; margin-bottom: 12px; display: block;">Confirma que cuentas
                        con:</label>

                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label
                            style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="safety-helmet" class="safety-item"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="flex: 1; font-size: 0.85rem;">🪖 Casco de Seguridad</span>
                        </label>

                        <label
                            style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="safety-gloves" class="safety-item"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="flex: 1; font-size: 0.85rem;">🧤 Guantes de Protección</span>
                        </label>

                        <label
                            style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="safety-glasses" class="safety-item"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="flex: 1; font-size: 0.85rem;">🥽 Lentes de Seguridad</span>
                        </label>

                        <label
                            style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 6px; cursor: pointer;">
                            <input type="checkbox" id="safety-lockout" class="safety-item"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="flex: 1; font-size: 0.85rem;">🔐 Bloqueo LOTO (si aplica)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label
                        style="display: flex; align-items: start; gap: 10px; padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" id="safety-declaration"
                            style="width: 18px; height: 18px; margin-top: 2px; cursor: pointer;">
                        <span style="flex: 1; font-size: 0.75rem; line-height: 1.4;">
                            <strong style="color: var(--color-primary);">Declaro bajo juramento</strong> que he evaluado
                            los riesgos del área de trabajo,
                            cuento con los implementos de seguridad marcados y entiendo que omitir estas medidas
                            constituye una falta grave.
                        </span>
                    </label>
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="confirmSafetyAndStart()" class="btn btn-primary"
                        style="flex: 1; background: var(--color-success);">
                        <span class="material-symbols-rounded" style="font-size: 18px;">check_circle</span>
                        CONFIRMAR E INICIAR
                    </button>
                    <button onclick="closeSafetyModal()" class="btn"
                        style="flex: 0.5; background: var(--color-surface-hover);">
                        CANCELAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA INSTALL BUTTON (For non-technical users) -->
    <div id="pwa-install-banner"
        style="display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 10002; max-width: 90%; width: 350px;">
        <div
            style="background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; padding: 20px; box-shadow: 0 10px 40px rgba(16, 185, 129, 0.5); border: 2px solid rgba(255,255,255,0.2); animation: bounce-in 0.5s ease;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
                <span class="material-symbols-rounded" style="font-size: 40px; color: white;">download</span>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1rem; color: white; margin-bottom: 4px;">
                        📱 Instalar XELONIA
                    </div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9); line-height: 1.3;">
                        Agregar a tu pantalla de inicio para acceso rápido
                    </div>
                </div>
                <button onclick="closePWABanner()"
                    style="background: rgba(0,0,0,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <span class="material-symbols-rounded" style="font-size: 18px;">close</span>
                </button>
            </div>
            <button onclick="installPWA()" class="btn"
                style="width: 100%; background: white; color: #059669; font-weight: 700; padding: 12px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; border: none; cursor: pointer; font-size: 0.9rem;">
                <span class="material-symbols-rounded" style="font-size: 20px;">add_to_home_screen</span>
                INSTALAR AHORA
            </button>
        </div>
    </div>

    <style>
        @keyframes bounce-in {
            0% {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }

            60% {
                transform: translateX(-50%) translateY(-10px);
                opacity: 1;
            }

            100% {
                transform: translateX(-50%) translateY(0);
            }
        }
    </style>

    <!-- SHOWROOM PRESENTATION OVERLAY -->
    <div id="showroom-overlay"
        style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95)); backdrop-filter: blur(10px); border-radius: 16px; padding: 15px 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(59, 130, 246, 0.3);">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="material-symbols-rounded"
                    style="color: var(--color-primary); font-size: 24px; animation: pulse 2s infinite;">play_circle</span>
                <div>
                    <div id="showroom-scene-name"
                        style="font-size: 0.75rem; font-weight: 700; color: var(--color-primary); text-transform: uppercase;">
                        Iniciando...</div>
                    <div id="showroom-progress"
                        style="font-size: 0.65rem; color: var(--color-text-muted); margin-top: 2px;">Escena 1 de 4</div>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button id="showroom-pause-btn" onclick="toggleShowroomPause()" class="btn"
                    style="padding: 8px 12px; background: rgba(245, 158, 11, 0.2); border: 1px solid var(--color-warning); color: var(--color-warning); font-size: 0.65rem;">
                    <span class="material-symbols-rounded" style="font-size: 16px;">pause</span>
                </button>
                <button onclick="skipShowroomScene()" class="btn"
                    style="padding: 8px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid var(--color-primary); color: var(--color-primary); font-size: 0.65rem;">
                    <span class="material-symbols-rounded" style="font-size: 16px;">skip_next</span>
                </button>
                <button onclick="stopShowroom()" class="btn"
                    style="padding: 8px 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid var(--color-danger); color: var(--color-danger); font-size: 0.65rem;">
                    <span class="material-symbols-rounded" style="font-size: 16px;">close</span>
                </button>
            </div>
        </div>
    </div>

    <!-- SPOTLIGHT HIGHLIGHT SYSTEM -->
    <div id="showroom-overlay-dark"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 9998; pointer-events: none; transition: opacity 0.5s ease;">
    </div>

    <div id="showroom-spotlight"
        style="display: none; position: fixed; pointer-events: none; z-index: 9999; border: 4px solid var(--color-primary); border-radius: 12px; background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 40px rgba(59, 130, 246, 0.8), inset 0 0 20px rgba(59, 130, 246, 0.3); transition: all 0.5s ease; animation: pulse-glow 2s infinite;">
    </div>

    <div id="showroom-label"
        style="display: none; position: fixed; z-index: 10000; background: linear-gradient(135deg, var(--color-primary), #a855f7); color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.5); pointer-events: none; transition: all 0.5s ease;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <span class="material-symbols-rounded" style="font-size: 20px;">visibility</span>
            <span id="showroom-label-text">Observa aquí</span>
        </div>
    </div>

    <style>
        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 40px rgba(59, 130, 246, 0.8), inset 0 0 20px rgba(59, 130, 246, 0.3);
            }

            50% {
                box-shadow: 0 0 60px rgba(59, 130, 246, 1), inset 0 0 30px rgba(59, 130, 246, 0.5);
            }
        }

        /* PIN Keypad Feedback Animation */
        .pin-key {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pin-key-active {
            background: rgba(59, 130, 246, 0.3) !important;
            transform: scale(0.95);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6), inset 0 0 10px rgba(59, 130, 246, 0.4);
        }

        .pin-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pin-dot.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
            transform: scale(1.1);
        }
    </style>

    <!-- AI CHAT ASSISTANT -->
    <div id="ai-chat-button" onclick="toggleAIChat()"
        style="display: none; position: fixed; bottom: 30px; right: 30px; z-index: 10001; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--color-primary), #a855f7); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5); align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
        <span class="material-symbols-rounded" style="color: white; font-size: 28px;">smart_toy</span>
    </div>

    <!-- REFRESH BUTTON -->
    <div id="refresh-button" onclick="location.reload()"
        style="display: none; position: fixed; bottom: 30px; left: 30px; z-index: 10001; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5); align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;"
        title="Actualizar aplicación">
        <span class="material-symbols-rounded" style="color: white; font-size: 28px;">refresh</span>
    </div>

    <div id="ai-chat-panel"
        style="display: none; position: fixed; bottom: 100px; right: 30px; z-index: 10001; width: 380px; max-height: 500px; background: var(--color-surface); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(59, 130, 246, 0.3); overflow: hidden;">
        <div
            style="background: linear-gradient(135deg, var(--color-primary), #a855f7); padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="material-symbols-rounded" style="color: white; font-size: 24px;">smart_toy</span>
                <div>
                    <div style="font-size: 0.9rem; font-weight: 700; color: white;">Asistente XELONIA</div>
                    <div style="font-size: 0.65rem; color: rgba(255,255,255,0.8);">Consultor Inteligente
                    </div>
                </div>
            </div>
            <button onclick="toggleAIChat()" style="background: none; border: none; cursor: pointer;">
                <span class="material-symbols-rounded" style="color: white; font-size: 20px;">close</span>
            </button>
        </div>

        <div id="ai-chat-messages" style="height: 320px; overflow-y: auto; padding: 15px; background: var(--color-bg);">
            <div class="ai-message"
                style="background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--color-primary);">
                <div style="font-size: 0.75rem; color: var(--color-primary); font-weight: 700; margin-bottom: 5px;">
                    XELONIA Assistant</div>
                <div style="font-size: 0.8rem; line-height: 1.4;">¡Hola! Soy tu asistente inteligente. Puedo
                    ayudarte con consultas sobre equipos, stock, costos y ubicaciones. ¿En qué puedo
                    ayudarte?</div>
            </div>
        </div>

        <div style="padding: 15px; background: var(--color-surface); border-top: 1px solid var(--color-border);">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="ai-chat-input" placeholder="Escribe tu consulta..." class="form-control"
                    style="flex: 1; font-size: 0.8rem; padding: 10px;"
                    onkeypress="if(event.key==='Enter') sendAIMessage()">
                <button onclick="sendAIMessage()" class="btn btn-primary" style="padding: 10px 15px;">
                    <span class="material-symbols-rounded" style="font-size: 18px;">send</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & PERSISTENCE ---
        let currentRole = 'admin'; // 'admin' o 'tecnico'
        let currentUser = null; // Guardará el objeto del técnico logueado
        let assetFilters = { search: '', criticidad: '', servicio: '' };
        let currentAssetView = 'list'; // 'list' | 'map'
        let activeMuroEspecialidad = null; // Para el drill-down en el Muro de Control

        // --- OFFLINE MODE STATE ---
        let isOffline = false;
        let syncQueue = JSON.parse(localStorage.getItem('cmms_sync_queue')) || [];

        // --- SAFETY COMPLIANCE LOGS ---
        let safetyLogs = JSON.parse(localStorage.getItem('cmms_safety_logs')) || [];

        function toggleConnection() {
            isOffline = !isOffline;
            const btn = document.getElementById('btn-connectivity');
            const ind = document.getElementById('offline-indicator');

            if (isOffline) {
                // Go Offline
                btn.style.background = 'var(--color-text-muted)';
                btn.style.borderColor = 'var(--color-text-muted)';
                btn.innerHTML = '<span class="material-symbols-rounded">wifi_off</span>';
                ind.style.display = 'inline-block';
                updateSyncQueueUI();
                alert("⚠️ Modo OFFLINE activado.\n\nLos cambios se guardarán localmente y se sincronizarán cuando recuperes la conexión.");
            } else {
                // Go Online
                btn.style.background = 'var(--color-success)';
                btn.style.borderColor = 'var(--color-success)';
                btn.innerHTML = '<span class="material-symbols-rounded">wifi</span>';
                ind.style.display = 'none';

                if (syncQueue.length > 0) {
                    processSyncQueue();
                } else {
                    alert("✅ Conexión restablecida. Todo sincronizado.");
                }
            }
        }

        function updateSyncQueueUI() {
            const ind = document.getElementById('offline-indicator');
            if (ind) ind.innerText = `OFFLINE (Cola: ${syncQueue.length})`;
        }

        function processSyncQueue() {
            alert(`🔄 Sincronizando ${syncQueue.length} acciones pendientes...`);

            // Replay actions
            syncQueue.forEach(action => {
                if (action.type === 'OT_CLOSE') {
                    const ot = ots.find(o => o.id === action.payload.id);
                    if (ot) {
                        ot.estado = 'completada'; // Final commit
                        // In a real app we would POST to server here
                    }
                }
            });

            syncQueue = [];
            localStorage.setItem('cmms_sync_queue', JSON.stringify(syncQueue));
            persist();
            updateSyncQueueUI();
            alert("✅ Sincronización Completada con éxito.");
            renderCurrentView(); // Refresh changes
        }

        const defaultEquipos = [
            {
                id: 1, nombre: "Compresor Sala Frío", area: "Cocina", estado: "activo", dispo: 99, marca: "Daikin", modelo: "VRV IV", horas: 1240, freq: 250,
                servicio: "planta", criticidad: "AA",
                x: 25, y: 70, // Coordenadas para el mapa (%)
                notas: "Ubicado detrás de la cava de vinos.", fechaInicio: "2026-01-01",
                capacidad: "48,000 BTU", refrigerante: "R-410A", tension: "Trifásica 380V", compresor: "Scroll Inv.",
                valorMercado: 8500000, valorAdquisicion: 12000000, costoMantAcumulado: 450000,
                especialidad: "Clima",
                kitRepuestos: [
                    { nombre: "Filtro G4", precio: 15000 },
                    { nombre: "Gas R-410A (kg)", precio: 45000 }
                ],
                historial: [
                    { fecha: "2025-12-12", tarea: "Mant. Preventivo", tecnico: "Juan Pérez", especialidad: "Clima", efectividad: 98, origen: "planta", desc: "Ajuste de correas y lubricación.", costo: 25000, tipo: "programado" }
                ]
            },
            {
                id: 2, nombre: "Chiller Central", area: "Azotea", estado: "alerta", dispo: 62, marca: "York", modelo: "YK-Series", horas: 5600, freq: 500,
                servicio: "externo", criticidad: "AAA",
                x: 50, y: 15,
                notas: "Requiere revisión de presión de refrigerante.", fechaInicio: "2026-01-01",
                capacidad: "250 TR", refrigerante: "R-134a", tension: "Trifásica 380V", compresor: "Tornillo",
                valorMercado: 45000000, valorAdquisicion: 65000000, costoMantAcumulado: 12500000,
                especialidad: "Clima",
                kitRepuestos: [
                    { nombre: "Válvula Expansión", precio: 850000 },
                    { nombre: "Aceite Sintético", precio: 120000 }
                ],
                historial: [
                    { fecha: "2025-11-20", tarea: "Reparación Fuga", tecnico: "ClimaCorp S.A.", especialidad: "Clima", efectividad: 85, origen: "externo", desc: "Cambio de válvula de expansión.", costo: 950000, tipo: "no_programado" }
                ]
            },
            {
                id: 3, nombre: "Generador Diesel", area: "Subterráneo", estado: "activo", dispo: 100, marca: "Caterpillar", modelo: "C15", horas: 45, freq: 100,
                servicio: "planta", criticidad: "AAA",
                x: 75, y: 85,
                notas: "Prueba semanal los lunes 09:00 AM.", fechaInicio: "2026-01-01",
                capacidad: "500 kVA", refrigerante: "Diesel / Glicol", tension: "Trifásica 380V", compresor: "Combustión",
                valorMercado: 120000000, valorAdquisicion: 150000000, costoMantAcumulado: 2100000,
                especialidad: "Mecánica",
                kitRepuestos: [
                    { nombre: "Filtro Petróleo", precio: 85000 },
                    { nombre: "Aceite 15W40", precio: 140000 }
                ],
                historial: [
                    { fecha: "2025-12-01", tarea: "Cambio Aceite", tecnico: "Carlos Ruiz", especialidad: "Mecánica", efectividad: 100, origen: "planta", desc: "Filtros y aceite nuevos.", costo: 225000, tipo: "programado" }
                ]
            },
            {
                id: 4, nombre: "Caldera de Vapor", area: "Sala Térmica", estado: "activo", dispo: 98, marca: "Bosch", modelo: "Universal", horas: 4100, freq: 4000,
                servicio: "externo", criticidad: "AAA",
                x: 80, y: 20,
                notas: "Crítica para agua caliente sanitaria.", fechaInicio: "2026-01-01",
                capacidad: "2000 kg/h", refrigerante: "Gas Natural", tension: "380V", compresor: "Quemador",
                valorMercado: 35000000, valorAdquisicion: 40000000, costoMantAcumulado: 800000,
                especialidad: "Termodinámica",
                kitRepuestos: [
                    { nombre: "Juntas de Quemador", precio: 45000 },
                    { nombre: "Electrodo", precio: 25000 }
                ],
                historial: []
            },
            {
                id: 5, nombre: "Ascensor de Servicio", area: "Lobby", estado: "activo", dispo: 95, marca: "Schindler", modelo: "3300", horas: 1200, freq: 3000,
                servicio: "externo", criticidad: "AAA",
                x: 40, y: 40,
                notas: "Uso intensivo carga/descarga.", fechaInicio: "2026-01-01",
                capacidad: "1000 kg", refrigerante: "N/A", tension: "380V", compresor: "Motor Tracción",
                valorMercado: 60000000, valorAdquisicion: 75000000, costoMantAcumulado: 1500000,
                especialidad: "Mecánica",
                kitRepuestos: [],
                historial: []
            },
            {
                id: 6, nombre: "Bomba Hidroneumática", area: "Sala Bombas", estado: "activo", dispo: 100, marca: "Pedrollo", modelo: "F", horas: 500, freq: 1000,
                servicio: "planta", criticidad: "AA",
                x: 60, y: 70,
                notas: "Presión constante agua potable.", fechaInicio: "2026-01-01",
                capacidad: "500 L/min", refrigerante: "N/A", tension: "380V", compresor: "Centrífuga",
                valorMercado: 1200000, valorAdquisicion: 1500000, costoMantAcumulado: 50000,
                especialidad: "Hidráulica",
                kitRepuestos: [
                    { nombre: "Sello Mecánico", precio: 35000 }
                ],
                historial: []
            }
        ];

        const kitLibrary = {
            "clima_basico": {
                nombre: "Kit Clima Básico",
                bodega: ["Filtros G4 (2)", "Termómetro láser", "Trapos de limpieza"],
                seguridad: ["Guantes nitrilo", "Lentes de seguridad"],
                precioEstimado: 35000
            },
            "electrico_basico": {
                nombre: "Kit Eléctrico Básico",
                bodega: ["Multímetro", "Pinza amperimétrica", "Cinta aislante"],
                seguridad: ["Guantes dieléctricos", "Bloqueo LOTO"],
                precioEstimado: 15000
            },
            "aseo_taller": {
                nombre: "Kit Aseo Taller",
                bodega: ["Desengrasante", "Escobillón", "Etiquetas"],
                seguridad: ["Guantes de goma", "Mascarilla"],
                precioEstimado: 5000
            }
        };

        const defaultPreventivos = [
            { id: 1001, titulo: "Limpieza de Filtros Fancoils", equipoId: 1, area: "Habitaciones 4to Piso", prioridad: "BAJA", descripcion: "Limpieza rutinaria para mantener flujo de aire.", estado: "disponible", kitId: "clima_basico" },
            { id: 1002, titulo: "Inspección Visual Tableros", equipoId: 2, area: "Piso 1", prioridad: "BAJA", descripcion: "Verificar ruidos extraños o sobrecalentamiento visible.", estado: "disponible", kitId: "electrico_basico" },
            { id: 1003, titulo: "Orden y Aseo Taller", equipoId: 3, area: "Mantenimiento", prioridad: "BAJA", descripcion: "Mantener herramientas etiquetadas y área despejada.", estado: "disponible", kitId: "aseo_taller" }
        ];

        let preventivosBacklog = JSON.parse(localStorage.getItem('cmms_preventivos_backlog')) || defaultPreventivos;

        const defaultTecnicos = [
            { id: 1, nombre: "Juan Pérez", userCode: "JP001", password: "123", especialidad: "Clima", foto: "https://i.ibb.co/68v8z8L/tech1.jpg", salario: 850000, costoHora: 4722, isTitular: true, origen: "planta", empresa: "Hotel 5*", eficacia: 100, turno: { inicio: "08:00", fin: "18:00", colacion: 60 } },
            { id: 2, nombre: "Ana Torres", userCode: "AT002", password: "123", especialidad: "Electricidad", foto: "https://i.ibb.co/rkL8z8L/tech2.jpg", salario: 920000, costoHora: 5111, isTitular: false, origen: "planta", empresa: "Hotel 5*", eficacia: 100, turno: { inicio: "08:00", fin: "18:00", colacion: 60 } },
            { id: 3, nombre: "Roberto Diaz", userCode: "RD003", password: "123", especialidad: "Mecánica", foto: "https://i.ibb.co/YyL8z8L/tech3.jpg", salario: 880000, costoHora: 4888, isTitular: false, origen: "planta", empresa: "Hotel 5*", eficacia: 100, turno: { inicio: "08:00", fin: "18:00", colacion: 60 } },
            { id: 4, nombre: "Luis Soto", userCode: "LS004", password: "123", especialidad: "Hidráulica", foto: "https://i.ibb.co/q8v8z8L/tech4.jpg", salario: 780000, costoHora: 4333, isTitular: false, origen: "planta", empresa: "Hotel 5*", eficacia: 100, turno: { inicio: "08:00", fin: "18:00", colacion: 60 } },
            { id: 5, nombre: "Marta Gómez", userCode: "MG005", password: "123", especialidad: "General", foto: "https://i.ibb.co/C8v8z8L/tech5.jpg", salario: 750000, costoHora: 4166, isTitular: false, origen: "planta", empresa: "Hotel 5*", eficacia: 100, turno: { inicio: "08:00", fin: "18:00", colacion: 60 } },
            { id: 6, nombre: "Felipe Ruiz", userCode: "FR006", password: "123", especialidad: "Electrónica", foto: "https://i.ibb.co/9vL8z8L/tech6.jpg", salario: 950000, costoHora: 5277, isTitular: false, origen: "planta", empresa: "Hotel 5*", eficacia: 100, turno: { inicio: "08:00", fin: "18:00", colacion: 60 } },
            { id: 7, nombre: "Diego Silva", userCode: "DS007", password: "123", especialidad: "Infraestructura", foto: "https://i.ibb.co/7vL8z8L/tech7.jpg", salario: 750000, costoHora: 4166, isTitular: false, origen: "planta", empresa: "Hotel 5*", eficacia: 100, turno: { inicio: "08:00", fin: "18:00", colacion: 60 } }
        ];

        let equipos = JSON.parse(localStorage.getItem('cmms_equipos')) || defaultEquipos;
        let tecnicos = JSON.parse(localStorage.getItem('cmms_tecnicos')) || defaultTecnicos;

        // --- ASEGURAR TÉCNICO SOLICITADO ---
        // (Removing old Technician check as we have a full team now)

        let laborLogs = JSON.parse(localStorage.getItem('cmms_labor')) || []; // [{idOT, idTec, action, timestamp, comment}]
        let managementLogs = JSON.parse(localStorage.getItem('cmms_management')) || []; // [{id, action, detail, icon, timestamp}]
        let toolLogs = JSON.parse(localStorage.getItem('cmms_tools')) || []; // [{tecnico, herramienta, estado, fecha}]
        let ots = JSON.parse(localStorage.getItem('cmms_ots')) || [
            { id: 101, titulo: "Emergencia: Falla Chiller Rooftop", asignadoId: 1, prioridad: "ALTA", estado: "levantamiento", descripcion: "Carga inicial: El equipo no parte.", levantamiento: "", tipo: "no_programado" }
        ];

        const defaultRepuestos = [
            { id: 1, nombre: "Compresor Scroll 5HP", stock: 2, stockMinimo: 1, precio: 450000, unidad: "UN", critico: 1, zona: "Motores", pasillo: "A", estante: "01", nivel: "1" },
            { id: 2, nombre: "Filtro Aire G4", stock: 24, stockMinimo: 10, precio: 12500, unidad: "UN", critico: 10, zona: "Clima", pasillo: "B", estante: "03", nivel: "2" },
            { id: 3, nombre: "Correa Transmisión A-42", stock: 8, stockMinimo: 4, precio: 8500, unidad: "UN", critico: 4, zona: "Motores", pasillo: "A", estante: "02", nivel: "1" },
            { id: 4, nombre: "Capacitor 45uF", stock: 15, stockMinimo: 5, precio: 6000, unidad: "UN", critico: 5, zona: "Eléctrico", pasillo: "C", estante: "01", nivel: "3" },
            { id: 5, nombre: "Gas R-410A (Balón 11kg)", stock: 5, stockMinimo: 2, precio: 185000, unidad: "UN", critico: 2, zona: "Químicos", pasillo: "D", estante: "01", nivel: "1" }
        ];
        let repuestos = JSON.parse(localStorage.getItem('cmms_repuestos')) || defaultRepuestos;

        const defaultHerramientas = [
            { id: 1, nombre: "Multímetro Digital Cat III", cat: "Medición" },
            { id: 2, nombre: "Juego de Llaves Punta Corona", cat: "Mecánica" },
            { id: 3, nombre: "Atornilladores Aislados 1000V", cat: "Electricidad" },
            { id: 4, nombre: "Manómetro de Refrigeración", cat: "Clima" },
            { id: 5, nombre: "Linterna de Cabeza LED", cat: "Iluminación" }
        ];
        const defaultEPP = [
            { id: 1, nombre: "Casco de Seguridad", cat: "Protección" },
            { id: 2, nombre: "Guantes de Nitrilo/Cuero", cat: "Protección" },
            { id: 3, nombre: "Zapatos Dieléctricos", cat: "Protección" },
            { id: 4, nombre: "Lentes de Seguridad", cat: "Protección" }
        ];
        let toolSuggestions = JSON.parse(localStorage.getItem('cmms_tool_suggestions')) || []; // [{tecnico, sugerencia, fecha}]
        let ordenesCompra = JSON.parse(localStorage.getItem('cmms_ordenes_compra')) || []; // [{id, item, cat, cant, costo, estado, fecha, refId}]

        const defaultManuales = [
            { id: 1, titulo: "Manual de Seguridad General", categoria: "Seguridad", tipo: "PDF", url: "#", descripcion: "Protocolo de seguridad para todas las operaciones de mantenimiento" },
            { id: 2, titulo: "Guía de Sistemas HVAC", categoria: "Clima", tipo: "PDF", url: "#", descripcion: "Manual técnico de sistemas de climatización" },
            { id: 3, titulo: "Diagrama Eléctrico Principal", categoria: "Eléctrico", tipo: "PDF", url: "#", descripcion: "Esquema completo del tablero eléctrico principal" },
            { id: 4, titulo: "Manual de Calderas", categoria: "Mecánico", tipo: "PDF", url: "#", descripcion: "Instrucciones de operación y mantenimiento de calderas" },
            { id: 5, titulo: "Protocolo de Emergencia", categoria: "Seguridad", tipo: "PDF", url: "#", descripcion: "Procedimientos ante situaciones de emergencia" },
            { id: 6, titulo: "Manual de Bombas Centrífugas", categoria: "Hidráulico", tipo: "PDF", url: "#", descripcion: "Guía técnica de bombas de agua y sistemas hidráulicos" },
            { id: 7, titulo: "Guía de Ascensores", categoria: "Infraestructura", tipo: "PDF", url: "#", descripcion: "Manual de mantenimiento y seguridad de ascensores" },
            { id: 8, titulo: "Fichas Técnicas Repuestos", categoria: "General", tipo: "XLSX", url: "#", descripcion: "Catálogo de repuestos con especificaciones" }
        ];
        let biblioteca = JSON.parse(localStorage.getItem('cmms_biblioteca')) || defaultManuales;

        // --- MIGRACIÓN Y POBLADO DE DATOS (v4.0 Managerial) ---
        const V4_DATA_KEY = 'cmms_v4_managerial_v1';
        if (!localStorage.getItem(V4_DATA_KEY)) {
            equipos = defaultEquipos;
            tecnicos = defaultTecnicos;
            ots = [
                { id: 101, titulo: "Emergencia: Falla Chiller Rooftop", asignadoId: 1, prioridad: "ALTA", estado: "levantamiento", descripcion: "Carga inicial.", tipo: "no_programado" },
                { id: 102, titulo: "Preventivo Mensual Compresor", asignadoId: 1, prioridad: "MEDIA", estado: "ejecucion", descripcion: "Limpieza filtros.", tipo: "programado" },
                { id: 103, titulo: "Revisión Tablero Eléctrico", asignadoId: 2, prioridad: "BAJA", estado: "completada", descripcion: "Todo ok.", tipo: "programado", comentario_tecnico: "Sin hallazgos.", costo: 12000, archivado: false }
            ];
            localStorage.setItem(V4_DATA_KEY, 'true');
            persist();
        }
        persist(); // Guardar la migración inmediatamente

        function persist() {
            try {
                localStorage.setItem('cmms_equipos', JSON.stringify(equipos));
                localStorage.setItem('cmms_tecnicos', JSON.stringify(tecnicos));
                localStorage.setItem('cmms_labor', JSON.stringify(laborLogs));
                localStorage.setItem('cmms_management', JSON.stringify(managementLogs));
                localStorage.setItem('cmms_tools', JSON.stringify(toolLogs));
                localStorage.setItem('cmms_ots', JSON.stringify(ots));
                localStorage.setItem('cmms_repuestos', JSON.stringify(repuestos));
                localStorage.setItem('cmms_tool_suggestions', JSON.stringify(toolSuggestions));
                localStorage.setItem('cmms_ordenes_compra', JSON.stringify(ordenesCompra));
                localStorage.setItem('cmms_preventivos_backlog', JSON.stringify(preventivosBacklog));
                localStorage.setItem('cmms_biblioteca', JSON.stringify(biblioteca));
                // Perfil de supervisor
                if (currentRole === 'admin' && currentUser && currentUser.nombre === 'Administrator') {
                    localStorage.setItem('cmms_admin_profile', JSON.stringify(currentUser));
                }
            } catch (e) {
                console.error("Storage Error:", e);
                alert("¡MEMORIA LLENA! No se pudo guardar. Por favor, borra fotos antiguas o usa el botón 'Reset Data' para limpiar la demo.");
            }
        }

        function factoryReset() {
            if (confirm("¿Quieres restablecer los datos de ejemplo? Se borrarán tus cambios actuales.")) {
                localStorage.clear(); // Limpiar TODO para asegurar caga v3.3
                location.reload();
            }
        }

        function simulateMajorIncident() {
            if (!confirm("⚠️ ¿INICIAR SIMULACIÓN DE CRISIS TOTAL?\n\nEsto generará:\n1. Alerta SOS de Incendio 🔥\n2. Falla Crítica en Ascensores (Correctivo) 📉\n3. Vencimiento de Mantención en Calderas (Preventivo) ⏱️\n4. Agotamiento de Stock Crítico 📦")) return;

            // 1. SOS Trigger
            // We can simulate this by manually setting the SOS state or just opening the panel with a message.
            const sosMsg = "🔥 INCENDIO DETECTADO - COCINA CENTRAL";
            const sosBtn = document.getElementById('btn-global-sos');
            if (sosBtn) {
                // For effect, let's delay the click slightly
                setTimeout(() => sosBtn.click(), 500);
            }

            // Visual alarm effect
            const appContainer = document.querySelector('.app-container');
            if (appContainer) {
                appContainer.style.boxShadow = "inset 0 0 50px red";
                setTimeout(() => appContainer.style.boxShadow = "", 5000);
            }

            // 2. Corrective Failure (Elevator)
            const elevator = equipos.find(e => e.nombre.includes("Ascensor"));
            if (elevator) {
                elevator.estado = 'peligro';
                elevator.dispo = 0;
                // Add diagnostic info directly to the object for the UI to pick up conceptually
                // In a real app we might have a separate 'alarms' array, but here we use properties
                // We'll update the 'diagnostico' field that we added in previous steps? 
                // Currently 'diagnostico' is mainly in the Modal UI logic, let's persist it in notes or a specific field if we added it.
                // We added 'eq-diagnostico' input in modal, assuming it saves to 'diagnostico' property.
                elevator.diagnostico = "Corte de piola tracción - REEMPLAZO URGENTE";
                elevator.notas = "FALLA CATASTRÓFICA SIMULADA: El equipo cayó 2 pisos. Bloqueo de seguridad activado.";

                // Create Unplanned OT automatically
                const newOT = {
                    id: 1000 + Math.floor(Math.random() * 9000),
                    titulo: "URGENTE: Caída de Ascensor",
                    asignadoId: null, // Unassigned, manager must assign
                    prioridad: "ALTA",
                    estado: "pendiente",
                    descripcion: "Se reporta caída libre y bloqueo de seguridad. Revisar inmediato. Posible rescate necesario.",
                    tipo: "no_programado",
                    equipoId: elevator.id,
                    fecha: new Date().toISOString().split('T')[0]
                };
                ots.push(newOT);
            }

            // 3. Preventive Expiry (Boiler)
            const boiler = equipos.find(e => e.nombre.includes("Caldera"));
            if (boiler) {
                // Set hours significantly above frequency
                boiler.horas = boiler.freq + 150;
                boiler.estado = 'alerta'; // Yellow status
                // Logic in 'renderActivos' should create visual cue for this
            }

            // 4. Critical Stock Depletion
            // Find a critical spare part
            if (repuestos.length > 0) {
                repuestos[0].stock = 0; // Depletes the first item (usually Compressor or Gas)
            }

            persist();

            // Force refresh of current view
            const currentView = document.querySelector('.sidebar-nav .active') ? document.querySelector('.sidebar-nav .active').id.replace('nav-', '') : 'dashboard';
            navigate(currentView);

            // Notify user
            // We can reuse the 'modal-notificatoria' for a dramatic effect
            // document.getElementById('notif-titulo').innerText = "¡CRISIS INICIADA!";
            // document.getElementById('notif-mensaje').innerText = "Se han inyectado múltiples fallas en el sistema. Revise el Dashboard.";
            // document.getElementById('modal-notificatoria').style.display = 'flex';
        }

        // --- ENGINE ---
        function navigate(view, params = null) {
            const content = document.getElementById('main-content');
            if (!content) return;

            // Update active state in Sidebar
            document.querySelectorAll('.btn-sidebar').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById('nav-' + view);
            if (activeBtn) activeBtn.classList.add('active');

            // Update active state in Mobile Bottom Nav
            document.querySelectorAll('.mobile-nav-item').forEach(b => b.classList.remove('active'));
            const activeMobBtn = document.getElementById('mob-nav-' + view);
            if (activeMobBtn) activeMobBtn.classList.add('active');

            let html = '';
            switch (view) {
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'muro':
                    html = renderMuroControl();
                    break;
                case 'activos':
                    html = renderActivos(params);
                    break;
                case 'ots':
                    html = renderOTs();
                    break;
                case 'reportes':
                    html = renderReportes();
                    break;
                case 'personal':
                    html = renderPersonal();
                    break;
                case 'compras':
                    html = renderCompras();
                    break;
                case 'bodega':
                    html = renderBodega();
                    break;
                case 'biblioteca':
                    html = renderBiblioteca();
                    break;
                case 'gantt':
                    html = renderGantt();
                    break;
                case 'contratistas':
                    html = renderContratistas();
                    break;
                case 'auditoria':
                    html = '<div class="view-content"><h2>Auditoría</h2><p>Módulo de Auditoría en desarrollo.</p></div>';
                    break;
                case 'perfil':
                    html = renderPerfil();
                    break;
                default:
                    html = `<div class="view-content"><h2>Próximamente</h2><p>Módulo de ${view} en desarrollo.</p></div>`;
            }
            content.innerHTML = html;

            if (view === 'dashboard') {
                setTimeout(initDashboardCharts, 50);
            }

            // Mobile: Scroll to top
            window.scrollTo(0, 0);
        }

        // Render Profile View
        function renderPerfil() {
            if (!currentUser) return '<div class="view-content"><p>No hay usuario activo</p></div>';

            const isAdmin = currentUser.role === 'admin' || emulatingSupervisor;
            const userName = currentUser.nombre || 'Usuario';
            const userPhoto = currentUser.foto || 'https://via.placeholder.com/150';
            const userRole = isAdmin ? 'Supervisor' : 'Técnico';
            const userSpecialty = currentUser.especialidad || currentUser.especialidades?.join(', ') || 'N/A';

            return `
                <div class="view-content" style="max-width: 500px; margin: 0 auto;">
                    <h2 style="margin-bottom: 2rem;">Mi Perfil</h2>
                    
                    <!-- User Card -->
                    <div class="card" style="text-align: center; padding: 2rem;">
                        <img src="${userPhoto}" 
                             style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 0 auto 1rem; border: 4px solid var(--color-primary); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);">
                        
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">${userName}</h3>
                        <div style="display: inline-block; padding: 6px 16px; background: ${isAdmin ? 'var(--color-primary)' : 'var(--color-warning)'}; color: white; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                            ${userRole}
                        </div>
                        
                        ${!isAdmin ? `
                            <div style="margin-top: 1rem; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 4px;">Especialidad</div>
                                <div style="font-weight: 600;">${userSpecialty}</div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Actions -->
                    <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 12px;">
                        <!-- INSTALL PWA BUTTON (Visible only if not installed) -->
                        <button onclick="installPWA()" class="btn" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #10b981, #059669); color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span class="material-symbols-rounded">download</span>
                            Instalar App en este dispositivo
                        </button>

                        <!-- ENABLE NOTIFICATIONS BUTTON -->
                        <button onclick="requestNotificationPermission()" class="btn" style="width: 100%; padding: 1rem; background: rgba(59, 130, 246, 0.1); color: var(--color-primary); border: 1px solid var(--color-primary); display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span class="material-symbols-rounded">notifications_active</span>
                            Activar Notificaciones
                        </button>

                        ${isAdmin ? `
                            <button onclick="openModalPerfil()" class="btn btn-primary" style="width: 100%; padding: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span class="material-symbols-rounded">settings</span>
                                Configurar Perfil y Branding
                            </button>
                        ` : ''}
                        
                        <button onclick="closeShift()" class="btn" style="width: 100%; padding: 1rem; background: var(--color-danger); color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span class="material-symbols-rounded">logout</span>
                            Cerrar Turno
                        </button>
                    </div>

                    <!-- Info Footer -->
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.02); border-radius: 8px; text-align: center; font-size: 0.75rem; color: var(--color-text-muted);">
                        <div style="margin-bottom: 8px;">
                            <strong>XELONIA uptime</strong> v1.0
                        </div>
                        <div>
                            Sistema de Gestión de Mantenimiento
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleRole() {
            currentRole = currentRole === 'admin' ? 'tecnico' : 'admin';

            // SWAP CURRENT USER
            if (currentRole === 'admin') {
                currentUser = { id: 999, nombre: 'Administrator', role: 'admin' };
            } else {
                currentUser = tecnicos[0]; // Juan Pérez por defecto
            }

            // Aplicar clase de vista enfocada
            if (currentRole === 'tecnico') container.classList.add('tecnico-mode');
            else container.classList.remove('tecnico-mode');

            const badge = document.getElementById('role-badge');
            if (badge) {
                badge.innerText = currentRole.toUpperCase();
                badge.style.borderColor = currentRole === 'admin' ? 'var(--color-primary)' : 'var(--color-warning)';
                badge.style.color = currentRole === 'admin' ? 'var(--color-primary)' : 'var(--color-warning)';
            }

            if (currentRole === 'tecnico') navigate('ots');
            else navigate('dashboard');
        }

        // --- SECURITY / PIN SYSTEM ---
        let ADMIN_PIN = localStorage.getItem('cmms_admin_pin') || '1234'; // Editable admin PIN
        let pendingRoleSwitch = null;
        let selectedUserForLogin = null; // Usuario seleccionado en el grid

        // Toggle PIN visibility (eye icon)
        function togglePinVisibility(inputId) {
            const input = document.getElementById(inputId);
            const eyeIcon = document.getElementById(inputId + '-eye');
            if (!input || !eyeIcon) return;

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.innerText = 'visibility_off';
            } else {
                input.type = 'password';
                eyeIcon.innerText = 'visibility';
            }
        }

        // Mostrar selector de usuarios
        function showUserSelector() {
            const screen = document.getElementById('user-selector-screen');
            const grid = document.getElementById('user-grid');

            if (!screen || !grid) return;

            // Asegurar que los técnicos tengan PIN por defecto
            tecnicos.forEach(t => {
                if (!t.pin) t.pin = '1111';
            });

            // Generar cards de usuarios
            let html = '';

            // Supervisor
            html += `
                <div class="user-card supervisor" onclick="selectUserForLogin('supervisor', 999)">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=f59e0b&color=fff" class="user-avatar">
                    <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 4px;">Supervisor</div>
                    <div style="font-size: 0.65rem; color: var(--color-warning); font-weight: 600;">ADMINISTRADOR</div>
                </div>
            `;

            // Técnicos
            tecnicos.forEach(t => {
                html += `
                    <div class="user-card" onclick="selectUserForLogin('tecnico', ${t.id})">
                        <img src="${t.foto}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(t.nombre)}&background=3b82f6&color=fff'">
                        <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 4px;">${t.nombre}</div>
                        <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 600;">${t.especialidad || 'TÉCNICO'}</div>
                    </div>
                `;
            });

            grid.innerHTML = html;
            screen.style.display = 'flex';
        }

        // Seleccionar usuario y abrir PIN modal
        function selectUserForLogin(role, userId) {
            selectedUserForLogin = { role, userId };

            // Ocultar selector
            document.getElementById('user-selector-screen').style.display = 'none';

            // Abrir modal PIN con info del usuario seleccionado
            openPinModalForUser();
        }

        // Abrir PIN modal para usuario pre-seleccionado
        function openPinModalForUser() {
            const modal = document.getElementById('modal-pin');
            const title = document.getElementById('pin-title');
            const avatar = document.getElementById('pin-user-avatar');
            const select = document.getElementById('pin-user-select');

            // Clear previous state
            currentPinInput = '';
            updatePinDots();
            document.getElementById('pin-error').style.display = 'none';

            if (selectedUserForLogin.role === 'supervisor') {
                title.innerText = "Acceso Supervisor";
                avatar.src = 'https://ui-avatars.com/api/?name=Admin&background=f59e0b&color=fff';
            } else {
                const tecnico = tecnicos.find(t => t.id === selectedUserForLogin.userId);
                title.innerText = tecnico ? tecnico.nombre : "Técnico";
                avatar.src = tecnico ? tecnico.foto : '';
            }

            // Ocultar el dropdown de selección de usuario
            if (select) select.style.display = 'none';

            modal.style.display = 'flex';
        }

        function openLoginModal(targetRole) {
            const modal = document.getElementById('modal-pin');
            const title = document.getElementById('pin-title');
            const select = document.getElementById('pin-user-select');
            const avatar = document.getElementById('pin-user-avatar');

            pendingRoleSwitch = targetRole;

            // Clear previous state
            currentPinInput = '';
            updatePinDots();
            document.getElementById('pin-error').style.display = 'none';

            // Populate User Dropdown
            select.innerHTML = '';
            if (targetRole === 'admin') {
                title.innerText = "Acceso Supervisor";
                const opt = document.createElement('option');
                opt.value = '999';
                opt.text = 'Administrador General';
                opt.dataset.img = 'https://ui-avatars.com/api/?name=Admin&background=3b82f6&color=fff';
                select.appendChild(opt);
            } else {
                title.innerText = "Acceso Técnico";
                tecnicos.forEach(t => {
                    // Assign default PIN if missing (for demo)
                    if (!t.pin) t.pin = '1111';

                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.text = t.nombre;
                    opt.dataset.img = t.foto;
                    select.appendChild(opt);
                });
            }

            // Update Avatar on Change
            select.onchange = () => {
                const selected = select.options[select.selectedIndex];
                avatar.src = selected.dataset.img;
            };

            // Trigger first avatar update
            select.onchange();

            modal.style.display = 'flex';
        }

        function closePinModal() {
            document.getElementById('modal-pin').style.display = 'none';
        }

        let currentPinInput = '';

        function handlePinInput(num) {
            // Haptic feedback (vibration on mobile)
            if (navigator.vibrate) {
                navigator.vibrate(10); // 10ms micro-vibration
            }

            // Visual feedback - flash effect
            const buttons = document.querySelectorAll('.pin-key');
            buttons.forEach(btn => {
                if (btn.innerText === num) {
                    btn.classList.add('pin-key-active');
                    setTimeout(() => btn.classList.remove('pin-key-active'), 150);
                }
            });

            if (currentPinInput.length < 4) {
                currentPinInput += num;
                updatePinDots();
            }
            if (currentPinInput.length === 4) {
                setTimeout(verifyPin, 200);
            }
        }

        function backspacePin() {
            currentPinInput = currentPinInput.slice(0, -1);
            updatePinDots();
            document.getElementById('pin-error').style.display = 'none';
        }

        function updatePinDots() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i < currentPinInput.length);
            });
        }

        function verifyPin() {
            if (!selectedUserForLogin) {
                alert('Error: usuario no seleccionado');
                return;
            }

            const enteredPin = currentPinInput;
            let isValid = false;

            if (selectedUserForLogin.role === 'supervisor') {
                if (enteredPin === ADMIN_PIN) {
                    isValid = true;
                    currentUser = { id: 999, nombre: 'Administrator', role: 'admin' };
                    currentRole = 'admin';
                }
            } else {
                const tech = tecnicos.find(t => t.id === selectedUserForLogin.userId);
                if (tech && tech.pin === enteredPin) {
                    isValid = true;
                    currentUser = tech;
                    currentRole = 'tecnico';
                }
            }

            if (isValid) {
                // Guardar sesión
                sessionStorage.setItem('cmms_session', JSON.stringify({
                    userId: currentUser.id,
                    userRole: currentRole,
                    loginTimestamp: new Date().toISOString()
                }));

                // Cerrar modal PIN
                document.getElementById('modal-pin').style.display = 'none';

                // Mostrar app wrapper y container
                document.getElementById('app').style.display = 'block';
                const appContainer = document.querySelector('.app-container');
                if (appContainer) appContainer.style.display = 'grid';

                // Aplicar UI según rol
                toggleRoleUI();

                selectedUserForLogin = null; // Reset
            } else {
                const err = document.getElementById('pin-error');
                err.style.display = 'block';
                err.classList.add('shake');
                setTimeout(() => err.classList.remove('shake'), 500);
                currentPinInput = '';
                updatePinDots();
            }
        }

        // Cerrar Turno (Logout with validations)
        function closeShift() {
            if (!currentUser) return;

            // Verificar si hay timer activo
            const activeTimer = ots.find(o => o.timerActive && o.asignadoId === currentUser.id);
            if (activeTimer) {
                if (!confirm(`⚠️ CRONÓMETRO ACTIVO\n\nTienes un cronómetro corriendo en la OT #${activeTimer.id}.\n\n¿Estás seguro que quieres cerrar turno? El cronómetro se detendrá automáticamente.`)) {
                    return;
                }
                // Detener el cronómetro automáticamente
                stopOTTimer(activeTimer.id);
            }

            // Confirmación final
            const userName = currentUser.nombre || 'usuario';
            if (!confirm(`¿Cerrar turno y entregar dispositivo?\n\nUsuario: ${userName}\n\nEl sistema regresará a la pantalla de selección de usuarios.`)) {
                return;
            }

            // Limpiar sesión
            sessionStorage.removeItem('cmms_session');
            currentUser = null;
            currentRole = null;
            selectedUserForLogin = null;

            // Ocultar app
            document.getElementById('app').style.display = 'none';
            const appContainer = document.querySelector('.app-container');
            if (appContainer) appContainer.style.display = 'none';

            // Mostrar splash y luego selector
            const splash = document.getElementById('splash-screen');
            if (splash) {
                splash.style.display = 'flex';
                splash.style.opacity = '1';

                setTimeout(() => {
                    splash.style.opacity = '0';
                    setTimeout(() => {
                        splash.style.display = 'none';
                        showUserSelector();
                    }, 600);
                }, 1500); // Mostrar splash brevemente
            } else {
            }
        }

        // --- SUPERVISOR EMULATION LOGIC ---
        let emulatingSupervisor = null; // Stores the admin user object when emulating

        // Modify quickToggleRole to handle emulation selection
        function quickToggleRole() {
            if (emulatingSupervisor) {
                // If we are currently emulating, stop emulation and return to admin
                stopEmulation();
            } else {
                // We are admin, show list to choose who to emulate
                if (currentUser && currentUser.role === 'admin') {
                    openEmulateModal();
                }
            }
        }

        function openEmulateModal() {
            const list = document.getElementById('emulate-tech-list');
            list.innerHTML = '';

            tecnicos.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'emulate-btn';
                btn.innerHTML = `
                    <img src="${t.foto}" style="width:32px; height:32px; border-radius:50%; margin-right:12px; object-fit: cover;"> 
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:600;">${t.nombre}</span>
                        <span style="font-size:0.75rem; opacity:0.7;">${t.especialidad || 'Técnico'}</span>
                    </div>
                `;
                btn.onclick = () => startEmulation(t);
                list.appendChild(btn);
            });

            document.getElementById('modal-emulate-tech').style.display = 'flex';
        }

        function closeEmulateModal() {
            document.getElementById('modal-emulate-tech').style.display = 'none';
        }

        function startEmulation(tech) {
            emulatingSupervisor = currentUser; // Save the real admin user
            currentUser = tech; // Switch identity to the selected technician
            currentRole = 'tecnico'; // Switch role logic

            closeEmulateModal();
            toggleRoleUI();

            // Optional: visual feedback
            // alert(`👁️ Modo Emulación Activo: Vista de ${tech.nombre}`);
        }

        function stopEmulation() {
            if (emulatingSupervisor) {
                currentUser = emulatingSupervisor; // Restore admin user
                emulatingSupervisor = null;
                currentRole = 'admin'; // Restore role
                toggleRoleUI();
            }
        }

        // Helper to apply role UI (extracted from old toggleRole)
        // Helper to apply role UI
        function toggleRoleUI() {
            const container = document.querySelector('.app-container');
            if (currentRole === 'tecnico') container.classList.add('tecnico-mode');
            else container.classList.remove('tecnico-mode');

            const badge = document.getElementById('role-badge');
            if (badge) {
                badge.innerText = currentRole === 'admin' ? 'SUPERVISOR - PC' : 'TÉCNICO - MÓVIL';
                badge.style.borderColor = currentRole === 'admin' ? 'var(--color-primary)' : 'var(--color-warning)';
                badge.style.color = currentRole === 'admin' ? 'var(--color-primary)' : 'var(--color-warning)';

                // Only show badge if the actual logged-in user is an Admin/Supervisor OR if we are emulating
                // This allows them to switch modes even if they are currently in 'tecnico' emulation
                if ((currentUser && currentUser.role === 'admin') || emulatingSupervisor) {
                    badge.style.display = 'block';
                    badge.style.cursor = 'pointer';

                    // Update badge text if emulating
                    if (emulatingSupervisor && currentRole === 'tecnico') {
                        badge.innerText = 'EMULANDO: ' + (currentUser.nombre ? currentUser.nombre.split(' ')[0].toUpperCase() : 'TÉCNICO');
                        badge.style.borderColor = 'var(--color-accent)';
                        badge.style.color = 'var(--color-accent)';
                    }
                } else {
                    badge.style.display = 'none';
                }
            }

            applyRolePermissions();

            if (currentRole === 'tecnico') navigate('ots');
            else navigate('dashboard');
        }

        function applyRolePermissions() {
            const isAdm = currentRole === 'admin';

            // Sidebar buttons
            const adminOnlyItems = ['nav-dashboard', 'nav-muro', 'nav-reportes', 'nav-personal', 'nav-compras', 'nav-gantt', 'nav-contratistas'];
            adminOnlyItems.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = isAdm ? 'flex' : 'none';
            });

            // Mobile nav items
            const adminOnlyMobile = ['nav-dashboard-mobile', 'nav-muro-mobile', 'nav-compras-mobile', 'nav-gantt-mobile', 'nav-contratistas-mobile'];
            adminOnlyMobile.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = isAdm ? 'flex' : 'none';
            });

            // Specific UI Actions
            const btnReset = document.getElementById('btn-reset-demo');
            if (btnReset) btnReset.style.display = isAdm ? 'block' : 'none';
        }

        function renderDashboard() {
            // Inicialización de Variables y Cálculos
            const alertas = equipos.filter(e => e.estado !== 'activo').length;
            const equiposCriticosAlerta = equipos.filter(e => e.criticidad === 'AAA' && e.estado !== 'activo');
            const pendingRevision = ots.filter(o => o.estado === 'revision');
            const valorTotalActivos = equipos.reduce((sum, e) => sum + (e.valorMercado || 0), 0);
            const costoTotalMantenimiento = equipos.reduce((sum, e) => sum + (e.costoMantAcumulado || 0), 0);
            const fmt = (num) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(num);

            // 1. HEADER (Título y Estado)
            const headerHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; cursor: pointer;">
                    <div>
                        <h3 style="margin: 0; font-size: 1.75rem; font-weight: 900; letter-spacing: -0.8px; color: white; display: flex; align-items: center; gap: 12px;">
                            <span class="material-symbols-rounded" style="color: var(--color-primary); font-size: 32px;">dashboard_customize</span>
                            Dashboard Ejecutivo
                        </h3>
                        <p style="font-size: 0.9rem; color: var(--color-text-muted); margin: 8px 0 0 0; line-height: 1.6; font-weight: 500;">Análisis financiero y control de KPIs operacionales.</p>
                    </div>
                    <div style="text-align: right; background: rgba(16, 185, 129, 0.05); padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.15);">
                        <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">Estado del Turno</div>
                        <div style="font-size: 0.85rem; color: var(--color-success); font-weight: 900; margin-top: 4px;">● OPERATIVO</div>
                    </div>
                </div>`;

            // --- SUPERVISOR METRICS (Traffic Light) ---
            const unassigned = ots.filter(o => !o.asignadoId || o.asignadoId === 0).length;
            const pendingAuth = ots.filter(o => o.estado === 'revision').length;

            const workloads = tecnicos.map(t => ots.filter(o => o.asignadoId === t.id && o.estado !== 'completada').length);
            const maxLoad = Math.max(...workloads);
            const minLoad = Math.min(...workloads);
            const imbalance = maxLoad - minLoad;

            let supStatus = 'green';
            let supMsg = 'Todo en orden. Buen trabajo.';
            if (unassigned > 0 || pendingAuth > 0) {
                supStatus = 'yellow';
                supMsg = 'Tareas pendientes de gestión o revisión.';
            }
            if (unassigned > 2 || imbalance > 3) {
                supStatus = 'red';
                supMsg = '¡Atención! Desbalance crítico o tareas sin asignar.';
            }

            const balanceBtn = (imbalance > 1 && currentRole === 'admin') ?
                `<button onclick="openBalanceModal()" class="btn" style="margin-top: 10px; font-size: 0.7rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: 100%;">⚖️ REASIGNAR CARGA INTELIGENTE</button>` : '';

            const supervisorWidgetHtml = currentRole === 'admin' ? `
                <div class="card" style="margin-top: -1.5rem; margin-bottom: 2rem; border-left: 4px solid ${supStatus === 'red' ? 'var(--color-danger)' : (supStatus === 'yellow' ? 'var(--color-warning)' : 'var(--color-success)')}; background: rgba(15, 23, 42, 0.6);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: ${supStatus === 'red' ? 'var(--color-danger)' : (supStatus === 'yellow' ? 'var(--color-warning)' : 'var(--color-success)')}; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px ${supStatus === 'red' ? 'rgba(239,68,68,0.4)' : 'rgba(16,185,129,0.2)'};">
                                <span class="material-symbols-rounded" style="font-size: 28px; color: white;">${supStatus === 'red' ? 'priority_high' : (supStatus === 'yellow' ? 'notifications' : 'check')}</span>
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 1rem; color: white;">Estado de Supervisión</h4>
                                <div style="font-size: 0.8rem; color: var(--color-text-muted);">${supMsg}</div>
                                ${balanceBtn}
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; text-align: right;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: ${unassigned > 0 ? 'var(--color-danger)' : 'var(--color-text-muted)'};">${unassigned}</div>
                                <div style="font-size: 0.6rem; color: var(--color-text-muted); font-weight: bold;">SIN ASIGNAR</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: ${pendingAuth > 0 ? 'var(--color-warning)' : 'var(--color-text-muted)'};">${pendingAuth}</div>
                                <div style="font-size: 0.6rem; color: var(--color-text-muted); font-weight: bold;">POR APROBAR</div>
                            </div>
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 800; color: ${imbalance > 2 ? 'var(--color-warning)' : 'var(--color-success)'};">${imbalance}</div>
                                <div style="font-size: 0.6rem; color: var(--color-text-muted); font-weight: bold;">DESVÍO CARGA</div>
                            </div>
                        </div>
                    </div>
                </div>` : '';

            // 2. TOP CARDS (CAPEX / OPEX / ALERTAS OPERATIVAS)
            // Técnicos no ven CAPEX/OPEX
            const topCardsHtml = currentRole === 'admin' ? `
                <div class="dashboard-grid">
                    <div class="card" style="background: linear-gradient(135deg, #1e293b, #0f172a); border-left: 4px solid var(--color-primary); margin-bottom: 0;">
                        <div style="font-size: 0.65rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase;">Valor Activos (CAPEX)</div>
                        <div style="font-size: 1.4rem; font-weight: 700; margin-top: 5px;">${fmt(valorTotalActivos)}</div>
                        <div style="font-size: 0.55rem; color: var(--color-text-muted); margin-top: 4px;">Valor de mercado actual</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #1e293b, #0f172a); border-left: 4px solid var(--color-warning); margin-bottom: 0;">
                        <div style="font-size: 0.65rem; color: var(--color-warning); font-weight: 800; text-transform: uppercase;">Inversión Mant. (OPEX)</div>
                        <div style="font-size: 1.4rem; font-weight: 700; margin-top: 5px;">${fmt(costoTotalMantenimiento)}</div>
                        <div style="font-size: 0.55rem; color: var(--color-text-muted); margin-top: 4px;">Acumulado HH + Insumos</div>
                    </div>
                    <div onclick="navigate('activos', 'alertas')" class="card" style="background: ${alertas > 0 ? '#b91c1c' : '#059669'}; margin-bottom: 0; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.65rem; opacity: 0.8; font-weight: 800;">ALERTA OPERATIVA</div>
                            <span class="material-symbols-rounded" style="font-size: 1rem;">warning</span>
                        </div>
                        <div style="font-size: 1.4rem; font-weight: 700;">${alertas}</div>
                        <div style="font-size: 0.55rem; opacity: 0.9;">EQUIPOS FUERA DE SERVICIO</div>
                    </div>
                </div>` : `
                <div class="dashboard-grid">
                    <div class="card" style="background: linear-gradient(135deg, #1e293b, #0f172a); border-left: 4px solid var(--color-success); margin-bottom: 0;">
                        <div style="font-size: 0.65rem; color: var(--color-success); font-weight: 800; text-transform: uppercase;">Mis Tareas Hoy</div>
                        <div style="font-size: 1.4rem; font-weight: 700; margin-top: 5px;">${ots.filter(o => o.asignadoId === currentUser.id && o.estado !== 'completada').length}</div>
                        <div style="font-size: 0.55rem; color: var(--color-text-muted); margin-top: 4px;">Órdenes pendientes</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #1e293b, #0f172a); border-left: 4px solid var(--color-primary); margin-bottom: 0;">
                        <div style="font-size: 0.65rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase;">Disponibilidad</div>
                        <div style="font-size: 1.4rem; font-weight: 700; margin-top: 5px;">${Math.round(equipos.reduce((a, b) => a + b.dispo, 0) / equipos.length)}%</div>
                        <div style="font-size: 0.55rem; color: var(--color-text-muted); margin-top: 4px;">Promedio global planta</div>
                    </div>
                    <div onclick="navigate('activos', 'alertas')" class="card" style="background: ${alertas > 0 ? '#b91c1c' : '#059669'}; margin-bottom: 0; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.65rem; opacity: 0.8; font-weight: 800;">ALERTA OPERATIVA</div>
                            <span class="material-symbols-rounded" style="font-size: 1rem;">warning</span>
                        </div>
                        <div style="font-size: 1.4rem; font-weight: 700;">${alertas}</div>
                        <div style="font-size: 0.55rem; opacity: 0.9;">EQUIPOS FUERA DE SERVICIO</div>
                    </div>
                </div>`;

            // 3. KPIS GERENCIALES
            const kpiSectionHtml = currentRole === 'admin' ? `
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded" style="color: var(--color-success);">analytics</span> 
                        KPIs Operacionales
                    </h4>
                    <div class="dashboard-grid" style="grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem;">
                        <div class="card" style="margin-bottom: 0; min-height: 200px; padding: 15px; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="font-size: 0.65rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase; margin-bottom: 1rem;">Cumplimiento de Planificación</div>
                            <div style="height: 140px; display: flex; align-items: center; justify-content: center;">
                                <canvas id="chart-pie-scheduled"></canvas>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded" style="color: gold;">emoji_events</span> 
                        Competición y Liderazgo
                    </h4>
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="card" style="margin-bottom: 0; padding: 15px;">
                            <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase; margin-bottom: 0.8rem;">Cierres por Técnico (Hoy)</div>
                            <div style="height: 180px; width: 100%;">
                                <canvas id="chart-performance"></canvas>
                            </div>
                        </div>
                        <div class="card" style="margin-bottom: 0; padding: 15px;">
                            <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase; margin-bottom: 0.8rem;">🏆 Ranking Mensual (Acumulado)</div>
                            <div style="height: 180px; width: 100%;">
                                <canvas id="chart-monthly-leaders"></canvas>
                            </div>
                        </div>
                    </div>
                </div>` : '';

            // 4. GESTIÓN CRÍTICA (Alertas Vitales / Stock / Levantamientos)
            let gestionCriticaHtml = '';

            // 4a. Alertas Vitales
            if (equiposCriticosAlerta.length > 0) {
                gestionCriticaHtml += `
                    <div style="margin-top: 2rem;">
                        <h4 style="color: var(--color-danger); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-rounded">notification_important</span> 
                            ALERTAS VITALES (${equiposCriticosAlerta.length})
                        </h4>
                        <div style="display: grid; gap: 10px;">
                            ${equiposCriticosAlerta.map(e => `
                                <div class="card" style="background: rgba(185, 28, 28, 0.1); border-left: 4px solid var(--color-danger); display: flex; justify-content: space-between; align-items: center; padding: 12px;">
                                    <div>
                                        <div style="font-weight: 800; font-size: 0.9rem;">${e.nombre}</div>
                                        <div style="font-size: 0.7rem; color: var(--color-text-muted);">${e.area} | ${e.especialidad}</div>
                                    </div>
                                    <button onclick="navigate('activos', 'alertas')" class="btn" style="background: var(--color-danger); color: white; font-size: 0.7rem; padding: 4px 10px;">VER DETALLE</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }

            // 4b. Stock Crítico
            if (currentRole === 'admin') {
                gestionCriticaHtml += renderInventarioCritico(); // Asumiendo que devuelve HTML o vacío
            }

            // 4c. Levantamientos Pendientes
            if (currentRole === 'admin' && pendingRevision.length > 0) {
                gestionCriticaHtml += `
                    <div style="margin-top: 1.5rem;">
                        <h4 style="color: var(--color-warning); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-rounded">fact_check</span> Levantamientos Pendientes para Aprobación
                        </h4>
                        ${pendingRevision.map(ot => {
                    const tec = tecnicos.find(t => t.id === ot.asignadoId);
                    const eq = equipos.find(e => e.id === ot.equipoId);
                    return `
                                <div class="card" style="border-left: 4px solid var(--color-warning); margin-bottom: 0.8rem; background: rgba(59, 130, 246, 0.05);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: bold; text-transform: uppercase;">OT #${ot.id} - ${eq ? eq.nombre : 'S/A'}</div>
                                        <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: bold; text-transform: uppercase;">TÉCNICO: ${tec ? tec.nombre : 'S/A'}</div>
                                    </div>
                                    <div style="font-size: 0.9rem; font-weight: 700;">${ot.titulo}</div>
                                    <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.05);">
                                        <div style="color: var(--color-primary); font-size: 0.6rem; font-weight: 800; margin-bottom: 4px; text-transform: uppercase;">Informe de Campo:</div>
                                        "${ot.levantamiento || 'Sin detalle'}"
                                        
                                        <div style="margin-top:8px; display:flex; flex-direction:column; gap:4px;">
                                            <label style="font-size: 0.65rem; color: var(--color-text-muted);">Descripción Final OT:</label>
                                            <input type="text" id="final-desc-${ot.id}" class="form-control" value="${ot.descripcion}" style="font-size: 0.8rem;">
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button onclick="approveLevantamiento(${ot.id})" class="btn btn-primary" style="width: 100%; font-size: 0.7rem; font-weight: bold;">OFICIALIZAR Y AUTORIZAR</button>
                                    </div>
                                </div>`;
                }).join('')}
                    </div>`;
            }

            // 5. HERRAMIENTAS Y SEGURIDAD
            const toolsHtml = currentRole === 'admin' ? renderToolMonitor() : '';

            // 6. MONITOR CÉLULAS TÉCNICAS
            const monitorCelulasHtml = `
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded" style="color: var(--color-primary);">grid_view</span> 
                        Monitor de Células Técnicas (KPIs)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        ${['Clima', 'Electricidad', 'Mecánica', 'Hidráulica', 'Infraestructura'].map(esp => {
                const eqEsp = equipos.filter(e => (e.especialidad || '').toLowerCase() === esp.toLowerCase());
                const total = eqEsp.length;
                if (total === 0) return '';
                const ok = eqEsp.filter(e => e.estado === 'activo').length;
                const porc = total > 0 ? Math.round((ok / total) * 100) : 0;
                return `
                                <div style="background: rgba(255,255,255,0.02); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                                    <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800;">${esp.toUpperCase()}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px;">
                                        <span style="font-size: 1.1rem; font-weight: 800; color: ${porc > 80 ? 'var(--color-success)' : 'var(--color-warning)'}">${porc}%</span>
                                        <span style="font-size: 0.55rem; color: var(--color-text-muted);">${ok}/${total} EQUIPOS OK</span>
                                    </div>
                                    <div style="height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; margin-top: 5px; overflow: hidden;">
                                        <div style="width: ${porc}%; height: 100%; background: ${porc > 80 ? 'var(--color-success)' : 'var(--color-warning)'};"></div>
                                    </div>
                                </div>`;
            }).join('')}
                    </div>
                </div>`;

            // 7. PERSONAL EN TURNO
            const personalHtml = `
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded" style="color: var(--color-primary);">badge</span> 
                        Personal en Turno (Operativo)
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        ${tecnicos.map(t => {
                const tareasActivas = ots.filter(o => o.asignadoId === t.id && o.estado !== 'completada').length;
                return `
                                <div class="card" onclick="renderDetalleTecnico(${t.id})" style="margin-bottom: 0; padding: 15px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); cursor: pointer;">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <img src="${t.foto}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid ${tareasActivas > 0 ? 'var(--color-warning)' : 'var(--color-success)'};">
                                        <div style="flex: 1; overflow: hidden;">
                                            <div style="font-size: 0.9rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${t.nombre}</div>
                                            <div style="font-size: 0.7rem; color: var(--color-text-muted);">${t.especialidad}</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: ${tareasActivas > 0 ? 'rgba(234, 179, 8, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; color: ${tareasActivas > 0 ? 'var(--color-warning)' : 'var(--color-success)'}; font-weight: 800;">
                                            ${tareasActivas > 0 ? 'OCUPADO' : 'DISPONIBLE'}
                                        </span>
                                        <span style="font-size: 0.7rem; color: var(--color-text-muted); font-weight: 600;">${tareasActivas} Tareas Activas</span>
                                    </div>
                                    ${currentRole === 'admin' ? `
                                        <div style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                                            <button onclick="event.stopPropagation(); generateSafetyCompliancePDF(${t.id})" 
                                                    class="btn" 
                                                    style="width: 100%; padding: 6px; font-size: 0.65rem; background: rgba(245, 158, 11, 0.1); 
                                                           color: var(--color-warning); border: 1px solid rgba(245, 158, 11, 0.3);
                                                           display: flex; align-items: center; justify-content: center; gap: 5px;"
                                                    title="Descargar Certificado de Cumplimiento de Seguridad">
                                                <span class="material-symbols-rounded" style="font-size: 14px;">verified_user</span>
                                                PDF Seguridad
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>`;
            }).join('')}
                    </div>
                </div>`;

            // 8. ACCIONES RÁPIDAS
            const quickActionsHtml = `
                <div class="card" style="background: rgba(30, 41, 59, 0.4); border: 1px dashed rgba(59, 130, 246, 0.3); margin-top: 2rem;">
                    <h4 style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px; color: var(--color-primary);">
                        <span class="material-symbols-rounded">settings_applications</span> Acciones Rápidas
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="openModalImportar()" class="btn btn-primary" style="font-size: 0.75rem; font-weight: 700; background: linear-gradient(135deg, #8b5cf6, #6d28d9); padding: 10px;">
                            <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                                <span class="material-symbols-rounded">upload_file</span> IMPORTAR REQ.
                            </div>
                        </button>
                        <button onclick="downloadPDFReport()" class="btn" style="border: 1px solid var(--color-primary); color: white; font-size: 0.75rem;">
                            <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                                <span class="material-symbols-rounded">forward_to_inbox</span> REPORTE GERENCIA
                            </div>
                        </button>
                        <button onclick="downloadQualityReport()" class="btn" style="border: 1px solid var(--color-success); color: var(--color-success); font-size: 0.75rem;">
                            <div style="display:flex; flex-direction:column; align-items:center; gap:5px;">
                                <span class="material-symbols-rounded">area_chart</span> REPORTE CALIDAD
                            </div>
                        </button>
                    </div>
                </div>`;

            // 9. COMANDO & CONTROL (Y LOGS)
            const commandControlHtml = `
                <div class="card" style="border-left: 4px solid var(--color-primary); background: rgba(30, 41, 59, 0.6);">
                    <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded">campaign</span> Comando & Control
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="font-size: 0.65rem; color: var(--color-text-muted);">LUGAR</label>
                            <input type="text" id="meeting-location" class="form-control" placeholder="Ej: Lobby" value="Oficina Técnica" style="font-size: 0.8rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.65rem; color: var(--color-text-muted);">HORA</label>
                            <input type="datetime-local" id="meeting-time" class="form-control" style="font-size: 0.8rem;">
                        </div>
                    </div>

                    <div style="margin-top: 5px;">
                        <button onclick="dispararReunion('agendada')" class="btn" style="width: 100%; background: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.75rem;">
                            <span class="material-symbols-rounded">calendar_month</span> CITAR REUNIÓN
                        </button>
                    </div>

                    <div id="meeting-monitor" style="display: none; margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <div style="font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; color: var(--color-warning);">MONITOR DE RESPUESTA:</div>
                        <div id="attendees-list" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                    </div>
                </div>`;

            // DEV TOOLS (Abajo de todo)
            const devToolsHtml = currentRole === 'admin' ? `
                <div class="card" style="border-left: 4px solid var(--color-warning);">
                    <h4 style="margin-bottom: 10px;">Herramientas de Desarrollo</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="generarDatosDemo()" class="btn btn-primary" style="font-size: 0.7rem;">GENERAR DATOS DE PRUEBA</button>
                        <button onclick="simularIncidenteMayor()" class="btn" style="background: var(--color-danger); color: white; font-size: 0.7rem; font-weight: bold;">⚠️ SIMULAR INCIDENTE</button>
                        <button onclick="localStorage.clear(); location.reload();" class="btn" style="background: var(--color-surface-hover); color: var(--color-text-muted); font-size: 0.7rem;">RESET FÁBRICA</button>
                    </div>
                </div>` : '';

            // logs
            const logsHtml = currentRole === 'admin' ? renderManagementLog() : '';

            // RENDER FINAL
            return headerHtml +
                supervisorWidgetHtml +
                topCardsHtml +
                kpiSectionHtml +
                gestionCriticaHtml +
                toolsHtml +
                monitorCelulasHtml +
                personalHtml +
                quickActionsHtml +
                commandControlHtml +
                logsHtml +
                devToolsHtml;
        }



        function renderInventarioCritico() {
            const criticos = repuestos.filter(r => r.stock <= r.critico);
            if (criticos.length === 0) return '';

            return `
                <div style="margin-top: 2rem;">
                    <h4 style="color: var(--color-danger); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded">inventory</span> 
                        STOCK CRÍTICO BODEGA (${criticos.length})
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        ${criticos.map(r => `
                            <div class="card" style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--color-danger); padding: 12px;">
                                <div style="font-weight: 800; font-size: 0.85rem;">${r.nombre}</div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 8px;">
                                    <span style="font-size: 1.1rem; font-weight: 900; color: white;">${r.stock}</span>
                                    <span style="font-size: 0.6rem; color: var(--color-danger); font-weight: 800;">ALERTA < ${r.critico + 1}</span>
                                </div>
                                <div style="height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                                    <div style="width: ${(r.stock / (r.critico * 2)) * 100}%; height: 100%; background: var(--color-danger);"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderToolMonitor() {
            const alerts = [...toolLogs].reverse().slice(0, 10); // Ver más por si acaso
            const alertsDaniado = alerts.filter(a => {
                const tieneOC = ordenesCompra.some(o => o.refId === a.itemId && (o.estado === 'pendiente' || o.estado === 'transito'));
                return a.estado === 'daniado' && !tieneOC;
            }).slice(0, 5);

            const suggestions = [...toolSuggestions].reverse().slice(0, 3);

            return `
                <div style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded" style="color: var(--color-warning);">handyman</span> 
                        Monitoreo de Herramientas y Seguridad
                    </h4>
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; padding: 0;">
                        <div class="card" style="border-left: 4px solid var(--color-danger); background: rgba(239, 68, 68, 0.05); margin-bottom: 0;">
                            <div style="font-size: 0.65rem; color: var(--color-danger); font-weight: 800; text-transform: uppercase; margin-bottom: 10px;">Alertas de Daño Crítico (🔴)</div>
                            ${alertsDaniado.length === 0 ? '<div style="font-size: 0.7rem; color: var(--color-text-muted); padding: 10px;">Sin daños reportados. Todo operativo ✅</div>' : alertsDaniado.map(a => `
                                <div style="margin-bottom: 8px; font-size: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 6px; display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div>
                                        <div style="font-weight: 800;">${a.nombre}</div>
                                        <div style="color: var(--color-text-muted); font-size: 0.65rem;">Reportado por: ${a.tecnico} | ${new Date(a.fecha).toLocaleDateString()}</div>
                                    </div>
                                    <button onclick="generarOC('herramienta', '${a.nombre}', 1, 0, ${a.itemId})" class="btn" style="background: var(--color-primary); color: white; font-size: 0.6rem; padding: 2px 6px; font-weight: 800;">GENERAR OC</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="card" style="border-left: 4px solid var(--color-primary); background: rgba(59, 130, 246, 0.05); margin-bottom: 0;">
                            <div style="font-size: 0.65rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase; margin-bottom: 10px;">Propuestas de Mejora de Kit</div>
                            ${suggestions.length === 0 ? `<div style="font-size: 0.7rem; color: var(--color-text-muted); padding: 10px;">Sin sugerencias pendientes.</div>` : suggestions.map(s => `
                                <div style="margin-bottom: 8px; font-size: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px;">
                                    <div style="font-style: italic;">"${s.sugerencia}"</div>
                                    <div style="color: var(--color-text-muted); font-size: 0.65rem; margin-top: 2px;">De: ${s.tecnico}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generarOC(cat, item, cant, costo = 0, refId = null) {
            // Validación de duplicado
            const existeOC = ordenesCompra.find(o => o.refId === refId && o.cat === cat && (o.estado === 'pendiente' || o.estado === 'transito'));
            if (existeOC) {
                alert(`⚠️ Ya existe una Orden de Compra activa (#${existeOC.id}) para este ítem.`);
                return;
            }

            const id = Date.now();
            const nuevaOC = {
                id,
                item,
                cat, // 'herramienta', 'insumo', 'equipo'
                cant,
                costo,
                estado: 'pendiente',
                fecha: new Date().toISOString(),
                refId
            };
            ordenesCompra.push(nuevaOC);
            logManagementAction('Compra', `Generada OC #${id} para ${item}`, 'shopping_cart');
            persist();
            alert(`✅ Orden de Compra #${id} generada para: ${item}`);
            renderCurrentView(); // Recargar vista actual para feedback
        }

        function renderCurrentView() {
            // Función auxiliar para refrescar la vista activa
            const activeBtn = document.querySelector('.sidebar-nav .nav-item.active, .sidebar-nav .btn-sidebar.active, .mobile-nav .mobile-nav-item.active');
            if (activeBtn) {
                const view = activeBtn.id ? activeBtn.id.replace('nav-', '').replace('-mobile', '') : 'dashboard';
                navigate(view);
            } else {
                navigate('dashboard');
            }
        }

        function renderCompras() {
            const pendientes = ordenesCompra.filter(o => o.estado === 'pendiente' || o.estado === 'transito');
            const recibidas = ordenesCompra.filter(o => o.estado === 'recibido').reverse().slice(0, 10);
            const totalGasto = pendientes.reduce((sum, o) => sum + (o.costo * o.cant), 0);
            const fmt = (num) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(num);

            return `
                <div class="view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h3 style="margin: 0;">Gestión de Compras y Abastecimiento</h3>
                            <p style="font-size: 0.75rem; color: var(--color-text-muted);">Administración de repuestos, herramientas y activos.</p>
                        </div>
                        <div class="card" style="margin-bottom: 0; padding: 10px 20px; border-left: 4px solid var(--color-primary);">
                            <div style="font-size: 0.6rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase;">Gasto Comprometido</div>
                            <div style="font-size: 1.1rem; font-weight: 700;">${fmt(totalGasto)}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-rounded" style="color: var(--color-warning);">shopping_cart</span> 
                            Órdenes Pendientes (${pendientes.length})
                        </h4>
                        ${pendientes.length === 0 ? '<div class="card" style="text-align: center; color: var(--color-text-muted); font-size: 0.8rem;">No hay órdenes de compra activas.</div>' : `
                            <div style="display: grid; gap: 10px;">
                                ${pendientes.map(o => `
                                    <div class="card" style="margin-bottom: 0; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted); font-weight: 800;">OC #${o.id} | ${new Date(o.fecha).toLocaleDateString()}</div>
                                            <div style="font-weight: 700; font-size: 0.9rem;">${o.item} (x${o.cant})</div>
                                            <div style="font-size: 0.7rem; color: ${o.estado === 'pendiente' ? 'var(--color-warning)' : 'var(--color-primary)'}; font-weight: 700; text-transform: uppercase;">
                                                ESTADO: ${o.estado === 'pendiente' ? 'Esperando Aprobación' : 'En Tránsito'}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
                                <button onclick="downloadOCPDF(${o.id})" class="btn" style="background: var(--color-surface-hover); font-size: 0.65rem; display: flex; align-items: center; gap: 4px;">
                                    <span class="material-symbols-rounded" style="font-size: 16px;">picture_as_pdf</span> PDF OC
                                </button>
                                ${o.estado === 'pendiente' ? `
                                    <button onclick="cambiarEstadoOC(${o.id}, 'transito')" class="btn btn-primary" style="font-size: 0.65rem;">APROBAR ENVÍO</button>
                                ` : `
                                    <button onclick="recibirOC(${o.id})" class="btn btn-success" style="font-size: 0.65rem;">MARCAR RECIBIDO</button>
                                `}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}

                <div style="margin-top: 2rem;">
                    <h4>Historial Reciente (Recibidos)</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${recibidas.length === 0 ? '<p style="font-size: 0.8rem; color: var(--color-text-muted);">No hay órdenes recibidas aún.</p>' : recibidas.map(oc => `
                            <div class="card" style="opacity: 0.7; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;">
                                <div style="font-size: 0.75rem;">
                                    <strong>#${oc.id}</strong> - ${oc.item} (${oc.cant})
                                    <div style="font-size: 0.65rem; color: var(--color-text-muted);">Recibido el ${new Date(oc.fechaRecibido || oc.fecha).toLocaleDateString()}</div>
                                </div>
                                <button onclick="downloadOCPDF(${oc.id})" class="btn" style="padding: 4px; color: var(--color-text-muted);">
                                    <span class="material-symbols-rounded">picture_as_pdf</span>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function downloadOCPDF(id) {
            const oc = ordenesCompra.find(o => o.id === id);
            if (!oc) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabecera Corporativa Premium
            doc.setFillColor(15, 23, 42); // Navy Dark
            doc.rect(0, 0, 210, 45, 'F');

            // "Logo" placeholder (Figura geométrica elegante)
            doc.setFillColor(59, 130, 246);
            doc.circle(25, 22, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text("H5", 21, 24);

            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("ORDEN DE COMPRA", 45, 23);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("DEPARTAMENTO DE INGENIERÍA Y MANTENIMIENTO", 45, 30);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text(`OC N°: #${oc.id}`, 155, 15);
            doc.text(`EMISIÓN: ${new Date(oc.fecha).toLocaleDateString()}`, 155, 22);
            doc.text(`ESTADO: ${oc.estado.toUpperCase()}`, 155, 29);

            // Información del Solicitante
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("DATOS DE FACTURACIÓN Y ENVÍO", 15, 60);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Hotel 5 Estrellas Luxury Resort", 15, 67);
            doc.text("Av. Principal 1234, Santiago, Chile", 15, 72);
            doc.text("RUT: 77.123.456-K", 15, 77);

            // Tabla de Ítems Profesional
            const columns = ["Descripción", "Categoría", "Cantidad", "Costo Unitario", "Subtotal"];
            const data = [
                [
                    oc.item,
                    oc.cat.toUpperCase(),
                    oc.cant.toString(),
                    `$${oc.costo.toLocaleString()}`,
                    `$${(oc.cant * oc.costo).toLocaleString()}`
                ]
            ];

            doc.autoTable({
                startY: 90,
                head: [columns],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246], fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 5 }
            });

            const finalY = doc.previousAutoTable.finalY + 15;

            // Bloque de Totales
            doc.setFillColor(248, 250, 252);
            doc.rect(130, finalY - 5, 65, 20, 'F');
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text(`TOTAL EXENTO:`, 135, finalY + 5);
            doc.text(`$${(oc.cant * oc.costo).toLocaleString()}`, 190, finalY + 5, { align: 'right' });

            // Términos y Condiciones
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(100);
            doc.text("TÉRMINOS Y CONDICIONES:", 15, finalY + 30);
            doc.text("1. El proveedor debe entregar el material en las bodegas centrales del hotel.", 15, finalY + 35);
            doc.text("2. Todo despacho debe adjuntar Factura o Guía de Despacho indicando el número de esta OC.", 15, finalY + 40);
            doc.text("3. El pago se realizará a 30 días tras la recepción conforme del material.", 15, finalY + 45);

            // Firmas
            doc.line(15, finalY + 80, 85, finalY + 80);
            doc.text("Firma Jefe Mantenimiento", 15, finalY + 85);

            doc.line(120, finalY + 80, 190, finalY + 80);
            doc.text("Autorización Gerencia / Finanzas", 120, finalY + 85);

            doc.save(`ORDEN_COMPRA_${oc.id}_${oc.item.replace(/\s+/g, '_')}.pdf`);
        }

        function cambiarEstadoOC(id, nuevoEstado) {
            const oc = ordenesCompra.find(o => o.id === id);
            if (oc) {
                oc.estado = nuevoEstado;
                logManagementAction('Logística', `OC #${id} cambiada a estado ${nuevoEstado}`, 'local_shipping');
                persist();
                renderCurrentView();
            }
        }

        function recibirOC(id) {
            const oc = ordenesCompra.find(o => o.id === id);
            if (!oc) return;

            // Abrir modal de recepción formal
            document.getElementById('recepcion-detalles').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-weight: 800; font-size: 1.1rem; color: var(--color-primary);">${oc.item}</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;"><strong>Cantidad esperada:</strong> ${oc.cant} unidades</div>
                    </div>
                    <div style="text-align: right; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px;">
                        <div style="font-size: 0.6rem; color: var(--color-text-muted);">FOLIO OC</div>
                        <div style="font-size: 0.8rem; font-weight: 800;">#${oc.id}</div>
                    </div>
                </div>
            `;

            document.getElementById('recepcion-notas').value = '';
            document.getElementById('recepcion-operador-id').value = currentUser ? currentUser.userCode || "" : "";
            document.getElementById('modal-recepcion-oc').classList.add('active');

            // --- SIGNATURE PAD LOGIC ---
            setTimeout(initSignaturePad, 100); // Small delay to ensure modal is rendered

            document.getElementById('btn-confirmar-ingreso').onclick = () => {
                const notas = document.getElementById('recepcion-notas').value || "Recibido sin observaciones.";
                const estadoEmpaque = document.getElementById('recepcion-estado-empaque').value;
                const operadorId = document.getElementById('recepcion-operador-id').value;
                const signatureData = getSignatureImage(); // Capture Signature

                if (!operadorId) return alert("Debe ingresar el ID del operador que recibe.");

                oc.estado = 'recibido';
                oc.fechaRecibido = new Date().toISOString();
                oc.notasRecepcion = notas;
                oc.validadoPorId = operadorId;
                oc.estadoFisico = estadoEmpaque;
                oc.firmaRecepcion = signatureData; // SAVE SIGNATURE

                // --- Lógica de actualización de inventario Robusta ---
                if (oc.cat === 'herramienta' && oc.refId) {
                    // Si era un reemplazo de herramienta dañada, limpiamos el log de daño
                    toolLogs = toolLogs.filter(log => log.id !== oc.refId && log.itemId !== oc.refId);
                } else if (oc.cat === 'insumo' && oc.refId) {
                    // Actualizar stock en repuestos
                    const resp = repuestos.find(r => r.id === oc.refId);
                    if (resp) {
                        resp.stock += oc.cant;
                        // Notificación de limpieza de alerta
                        console.log(`Stock actualizado: ${resp.nombre} ahora tiene ${resp.stock}`);
                    }
                } else if (oc.cat === 'equipo' && oc.refId) {
                    // Si compramos un equipo nuevo para reemplazar uno en 'peligro'
                    const eq = equipos.find(e => e.id === oc.refId);
                    if (eq) {
                        eq.estado = 'activo';
                        eq.dispo = 100;
                        eq.historial.unshift({
                            fecha: new Date().toLocaleDateString(),
                            tarea: "REEMPLAZO INTEGRAL",
                            tecnico: "BODEGA / ADQUISICIONES",
                            desc: `Activo renovado según OC #${oc.id}. Estado empaque: ${estadoEmpaque}. Notas: ${notas}`,
                            tipo: "programado"
                        });
                    }
                }

                persist();
                closeModalRecepcion();
                alert(`📦 INGRESO EXITOSO: ${oc.item} registrado por ${operadorId}.`);
                renderCurrentView();
            };
        }

        // --- SIGNATURE PAD HELPER FUNCTIONS ---
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // Reset
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('sig-placeholder').style.display = 'block';

            // Events
            canvas.addEventListener('mousedown', (e) => startDrawing(e, canvas, ctx));
            canvas.addEventListener('mousemove', (e) => draw(e, canvas, ctx));
            canvas.addEventListener('mouseup', () => stopDrawing());
            canvas.addEventListener('mouseout', () => stopDrawing());

            // Touch support
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent scrolling
                startDrawing(e.touches[0], canvas, ctx);
            }, { passive: false });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e.touches[0], canvas, ctx);
            }, { passive: false });
            canvas.addEventListener('touchend', () => stopDrawing());
        }

        function startDrawing(e, canvas, ctx) {
            isDrawing = true;
            document.getElementById('sig-placeholder').style.display = 'none';
            [lastX, lastY] = [e.offsetX || e.clientX - canvas.getBoundingClientRect().left, e.offsetY || e.clientY - canvas.getBoundingClientRect().top];
        }

        function draw(e, canvas, ctx) {
            if (!isDrawing) return;
            const x = e.offsetX || e.clientX - canvas.getBoundingClientRect().left;
            const y = e.offsetY || e.clientY - canvas.getBoundingClientRect().top;

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('sig-placeholder').style.display = 'block';
        }

        function getSignatureImage() {
            const canvas = document.getElementById('signature-pad');
            // Check if empty
            const blank = document.createElement('canvas');
            blank.width = canvas.width;
            blank.height = canvas.height;
            if (canvas.toDataURL() === blank.toDataURL()) return null; // Empty
            return canvas.toDataURL(); // Base64 string
        }

        function closeModalRecepcion() {
            document.getElementById('modal-recepcion-oc').classList.remove('active');
        }

        async function downloadOCPDF(id) {
            const oc = ordenesCompra.find(o => o.id === id);
            if (!oc) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabecera Corporativa Premium
            doc.setFillColor(15, 23, 42); // Navy Dark
            doc.rect(0, 0, 210, 45, 'F');

            // "Logo" placeholder (Figura geométrica elegante)
            doc.setFillColor(59, 130, 246);
            doc.circle(25, 22, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(14);
            doc.text("H5", 21, 24);

            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("ORDEN DE COMPRA", 45, 23);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("DEPARTAMENTO DE INGENIERÍA Y MANTENIMIENTO", 45, 30);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text(`OC N°: #${oc.id}`, 155, 15);
            doc.text(`EMISIÓN: ${new Date(oc.fecha).toLocaleDateString()}`, 155, 22);
            doc.text(`ESTADO: ${oc.estado.toUpperCase()}`, 155, 29);

            // Información del Solicitante
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("DATOS DE FACTURACIÓN Y ENVÍO", 15, 60);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Hotel 5 Estrellas Luxury Resort", 15, 67);
            doc.text("Av. Principal 1234, Santiago, Chile", 15, 72);
            doc.text("RUT: 77.123.456-K", 15, 77);

            // Tabla de Ítems Profesional
            const columns = ["Descripción", "Categoría", "Cantidad", "Costo Unitario", "Subtotal"];
            const data = [
                [
                    oc.item,
                    oc.cat.toUpperCase(),
                    oc.cant.toString(),
                    `$${oc.costo.toLocaleString()}`,
                    `$${(oc.cant * oc.costo).toLocaleString()}`
                ]
            ];

            doc.autoTable({
                startY: 90,
                head: [columns],
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246], fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 5 }
            });

            const finalY = doc.previousAutoTable.finalY + 15;

            // Bloque de Totales
            doc.setFillColor(248, 250, 252);
            doc.rect(130, finalY - 5, 65, 20, 'F');
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text(`TOTAL EXENTO:`, 135, finalY + 5);
            doc.text(`$${(oc.cant * oc.costo).toLocaleString()}`, 190, finalY + 5, { align: 'right' });

            // Términos y Condiciones
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(100);
            doc.text("TÉRMINOS Y CONDICIONES:", 15, finalY + 30);
            doc.text("1. El proveedor debe entregar el material en las bodegas centrales del hotel.", 15, finalY + 35);
            doc.text("2. Todo despacho debe adjuntar Factura o Guía de Despacho indicando el número de esta OC.", 15, finalY + 40);
            doc.text("3. El pago se realizará a 30 días tras la recepción conforme del material.", 15, finalY + 45);

            // SIGNATURE STAMPING
            if (oc.firmaRecepcion) {
                try {
                    doc.addImage(oc.firmaRecepcion, 'PNG', 20, finalY + 70, 50, 20);
                } catch (e) {
                    console.error("Error adding signature to PDF", e);
                }
            }

            // Firmas Textos (Labels)
            doc.line(15, finalY + 90, 85, finalY + 90);
            doc.text("Firma Receptor / Jefe Mantenimiento", 15, finalY + 95);

            doc.line(120, finalY + 90, 190, finalY + 90);
            doc.text("Autorización Gerencia / Finanzas", 120, finalY + 95);

            doc.save(`ORDEN_COMPRA_${oc.id}_${oc.item.replace(/\s+/g, '_')}.pdf`);
        }

        function rechazarOT(id) {
            document.getElementById('rechazo-ot-id').value = id;
            document.getElementById('rechazo-comentario').value = '';
            document.getElementById('modal-rechazo-ot').style.display = 'flex';
        }

        function closeModalRechazo() {
            document.getElementById('modal-rechazo-ot').style.display = 'none';
        }

        function confirmarRechazo() {
            const id = parseInt(document.getElementById('rechazo-ot-id').value);
            const feedback = document.getElementById('rechazo-comentario').value.trim();
            if (!feedback) return alert("Por favor, ingrese el motivo del rechazo.");

            const ot = ots.find(o => o.id === id);
            if (ot) {
                ot.estado = 'rechazada'; // Volver al flujo pero marcada como rechazada
                ot.feedback_supervisor = feedback;
                logManagementAction('Rechazo', `OT #${id} rechazada con observaciones.`, 'cancel');
                persist();
                closeModalRechazo();

                // Disparar alerta sensorial al técnico
                dispararAlertaSensorial(ot.asignadoId, `⚠️ TU TRABAJO (OT #${id}) FUE RECHAZADO: ${feedback}`);

                navigate('ots');
            }
        }

        function approveLevantamiento(id) {
            const val = document.getElementById(`final-desc-${id}`).value;
            const ot = ots.find(o => o.id === id);
            if (ot) {
                ot.descripcion = val;
                ot.estado = 'ejecucion';
                logManagementAction('Aprobación', `Autorizada reparación de OT #${id}`, 'fact_check');
                persist();
                navigate('dashboard');
            }
        }

        function getEquipmentDiagnostic(eq) {
            const dispo = eq.dispo || 100;
            const costoAcum = eq.costoMantAcumulado || 0;
            const valorMkt = eq.valorMercado || 1;
            const ratioFinanciero = (costoAcum / valorMkt) * 100;

            if (eq.estado === 'peligro') return { label: 'FALLA CRÍTICA', color: 'var(--color-danger)', icon: 'error' };
            if (ratioFinanciero > 80) return { label: 'ALERTA FINANCIERA', color: 'var(--color-danger)', icon: 'payments' };
            if (dispo < 85) return { label: 'BAJA DISPO (REVISAR)', color: 'var(--color-warning)', icon: 'warning' };
            if (eq.horas >= (Math.ceil(eq.horas / (eq.freq || 250)) * (eq.freq || 250))) return { label: 'MANT. VENCIDO', color: 'var(--color-warning)', icon: 'history' };

            return { label: 'OPERACIÓN ÓPTIMA', color: 'var(--color-success)', icon: 'check_circle' };
        }

        function renderActivos(filterMode = null) {
            let filtered = equipos;
            let banner = '';

            // Lógica de Filtro Inteligente
            if (filterMode === 'alertas') {
                filtered = equipos.filter(e => e.estado === 'alerta' || e.estado === 'peligro');
                banner = `
                    <div style="background: #b91c1c; color: white; padding: 12px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-symbols-rounded">warning</span>
                            <span style="font-weight: 700;">Viendo Equipos en Alerta (${filtered.length})</span>
                        </div>
                        <button onclick="navigate('activos')" class="btn" style="background: white; color: #b91c1c; font-size: 0.65rem; font-weight: 800; padding: 4px 10px;">MOSTRAR TODOS</button>
                    </div>
                `;
            } else {
                // Filtros normales
                if (assetFilters.search) filtered = filtered.filter(e => e.nombre.toLowerCase().includes(assetFilters.search.toLowerCase()) || e.area.toLowerCase().includes(assetFilters.search.toLowerCase()));
                if (assetFilters.criticidad) filtered = filtered.filter(e => e.criticidad === assetFilters.criticidad);
                if (assetFilters.servicio) filtered = filtered.filter(e => e.servicio === assetFilters.servicio);
            }

            const list = filtered.length === 0 ? '<div style="text-align: center; color: var(--color-text-muted); padding: 2rem;">No se encontraron equipos bajo estos criterios.</div>' :
                filtered.map(e => {
                    const statusColor = e.estado === 'activo' ? 'var(--color-success)' : (e.estado === 'alerta' ? 'var(--color-warning)' : 'var(--color-danger)');
                    const diagnostic = getEquipmentDiagnostic(e);

                    // Diagnosis Tag logic
                    const hasUserDiag = e.diagnostico && e.estado !== 'activo';
                    let diagText = hasUserDiag ? e.diagnostico : diagnostic.label;

                    // Restricción Financiera para Técnicos
                    if (currentRole === 'tecnico' && diagText === 'ALERTA FINANCIERA') {
                        diagText = 'REVISIÓN REQUERIDA'; // Ofuscar alerta financiera
                    }

                    const isUrgent = e.estado === 'peligro' || diagnostic.label.includes('CRÍTICA') || (currentRole === 'admin' && diagnostic.label.includes('FINANCIERA'));

                    return `
                <div class="card" onclick="openDetails(${e.id})" style="border-left: 4px solid ${statusColor}; cursor: pointer; display: flex; gap: 15px; align-items: center; padding: 15px; background: rgba(30, 41, 59, 0.4); transition: transform 0.2s;">
                    ${e.foto ? `<img src="${e.foto}" style="width: 70px; height: 70px; border-radius: 10px; object-fit: cover; border: 2px solid rgba(255,255,255,0.1);">` : `
                        <div style="width: 70px; height: 70px; border-radius: 10px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 1px dashed rgba(255,255,255,0.1);">
                            <span class="material-symbols-rounded" style="font-size: 28px; color: var(--color-text-muted);">precision_manufacturing</span>
                        </div>
                    `}
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <span style="font-size: 0.6rem; background: rgba(59, 130, 246, 0.1); color: var(--color-primary); padding: 2px 8px; border-radius: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">${e.area}</span>
                            ${e.isCritico ? '<span style="font-size: 0.55rem; background: rgba(239, 68, 68, 0.2); color: var(--color-danger); padding: 2px 6px; border-radius: 4px; font-weight: 900; letter-spacing: 1px;">CRÍTICO</span>' : ''}
                        </div>
                        <div style="font-weight: 700; margin-top: 4px; font-size: 1.05rem; color: white;">${e.nombre}</div>
                        
                        <div style="display: flex; align-items: center; gap: 6px; margin-top: 8px;">
                            <div style="display: flex; align-items: center; gap: 4px; background: ${statusColor}22; padding: 4px 10px; border-radius: 20px; border: 1px solid ${statusColor}44;">
                                <span class="material-symbols-rounded" style="font-size: 16px; color: ${statusColor};">${diagnostic.icon}</span>
                                <span style="font-size: 0.7rem; color: ${statusColor}; font-weight: 800; text-transform: uppercase;">${diagText}</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right; min-width: 60px;">
                        <div style="font-size: 1.2rem; font-weight: 900; color: ${e.dispo > 90 ? 'var(--color-success)' : (e.dispo > 75 ? 'var(--color-warning)' : 'var(--color-danger)')};">${e.dispo}%</div>
                        <div style="font-size: 0.55rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase;">Dispo</div>
                    </div>
                </div>
            `;
                }).join('');

            return `
                <div class="view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Panel de Equipos</h3>
                        <div style="display: flex; gap: 10px;">
                            <div class="btn-group" style="background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px; display: flex;">
                                <button onclick="currentAssetView='list'; renderCurrentView()" class="btn" style="padding: 4px 8px; font-size: 0.8rem; background: ${currentAssetView === 'list' ? 'var(--color-primary)' : 'transparent'}; color: ${currentAssetView === 'list' ? 'white' : 'var(--color-text-muted)'}; border-radius: 4px;">
                                    <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle;">list</span> Lista
                                </button>
                                <button onclick="currentAssetView='map'; renderCurrentView()" class="btn" style="padding: 4px 8px; font-size: 0.8rem; background: ${currentAssetView === 'map' ? 'var(--color-primary)' : 'transparent'}; color: ${currentAssetView === 'map' ? 'white' : 'var(--color-text-muted)'}; border-radius: 4px;">
                                    <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle;">map</span> Mapa
                                </button>
                            </div>
                            <button onclick="openModal()" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">+ Nuevo Equipo</button>
                        </div>
                    </div>

                    ${banner}

                    ${currentAssetView === 'list' ? `
                        ${!filterMode ? `
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; margin-bottom: 1.5rem;">
                            <input type="text" id="filter-search" oninput="applyAssetFilters()" value="${assetFilters.search}" class="form-control" placeholder="Buscar..." style="padding: 0.5rem; font-size: 0.75rem;">
                            <select id="filter-criticidad" onchange="applyAssetFilters()" class="form-control" style="font-size: 0.7rem; padding: 4px;">
                                <option value="">Criticidad</option>
                                <option value="AAA" ${assetFilters.criticidad === 'AAA' ? 'selected' : ''}>AAA</option>
                                <option value="AA" ${assetFilters.criticidad === 'AA' ? 'selected' : ''}>AA</option>
                                <option value="A" ${assetFilters.criticidad === 'A' ? 'selected' : ''}>A</option>
                            </select>
                            <select id="filter-servicio" onchange="applyAssetFilters()" class="form-control" style="font-size: 0.7rem; padding: 4px;">
                                <option value="">Servicio</option>
                                <option value="planta" ${assetFilters.servicio === 'planta' ? 'selected' : ''}>Planta</option>
                                <option value="externo" ${assetFilters.servicio === 'externo' ? 'selected' : ''}>Externo</option>
                            </select>
                        </div>` : ''}
                        ${list}
                    ` : `
                        <!-- MAP VIEW RENDERER -->
                        <div style="position: relative; width: 100%; aspect-ratio: 16/9; background: #1e293b; border-radius: 12px; border: 2px solid var(--color-border); overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.5);">
                            <!-- Grid Background -->
                            <div style="position: absolute; inset: 0; background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px; opacity: 0.3;"></div>
                            
                            <!-- Zones overlay (Mockup) -->
                            <div style="position: absolute; top: 10%; left: 10%; width: 30%; height: 40%; border: 1px dashed rgba(255,255,255,0.1); border-radius: 8px;"><span style="position: absolute; top: -15px; left: 0; font-size: 0.6rem; color: var(--color-text-muted);">NAVE INDUSTRIAL A</span></div>
                            <div style="position: absolute; bottom: 10%; right: 10%; width: 25%; height: 35%; border: 1px dashed rgba(255,255,255,0.1); border-radius: 8px;"><span style="position: absolute; top: -15px; left: 0; font-size: 0.6rem; color: var(--color-text-muted);">EXTERIORES / PATIO</span></div>
                            
                            <!-- Dots -->
                            ${equipos.map(e => {
                const x = e.x || Math.random() * 90 + 5; // Fallback if no coord
                const y = e.y || Math.random() * 90 + 5;
                const color = e.estado === 'activo' ? '#10b981' : (e.estado === 'alerta' ? '#f59e0b' : '#ef4444');
                const pulse = e.estado !== 'activo' ? 'animation: pulse-dot 1.5s infinite;' : '';

                return `
                                    <div onclick="openDetails(${e.id})" 
                                         style="position: absolute; left: ${x}%; top: ${y}%; width: 14px; height: 14px; background: ${color}; border-radius: 50%; cursor: pointer; border: 2px solid #0f172a; box-shadow: 0 0 10px ${color}; transform: translate(-50%, -50%); z-index: 10; ${pulse}"
                                         title="${e.nombre} (${e.estado.toUpperCase()})">
                                    </div>
                                    <div style="position: absolute; left: ${x}%; top: ${y}%; transform: translate(-50%, 15px); font-size: 0.5rem; color: white; text-shadow: 0 1px 2px black; white-space: nowrap; pointer-events: none; z-index: 5;">
                                        ${e.nombre.substring(0, 10)}...
                                    </div>
                                `;
            }).join('')}

                            <style>
                                @keyframes pulse-dot {
                                    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
                                    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
                                    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
                                }
                            </style>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 15px; justify-content: center; font-size: 0.7rem; color: var(--color-text-muted);">
                            <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></span> Activo</div>
                            <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></span> Alerta</div>
                            <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span> Peligro</div>
                        </div>
                    `}

                </div>
            `;
        }

        function applyAssetFilters() {
            assetFilters.search = document.getElementById('filter-search').value;
            assetFilters.criticidad = document.getElementById('filter-criticidad').value;
            assetFilters.servicio = document.getElementById('filter-servicio').value;
            navigate('activos');
        }

        function calculateEquipmentKPIs(eq) {
            // MTTR (Mean Time To Repair)
            // Calculado a partir de laborLogs que tengan 'inicio' y 'fin' para la misma OT
            const finishedOTs = ots.filter(o => o.equipoId === eq.id && o.estado === 'completada');
            let totalRepairTime = 0;
            let repairsCount = 0;

            finishedOTs.forEach(ot => {
                const logs = laborLogs.filter(l => l.idOT === ot.id);
                const start = logs.find(l => l.action === 'inicio');
                const end = logs.find(l => l.action === 'fin');

                if (start && end) {
                    const duration = (new Date(end.timestamp) - new Date(start.timestamp)) / (1000 * 60 * 60); // Horas
                    totalRepairTime += duration;
                    repairsCount++;
                } else if (ot.horas) {
                    // Fallback si no hay logs exactos pero sí horas registradas
                    totalRepairTime += ot.horas;
                    repairsCount++;
                }
            });

            const mttr = repairsCount > 0 ? (totalRepairTime / repairsCount).toFixed(1) : 0;

            // MTBF (Mean Time Between Failures)
            // Calculado como el tiempo promedio entre el fin de una OT correctiva y el inicio de la siguiente
            const correctivas = eq.historial ? eq.historial.filter(h => h.tipo === 'no_programado' || h.tipo === 'correctivo').sort((a, b) => new Date(a.fecha) - new Date(b.fecha)) : [];
            let totalUptime = 0;
            let gapsCount = 0;

            for (let i = 0; i < correctivas.length - 1; i++) {
                const endLast = new Date(correctivas[i].fecha);
                const startNext = new Date(correctivas[i + 1].fecha);
                const uptimeDays = (startNext - endLast) / (1000 * 60 * 60 * 24);
                if (uptimeDays > 0) {
                    totalUptime += uptimeDays;
                    gapsCount++;
                }
            }

            const mtbf = gapsCount > 0 ? (totalUptime / gapsCount).toFixed(0) : (correctivas.length > 0 ? 30 : 0); // Fallback 30 días si solo hay una falla

            return { mttr: parseFloat(mttr), mtbf: parseInt(mtbf) };
        }

        function renderKPIIndicator(label, value, unit, min, max, inverse = false) {
            // inverse = true significa que valores bajos son mejores (como MTTR)
            const range = max - min;
            const percent = Math.min(Math.max(((value - min) / range) * 100, 0), 100);

            // Color logic
            let color;
            if (inverse) {
                color = percent < 30 ? 'var(--color-success)' : percent < 70 ? 'var(--color-warning)' : 'var(--color-danger)';
            } else {
                color = percent > 70 ? 'var(--color-success)' : percent > 30 ? 'var(--color-warning)' : 'var(--color-danger)';
            }

            return `
                <div style="flex: 1; min-width: 120px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-size: 0.6rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">${label}</span>
                        <span style="font-size: 0.75rem; font-weight: 900; color: ${color};">${value}${unit}</span>
                    </div>
                    <div style="height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.02);">
                        <div style="position: absolute; left: 0; top: 0; height: 100%; width: 100%; background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%); opacity: 0.15;"></div>
                        <div style="position: absolute; left: 0; top: 0; height: 100%; width: ${percent}%; background: ${color}; box-shadow: 0 0 10px ${color}88; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);"></div>
                    </div>
                </div>
            `;
        }

        function toggleMuroEspecialidad(esp) {
            if (activeMuroEspecialidad === esp) {
                activeMuroEspecialidad = null;
            } else {
                activeMuroEspecialidad = esp;
            }
            renderCurrentView();
        }

        function renderStockCritico() {
            // Filtrar repuestos críticos que NO tengan una OC pendiente o en tránsito
            const criticos = repuestos.filter(r => {
                const tieneOC = ordenesCompra.some(o => o.refId === r.id && o.cat === 'insumo' && (o.estado === 'pendiente' || o.estado === 'transito'));
                return r.stock <= r.critico && !tieneOC;
            });

            if (criticos.length === 0) return '';

            return `
                <div style="margin-top: 2rem;">
                    <h4 style="color: var(--color-warning); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-symbols-rounded">inventory_2</span> Alerta de Stock Crítico (Insumos)
                    </h4>
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; padding: 0;">
                        ${criticos.map(r => `
                            <div class="card" style="border-left: 4px solid var(--color-warning); background: rgba(245, 158, 11, 0.05); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 800; font-size: 0.9rem;">${r.nombre}</div>
                                    <div style="font-size: 0.75rem; color: var(--color-danger); font-weight: 700;">Stock: ${r.stock} ${r.unidad} (Mínimo: ${r.critico})</div>
                                </div>
                                <button onclick="generarOC('insumo', '${r.nombre}', ${r.critico * 2}, ${r.precio}, ${r.id})" class="btn btn-primary" style="font-size: 0.65rem; padding: 5px 10px;">REPONER STOCK</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderOTs() {
            const userOts = ots.filter(o => o.asignadoId === currentUser.id && (o.estado !== 'completada' || o.estado === 'rechazada'));

            if (currentRole === 'admin') {
                const allCompleted = ots.filter(o => o.estado === 'completada' && !o.archivado).reverse();

                return `
                    <div class="view-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Auditoría Integral (Supervisor)</h3>
                            ${allCompleted.length > 1 ? `<button onclick="validarTodo()" class="btn" style="background: var(--color-success); color: white; border: none; font-size: 0.65rem; font-weight: 800; padding: 4px 10px; border-radius: 4px;">VALIDAR TODO (${allCompleted.length})</button>` : ''}
                        </div>
                        <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 1.5rem;">Gestiona los cierres de tu equipo sin interrupciones.</p>
                        
                        ${allCompleted.length === 0 ?
                        '<div class="card" style="text-align: center; color: var(--color-text-muted); padding: 2rem;">No hay tareas pendientes de auditoría en este momento.</div>' :
                        allCompleted.map(o => {
                            const tec = tecnicos.find(t => t.id === o.asignadoId);
                            const hasFeedback = !!o.comentario_tecnico;
                            return `
                                    <div class="card" style="border-left: 4px solid ${hasFeedback ? 'var(--color-primary)' : 'var(--color-success)'};">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                ${tec && tec.foto ?
                                    `<img src="${tec.foto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--color-border);">` :
                                    `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--color-surface-hover); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: var(--color-text-muted); border: 1px solid var(--color-border);">${tec ? tec.nombre.charAt(0) : 'S'}</div>`
                                }
                                                <div>
                                                    <div style="font-weight: 700; font-size: 0.9rem;">${o.titulo}</div>
                                                    <div style="font-size: 0.7rem; color: var(--color-text-muted);">Por: ${tec ? tec.nombre : 'S/A'} | ID: #${o.id}</div>
                                                </div>
                                            </div>
                                            <span style="font-size: 0.55rem; background: rgba(16, 185, 129, 0.1); color: var(--color-success); padding: 2px 6px; border-radius: 4px; font-weight: 800;">${hasFeedback ? 'DIAGNÓSTICO' : 'COMPLETADA'}</span>
                                        </div>
                                        
                                        ${hasFeedback ? `
                                            <div style="background: rgba(59, 130, 246, 0.05); padding: 10px; border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.1); font-size: 0.8rem; margin-bottom: 10px;">
                                                <strong style="color: var(--color-primary); font-size: 0.65rem;">FEEDBACK TÉCNICO:</strong><br>
                                                <span style="font-style: italic;">"${o.comentario_tecnico}"</span>
                                            </div>
                                        ` : `
                                            <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 10px;">Tarea finalizada sin comentarios técnicos adicionales.</div>
                                        `}

                                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                                            <button class="btn btn-primary" style="flex: 2; font-size: 0.7rem; font-weight: bold;" onclick="validarYArchivar(${o.id})">VALIDAR Y ARCHIVAR REPORTE</button>
                                            <button class="btn" style="flex: 1; font-size: 0.7rem; font-weight: bold; background: rgba(239, 68, 68, 0.1); color: var(--color-danger); border: 1px solid var(--color-danger);" onclick="rechazarOT(${o.id})">RECHAZAR</button>
                                        </div>
                                    </div>
                                `;
                        }).join('')
                    }
                    </div>
                `;
            }

            let backlogHtml = `
                <div style="margin-top: 2rem; background: rgba(59, 130, 246, 0.05); padding: 15px; border-radius: 12px; border: 1px dashed var(--color-primary);">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--color-primary); margin-bottom: 12px;">
                        <span class="material-symbols-rounded">rocket_launch</span>
                        <h4 style="margin: 0;">Planificación Sugerida (Preventivos)</h4>
                    </div>
                    ${preventivosBacklog.length === 0 ? '<p style="font-size: 0.7rem; color: #94a3b8;">No hay preventivos pendientes.</p>' : `
                    <p style="font-size: 0.7rem; color: #94a3b8; margin-bottom: 15px;">Tareas preventivas disponibles para adelantar hoy:</p>
                    ${preventivosBacklog.map(p => {
                const eq = equipos.find(e => e.id === p.equipoId);
                const usageInfo = eq ? `<div style="font-size: 0.65rem; color: var(--color-warning); margin-bottom: 5px; font-weight: bold;">Uso: ${eq.horas}h / Frec: ${eq.freq}h</div>` : '';
                const isOverdue = eq && eq.horas >= eq.freq;

                return `
                        <div class="card" style="background: rgba(15, 23, 42, 0.5); border: 1px solid ${isOverdue ? 'var(--color-danger)' : 'rgba(255,255,255,0.05)'}; padding: 10px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="font-weight: 700; font-size: 0.85rem;">${p.titulo}</div>
                                <span style="font-size: 0.55rem; background: rgba(59, 130, 246, 0.1); color: var(--color-primary); padding: 2px 6px; border-radius: 4px; font-weight: 800;">PREVENTIVO</span>
                            </div>
                            <div style="font-size: 0.7rem; color: #64748b; margin: 4px 0;">${p.area} | ${p.descripcion}</div>
                            ${usageInfo}
                            <button onclick="aceptarPreventivo(${p.id})" class="btn btn-primary" style="padding: 4px 10px; font-size: 0.65rem; margin-top: 10px; width: 100%; ${isOverdue ? 'background: var(--color-danger);' : ''}">Aceptar y Comenzar</button>
                        </div>
                    `}).join('')}`}
                </div>
            `;

            const otsHtml = userOts.map(ot => {
                const logs = laborLogs.filter(l => l.idOT === ot.id && l.idTec === currentUser.id);
                const lastLog = logs.length > 0 ? logs[logs.length - 1].action : null;

                let actionsHtml = '';
                let statusBadge = '';

                if (ot.estado === 'levantamiento') {
                    statusBadge = `<span style="font-size: 0.6rem; background: var(--color-warning); color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold;">LEVANTAMIENTO PENDIENTE</span>`;
                    actionsHtml = `
                        <div style="margin-top: 10px;">
                            <button onclick="abrirRegistroFoto(${ot.id}, 'levantamiento')" class="btn btn-primary" style="width: 100%; font-size: 0.75rem; gap: 8px; padding: 12px; font-weight: 800;">
                                <span class="material-symbols-rounded" style="font-size: 20px;">camera_alt</span> REPORTE DE FALLA (LEVANTAMIENTO)
                            </button>
                        </div>`;
                } else if (ot.estado === 'revision') {
                    statusBadge = `<span style="font-size: 0.6rem; background: var(--color-primary); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold;">ESPERANDO APROBACIÓN</span>`;
                    actionsHtml = `<p style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 5px;">Tu levantamiento está siendo revisado por el supervisor.</p>`;
                } else if (ot.estado === 'ejecucion') {
                    statusBadge = `<span style="font-size: 0.6rem; background: var(--color-success); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold;">EN EJECUCIÓN</span>`;
                    if (!lastLog) {
                        actionsHtml = `<button onclick="abrirRegistroFoto(${ot.id}, 'inicio')" class="btn btn-primary" style="padding: 4px 10px; font-size: 0.7rem;">Iniciar Trabajo</button>`;
                    } else if (lastLog === 'inicio') {
                        actionsHtml = `
                            <div style="display: flex; gap: 5px;">
                                <button onclick="logLabor(${ot.id}, 'colacion_inicio')" class="btn" style="padding: 4px 10px; font-size: 0.7rem; background: var(--color-warning); color: black;">Pausa Colación</button>
                                <button onclick="abrirRegistroFoto(${ot.id}, 'fin')" class="btn" style="padding: 4px 10px; font-size: 0.7rem; background: var(--color-danger); color: white;">Finalizar</button>
                            </div>`;
                    } else if (lastLog === 'colacion_inicio') {
                        actionsHtml = `<button onclick="logLabor(${ot.id}, 'colacion_fin')" class="btn btn-success" style="padding: 4px 10px; font-size: 0.7rem;">Retomar Trabajo</button>`;
                    } else if (lastLog === 'colacion_fin') {
                        actionsHtml = `<button onclick="abrirRegistroFoto(${ot.id}, 'fin')" class="btn" style="padding: 4px 10px; font-size: 0.7rem; background: var(--color-danger); color: white;">Finalizar</button>`;
                    }
                } else if (ot.estado === 'rechazada') {
                    statusBadge = `<span style="font-size: 0.6rem; background: var(--color-danger); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; animation: pulse 1s infinite;">¡TRABAJO RECHAZADO!</span>`;
                    actionsHtml = `
                        <div style="margin-top: 10px;">
                            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-danger); border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.8rem;">
                                <strong style="color: var(--color-danger);">OBSERVACIONES DEL SUPERVISOR:</strong><br>
                                <span style="font-style: italic;">"${ot.feedback_supervisor}"</span>
                            </div>
                            <button onclick="abrirRegistroFoto(${ot.id}, 'inicio')" class="btn btn-primary" style="width: 100%; font-size: 0.75rem; font-weight: 800; background: var(--color-danger);">REINTENTAR / CORREGIR TRABAJO</button>
                        </div>`;
                }

                return `
                    <div class="card" style="border-left: 4px solid ${ot.prioridad === 'ALTA' ? 'var(--color-danger)' : 'var(--color-warning)'}; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="color: ${ot.prioridad === 'ALTA' ? 'var(--color-danger)' : 'var(--color-warning)'}; font-size: 0.65rem; font-weight: 800;">${ot.prioridad} PRIORIDAD</div>
                            ${statusBadge}
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center; margin-top: 10px;">
                            ${(function () {
                        const eq = equipos.find(e => e.id === ot.equipoId) || equipos.find(e => e.nombre === ot.titulo || ot.titulo.includes(e.nombre));
                        if (eq && eq.foto) {
                            return `<img src="${eq.foto}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover; border: 1px solid var(--color-border);" title="Referencia: ${eq.nombre}">`;
                        }
                        return `
                                    <div style="width: 50px; height: 50px; border-radius: 6px; background: var(--color-surface-hover); display: flex; align-items: center; justify-content: center;" title="Sin foto de referencia">
                                        <span class="material-symbols-rounded" style="font-size: 20px; color: var(--color-text-muted);">precision_manufacturing</span>
                                    </div>
                                `;
                    })()}
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem;">${ot.titulo}</div>
                                <div style="font-size: 0.8rem; color: #cbd5e1; margin-top: 2px;">${ot.descripcion}</div>
                            </div>
                        </div>
                        ${ot.levantamiento ? `<div style="background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px; border-left: 2px solid var(--color-primary); margin-top: 10px; font-size: 0.75rem; color: #94a3b8;"><strong>Tu Levantamiento:</strong> ${ot.levantamiento}</div>` : ''}
                        
                        ${ot.timerActive ? `
                            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 10px; margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                                <span class="material-symbols-rounded" style="color: var(--color-primary); font-size: 20px; animation: pulse 2s infinite;">timer</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.65rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase;">Cronómetro Activo</div>
                                    <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 2px;">Tiempo acumulado: ${(ot.totalHH || 0).toFixed(2)} hrs</div>
                                </div>
                                <button onclick="stopOTTimer(${ot.id})" class="btn" style="padding: 6px 12px; font-size: 0.65rem; background: var(--color-danger); color: white;">
                                    <span class="material-symbols-rounded" style="font-size: 14px; vertical-align: middle;">stop</span> Detener
                                </button>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <span style="font-size: 0.65rem; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;">OPEX</span>
                                ${ot.estado === 'ejecucion' && !ot.timerActive ? `
                                    <button onclick="startOTTimer(${ot.id})" class="btn" style="padding: 4px 8px; font-size: 0.6rem; background: rgba(59, 130, 246, 0.2); color: var(--color-primary); border: 1px solid rgba(59, 130, 246, 0.3);">
                                        <span class="material-symbols-rounded" style="font-size: 12px; vertical-align: middle;">play_arrow</span> Iniciar Timer
                                    </button>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${ot.estado === 'ejecucion' && !ot.kitValidado ?
                        `<button onclick="abrirAuditoriaSeguridad(${ot.id})" class="btn btn-primary" style="width:100%; padding: 12px; font-size: 0.8rem; display: flex; align-items: center; justify-content:center; gap: 8px; font-weight: 800; background: linear-gradient(135deg, var(--color-warning), #d97706); color: black;">
                                        <span class="material-symbols-rounded" style="font-size: 20px;">verified_user</span> AUDITORÍA DE SEGURIDAD
                                    </button>` :
                        actionsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Tus Tareas</h3>
                        ${currentUser.isTitular ? '<span style="background: var(--color-danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.6rem; font-weight: 800;">TITULAR DE TURNO</span>' : ''}
                    </div>
                    ${otsHtml}
                    ${backlogHtml}
                </div>
            `;
        }

        function aceptarPreventivo(id) {
            const idx = preventivosBacklog.findIndex(p => p.id === id);
            if (idx !== -1) {
                const prev = preventivosBacklog[idx];
                const newOT = {
                    id: Date.now(),
                    preventivoId: prev.id,
                    equipoId: prev.equipoId,
                    titulo: prev.titulo,
                    descripcion: prev.descripcion,
                    area: prev.area,
                    prioridad: "MEDIA",
                    estado: "ejecucion",
                    kitValidado: false,
                    asignadoId: currentUser.id
                };
                ots.push(newOT);

                // Consumir la tarea del backlog
                preventivosBacklog.splice(idx, 1);

                persist();
                navigate('ots');

                setTimeout(() => abrirCheckinKit(newOT.id, prev.id), 100);
            }
        }

        function abrirAuditoriaSeguridad(otId) {
            const content = document.getElementById('auditoria-content');

            let html = `
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: var(--color-primary); font-size: 0.7rem; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 5px;">
                        <span class="material-symbols-rounded" style="font-size: 16px;">handyman</span> Herramientas Técnicas
                    </h5>
                    ${defaultHerramientas.map(h => renderAuditItem(h, 'tool')).join('')}
                </div>
                <div style="margin-top: 1.5rem;">
                    <h5 style="color: var(--color-danger); font-size: 0.7rem; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 5px;">
                        <span class="material-symbols-rounded" style="font-size: 16px;">shield</span> Equipo de Protección (EPP)
                    </h5>
                    ${defaultEPP.map(e => renderAuditItem(e, 'epp')).join('')}
                </div>
            `;

            content.innerHTML = html;
            document.getElementById('audit-suggestion').value = "";
            document.getElementById('btn-confirmar-auditoria').onclick = () => confirmarAuditoria(otId);
            document.getElementById('modal-auditoria').style.display = 'flex';
        }

        function renderAuditItem(item, type) {
            const id = `${type}-${item.id}`;
            return `
                <div class="audit-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.8rem; font-weight: 500;">${item.nombre}</div>
                    <div style="display: flex; gap: 4px;" id="group-${id}">
                        <button onclick="setAuditStatus('${id}', 'operativo')" class="btn-st active" id="st-${id}-operativo" title="Operativo">🟢</button>
                        <button onclick="setAuditStatus('${id}', 'desgaste')" class="btn-st" id="st-${id}-desgaste" title="Desgaste">🟡</button>
                        <button onclick="setAuditStatus('${id}', 'daniado')" class="btn-st" id="st-${id}-daniado" title="Dañado">🔴</button>
                        <input type="hidden" id="val-${id}" value="operativo">
                    </div>
                </div>
            `;
        }

        function setAuditStatus(id, status) {
            // UI reset
            document.querySelectorAll(`#group-${id} .btn-st`).forEach(b => {
                b.style.background = 'transparent';
                b.style.borderColor = 'rgba(255,255,255,0.1)';
            });

            const btn = document.getElementById(`st-${id}-${status}`);
            const input = document.getElementById(`val-${id}`);
            input.value = status;

            // Highlight
            const colors = { operativo: 'var(--color-success)', desgaste: 'var(--color-warning)', daniado: 'var(--color-danger)' };
            btn.style.background = `rgba(255,255,255,0.1)`;
            btn.style.borderColor = colors[status];
            btn.style.borderWidth = '2px';
        }

        function closeModalAuditoria() {
            document.getElementById('modal-auditoria').style.display = 'none';
        }

        function confirmarAuditoria(otId) {
            const suggestion = document.getElementById('audit-suggestion').value;
            const ot = ots.find(o => o.id === otId);

            if (ot) {
                // Registrar hallazgos críticos (Dañados)
                const items = [...defaultHerramientas.map(h => ({ ...h, type: 'tool' })), ...defaultEPP.map(e => ({ ...e, type: 'epp' }))];
                items.forEach(item => {
                    const status = document.getElementById(`val-${item.type}-${item.id}`).value;
                    if (status !== 'operativo') {
                        toolLogs.push({
                            tecnico: currentUser.nombre,
                            itemId: item.id,
                            tipo: item.type,
                            nombre: item.nombre,
                            estado: status,
                            fecha: new Date().toISOString()
                        });
                    }
                });

                if (suggestion) {
                    toolSuggestions.push({
                        tecnico: currentUser.nombre,
                        sugerencia: suggestion,
                        fecha: new Date().toISOString()
                    });
                }

                ot.kitValidado = true;
                persist();
                closeModalAuditoria();
                logLabor(otId, 'inicio');
            }
        }

        function enviarLevantamiento(id) {
            const val = document.getElementById(`levantamiento-${id}`).value;
            if (!val) return alert("Por favor describe lo que encontraste.");

            const ot = ots.find(o => o.id === id);
            if (ot) {
                ot.levantamiento = val;
                ot.estado = 'revision';
                persist();
                navigate('ots');
            }
        }

        function approveLevantamiento(id) {
            const ot = ots.find(o => o.id === id);
            if (!ot) return;

            const finalDesc = document.getElementById(`final-desc-${id}`).value;
            ot.descripcion = finalDesc;
            ot.estado = 'ejecucion';
            ot.prioridad = 'ALTA';

            persist();
            // No alert for faster flow
            renderCurrentView();
        }

        function validarYArchivar(otId) {
            const ot = ots.find(o => o.id === otId);
            if (!ot) return;

            ot.archivado = true;
            ot.validadoPor = currentUser.nombre;
            ot.fechaValidacion = new Date().toISOString();

            persist();
            // No alert, just refresh UI
            renderCurrentView();
        }

        function validarTodo() {
            const pending = ots.filter(o => o.estado === 'completada' && !o.archivado);
            pending.forEach(ot => {
                ot.archivado = true;
                ot.validadoPor = currentUser.nombre;
                ot.fechaValidacion = new Date().toISOString();
            });
            persist();
            renderCurrentView();
        }

        function logLabor(idOT, action) {
            laborLogs.push({
                idOT: idOT,
                idTec: currentUser.id,
                action: action,
                timestamp: new Date().toISOString()
            });

            const ot = ots.find(o => o.id === idOT);
            if (ot && action === 'fin') {
                ot.estado = 'completada';

                // --- INTEGRAR A LA HOJA DE VIDA DEL EQUIPO ---
                // Buscamos si es un preventivo o correctivo para hallar el equipo
                let eq = equipos.find(e => e.nombre === ot.titulo || ot.titulo.includes(e.nombre));
                // Si no lo encontramos por nombre, buscaremos por área (simplificado para demo)
                if (!eq) eq = equipos[0];

                if (eq) {
                    if (!eq.historial) eq.historial = [];
                    eq.historial.unshift({
                        fecha: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }).toUpperCase(),
                        tarea: ot.titulo,
                        tecnico: currentUser.nombre,
                        especialidad: currentUser.especialidad || 'Técnico',
                        efectividad: 100,
                        origen: currentUser.origen || 'planta',
                        desc: ot.condiciones_finales || ot.descripcion,
                        comentario_tecnico: ot.comentario_tecnico,
                        foto_inicio: ot.foto_inicio,
                        foto_fin: ot.foto_fin,
                        costo: ot.costo_materiales || 0
                    });

                    // Sumar al costo de mantenimiento acumulado del equipo
                    eq.costoMantAcumulado = (eq.costoMantAcumulado || 0) + (ot.costo_materiales || 0);

                    // Simular mejora de disponibilidad tras mantenimiento
                    eq.dispo = Math.min(100, eq.dispo + 5);
                    if (!eq.dispo_history) eq.dispo_history = [85, 88, 82, 90, 88, 93];
                    eq.dispo_history.push(eq.dispo);
                }
            }
            persist();
            navigate('ots');
        }

        function logManagementAction(action, detail, icon = 'info') {
            managementLogs.unshift({
                id: Date.now(),
                action,
                detail,
                icon,
                timestamp: new Date().toISOString()
            });
            // Opcional: Limitar tamaño del log para no saturar LocalStorage
            if (managementLogs.length > 50) managementLogs.pop();
            persist();
        }

        function renderManagementLog() {
            const today = new Date().toISOString().split('T')[0];
            const logsToday = managementLogs.filter(l => l.timestamp.startsWith(today));
            const count = logsToday.length;

            const target = 5;
            const progress = Math.min((count / target) * 100, 100);

            return `
                <div style="margin-top: 2.5rem; border-top: 1px solid rgba(255,255,255,0.06); padding-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; font-weight: 800; letter-spacing: 0.2px; color: var(--color-text-main);">
                            <span class="material-symbols-rounded" style="color: var(--color-primary); font-size: 24px;">history_edu</span> 
                            Bitácora de Gestión Diaria
                        </h4>
                        <div style="font-size: 0.75rem; font-weight: 900; color: var(--color-text-muted); letter-spacing: 1px; text-transform: uppercase;">
                            Progreso: <span style="color: var(--color-primary);">${count}</span> / ${target}
                        </div>
                    </div>
                    
                    <div style="height: 8px; background: rgba(255,255,255,0.04); border-radius: 4px; margin-bottom: 25px; overflow: hidden; border: 1px solid rgba(255,255,255,0.02);">
                        <div style="width: ${progress}%; height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-accent)); transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);"></div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 12px; max-height: 350px; overflow-y: auto; padding-right: 10px;" class="custom-scrollbar">
                        ${count === 0 ? `
                            <div class="card" style="text-align: center; color: var(--color-text-muted); font-size: 0.85rem; padding: 40px; border: 1px dashed rgba(255,255,255,0.08); background: transparent;">
                                <span class="material-symbols-rounded" style="font-size: 32px; display: block; margin-bottom: 10px; opacity: 0.5;">ink_pen</span>
                                No has registrado acciones de gestión hoy.
                            </div>
                        ` : logsToday.map(l => `
                            <div class="card" style="margin-bottom: 0; padding: 14px 20px; display: flex; align-items: center; gap: 18px; background: rgba(59, 130, 246, 0.04); border: 1px solid rgba(59, 130, 246, 0.1); cursor: pointer; transition: all 0.2s ease;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(59, 130, 246, 0.12); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <span class="material-symbols-rounded" style="font-size: 22px; color: var(--color-primary);">${l.icon}</span>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <span style="font-size: 0.75rem; font-weight: 900; color: var(--color-primary); letter-spacing: 0.5px; text-transform: uppercase;">${l.action}</span>
                                        <span style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 700;">${new Date(l.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                    </div>
                                    <div style="font-size: 0.85rem; color: #e2e8f0; line-height: 1.5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${l.detail}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderMuroControl() {
            // Obtener SOS activos
            const sosActivos = (JSON.parse(localStorage.getItem('cmms_global_sos')) || []).filter(s => s.active);
            const alertaVigente = JSON.parse(localStorage.getItem('cmms_alert'));

            // Calcular matriz de salud regional (disponibilidad por especialidad)
            const especialidades = ['Clima', 'Electricidad', 'Mecánica', 'Hidráulica', 'Infraestructura'];
            const saludMatriz = especialidades.map(esp => {
                const eqEsp = equipos.filter(e => (e.especialidad || '').toLowerCase() === esp.toLowerCase());
                const total = eqEsp.length;
                const ok = eqEsp.filter(e => e.estado === 'activo').length;
                const porc = total > 0 ? Math.round((ok / total) * 100) : 100;
                return { esp, total, ok, porc };
            });

            // Obtener Feed de campo (últimas fotos y logs de labor)
            const recentLabor = laborLogs.slice(-10).reverse();

            return `
                <div class="view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.75rem; font-weight: 900; letter-spacing: -0.8px; color: white; display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <span class="material-symbols-rounded" style="color: var(--color-primary); font-size: 32px;">analytics</span>
                                Muro de Control de Operaciones
                            </h3>
                            <p style="font-size: 0.9rem; color: var(--color-text-muted); margin-top: 8px; line-height: 1.6; font-weight: 500;">Visión ejecutiva de salud de activos y despliegue de campo en tiempo real.</p>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 8px 20px; border-radius: 30px; border: 1px solid rgba(16, 185, 129, 0.3); font-size: 0.75rem; color: var(--color-success); font-weight: 900; letter-spacing: 1px; text-transform: uppercase;">
                            ● Sistema Nominal
                        </div>
                    </div>

                    <!-- MATRIZ DE SALUD POR ESPECIALIDAD -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 20px; margin-bottom: 2.5rem;">
                        ${saludMatriz.map(s => {
                const color = s.porc > 85 ? 'var(--color-success)' : s.porc > 65 ? 'var(--color-warning)' : 'var(--color-danger)';
                const isActive = activeMuroEspecialidad === s.esp;
                return `
                                <div class="card" onclick="toggleMuroEspecialidad('${s.esp}')" style="margin-bottom: 0; padding: 24px; border-top: 5px solid ${color}; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); background: ${isActive ? 'rgba(59, 130, 246, 0.15)' : 'linear-gradient(180deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8))'}; border: ${isActive ? '2px solid var(--color-primary)' : '1px solid rgba(255,255,255,0.05)'}; transform: ${isActive ? 'scale(1.02)' : 'scale(1)'};">
                                    <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 900; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 15px; display: flex; justify-content: space-between;">
                                        ${s.esp}
                                        ${isActive ? '<span class="material-symbols-rounded" style="font-size: 16px; color: var(--color-primary);">expand_less</span>' : ''}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                        <span style="font-size: 2.2rem; font-weight: 900; color: white; line-height: 1; letter-spacing: -1px;">${s.porc}%</span>
                                        <div style="text-align: right;">
                                            <div style="font-size: 0.75rem; color: white; font-weight: 800;">${s.ok}/${s.total}</div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted); font-weight: 700; text-transform: uppercase;">Activos UP</div>
                                        </div>
                                    </div>
                                    <div style="height: 6px; background: rgba(255,255,255,0.03); border-radius: 3px; margin-top: 18px; overflow: hidden; border: 1px solid rgba(255,255,255,0.02);">
                                        <div style="width: ${s.porc}%; height: 100%; background: ${color}; box-shadow: 0 0 15px ${color}66; transition: width 1s ease;"></div>
                                    </div>
                                </div>
                            `;
            }).join('')}
                    </div>

                    <!-- DRILL-DOWN LIST (Specialty Assets) -->
                    ${activeMuroEspecialidad ? `
                        <div id="muro-drilldown" style="margin-bottom: 3.5rem; animation: slideDown 0.3s ease-out;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h4 style="margin: 0; color: var(--color-primary); font-weight: 800; display: flex; align-items: center; gap: 10px;">
                                    <span class="material-symbols-rounded">category</span> 
                                    Detalle de Activos: ${activeMuroEspecialidad.toUpperCase()}
                                </h4>
                                <button onclick="toggleMuroEspecialidad(null)" class="btn" style="font-size: 0.7rem; color: var(--color-text-muted); padding: 5px 10px;">Cerrar Detalle</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                                ${equipos.filter(e => (e.especialidad || '').toLowerCase() === activeMuroEspecialidad.toLowerCase()).map(e => {
                const diag = getEquipmentDiagnostic(e);
                const kpis = calculateEquipmentKPIs(e);
                const statusColor = e.estado === 'activo' ? 'var(--color-success)' : (e.estado === 'alerta' ? 'var(--color-warning)' : 'var(--color-danger)');
                return `
                                        <div class="card" onclick="openDetails(${e.id})" style="margin-bottom: 0; padding: 20px; border-left: 4px solid ${statusColor}; cursor: pointer; display: flex; flex-direction: column; gap: 15px; background: rgba(30, 41, 59, 0.4); transition: transform 0.2s;">
                                            <div style="display: flex; align-items: center; gap: 15px;">
                                                <div style="width: 45px; height: 45px; border-radius: 8px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;">
                                                    <span class="material-symbols-rounded" style="color: ${statusColor}; font-size: 24px;">${diag.icon}</span>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 1rem; font-weight: 800; color: white;">${e.nombre}</div>
                                                    <div style="font-size: 0.75rem; color: var(--color-text-muted); font-weight: 500;">${e.area} | ${diag.label}</div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 1.2rem; font-weight: 900; color: white;">${e.dispo}%</div>
                                                    <div style="font-size: 0.6rem; color: var(--color-text-muted); text-transform: uppercase; font-weight: 800;">Dispo</div>
                                                </div>
                                            </div>
                                            
                                            <!-- KPI THERMOMETERS -->
                                            <div style="display: flex; gap: 20px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
                                                ${renderKPIIndicator('MTTR (Reparación)', kpis.mttr, 'h', 0, 12, true)}
                                                ${renderKPIIndicator('MTBF (Confiabilidad)', kpis.mtbf, 'd', 0, 60, false)}
                                            </div>
                                        </div>
                                    `;
            }).join('')}
                            </div>
                        </div>
                        <style>
                            @keyframes slideDown {
                                from { opacity: 0; transform: translateY(-10px); }
                                to { opacity: 1; transform: translateY(0); }
                            }
                        </style>
                    ` : ''}

                    <div style="display: grid; grid-template-columns: 1fr 380px; gap: 40px;">
                        <!-- FEED DE CAMPO -->
                        <div>
                            <h4 style="margin-bottom: 25px; display: flex; align-items: center; gap: 12px; font-size: 1.2rem; font-weight: 800; letter-spacing: 0.2px; cursor: pointer;">
                                <span class="material-symbols-rounded" style="color: var(--color-primary); font-size: 28px;">engineering</span> 
                                Actividad de Campo en Tiempo Real
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                ${recentLabor.length === 0 ? `
                                    <div class="card" style="text-align: center; color: var(--color-text-muted); padding: 60px; border: 1px dashed rgba(255,255,255,0.08); background: transparent;">
                                        Sin actividad reportada en las últimas horas.
                                    </div>
                                ` : recentLabor.map(log => {
                const tec = tecnicos.find(t => t.id === log.idTec);
                const ot = ots.find(o => o.id === log.idOT);
                const icon = log.action === 'inicio' ? 'play_circle' : log.action === 'fin' ? 'check_circle' : 'pending';
                const color = log.action === 'inicio' ? 'var(--color-primary)' : log.action === 'fin' ? 'var(--color-success)' : 'var(--color-warning)';

                return `
                                        <div class="card" onclick="renderDetalleTecnico(${log.idTec})" style="margin-bottom: 0; padding: 20px; display: flex; gap: 20px; border-left: 6px solid ${color}; cursor: pointer; transition: all 0.2s ease;">
                                            <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.05);">
                                                <span class="material-symbols-rounded" style="color: ${color}; font-size: 30px;">${icon}</span>
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                                    <span style="font-size: 1rem; font-weight: 800; color: white;">${tec ? tec.nombre : 'Operador'}</span>
                                                    <span style="font-size: 0.7rem; color: var(--color-text-muted); font-weight: 700;">${new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                                </div>
                                                <div style="font-size: 0.85rem; color: #94a3b8; line-height: 1.5; margin-bottom: 8px;">
                                                    ${log.action.replace('_', ' ').toUpperCase()}: <strong style="color: white; font-weight: 700;">${ot ? ot.titulo : 'OT #' + log.idOT}</strong>
                                                </div>
                                                ${log.comment ? `<div style="font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); color: #cbd5e1; font-style: italic; line-height: 1.4;">"${log.comment}"</div>` : ''}
                                            </div>
                                        </div>
                                    `;
            }).join('')}
                            </div>
                        </div>

                        <!-- ALERTAS Y SOS -->
                        <div>
                            <h4 style="margin-bottom: 25px; display: flex; align-items: center; gap: 12px; font-size: 1.2rem; font-weight: 800; color: var(--color-danger); cursor: pointer;">
                                <span class="material-symbols-rounded" style="font-size: 28px;">minor_crash</span> 
                                Centro de Crisis y Emergencias
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                ${alertaVigente ? `
                                    <div class="card" onclick="navigate('activos', 'alertas')" style="background: rgba(220, 38, 38, 0.12); border: 1px solid rgba(239, 68, 68, 0.3); border-left: 6px solid var(--color-danger); margin-bottom: 10px; animation: glow-red 1.5s infinite; cursor: pointer; padding: 20px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <div style="font-size: 0.75rem; font-weight: 900; color: var(--color-danger); text-transform: uppercase; letter-spacing: 1.5px;">🚨 Alerta Crítica</div>
                                            <span style="font-size: 0.65rem; color: #ef4444; font-weight: 800;">ACTIVA</span>
                                        </div>
                                        <div style="font-size: 1.05rem; font-weight: 800; color: white; line-height: 1.5;">${alertaVigente.mensaje}</div>
                                        <div style="font-size: 0.7rem; color: #fca5a5; margin-top: 15px; font-weight: 700; opacity: 0.8; text-transform: uppercase;">Hace ${Math.round((Date.now() - alertaVigente.timestamp) / 60000)} minutos</div>
                                    </div>
                                ` : ''}

                                ${sosActivos.length === 0 && !alertaVigente ? `
                                    <div class="card" style="background: rgba(16, 185, 129, 0.05); border: 1px dashed rgba(16, 185, 129, 0.2); text-align: center; padding: 40px; border-radius: 16px;">
                                        <div style="width: 50px; height: 50px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                                            <span class="material-symbols-rounded" style="color: var(--color-success); font-size: 30px;">verified</span>
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--color-success); font-weight: 900; letter-spacing: 0.8px; text-transform: uppercase;">Zona Nominal</div>
                                        <div style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 8px; line-height: 1.5;">No se detectan emergencias activas en el perímetro.</div>
                                    </div>
                                ` : sosActivos.map(s => `
                                    <div class="card" style="background: rgba(220, 38, 38, 0.08); border-left: 6px solid var(--color-danger); margin-bottom: 0; padding: 20px; cursor: pointer; border: 1px solid rgba(239, 68, 68, 0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="font-size: 0.75rem; color: var(--color-danger); font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px;">SOS: ${s.type}</div>
                                            <span class="material-symbols-rounded" style="color: var(--color-danger); font-size: 18px;">priority_high</span>
                                        </div>
                                        <div style="font-size: 1rem; font-weight: 800; color: white;">${s.loc}</div>
                                        <div style="font-size: 0.85rem; color: #cbd5e1; margin-top: 10px; line-height: 1.5; font-style: italic; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px;">"${s.msg}"</div>
                                        <div style="font-size: 0.65rem; color: var(--color-text-muted); margin-top: 15px; font-weight: 700;">REGISTRADO: ${new Date(s.timestamp).toLocaleTimeString()}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="card" style="margin-top: 2.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(30, 41, 59, 0.4)); border: 1px solid rgba(59, 130, 246, 0.15); padding: 25px; cursor: pointer;">
                                <div style="font-size: 0.8rem; font-weight: 900; color: var(--color-primary); margin-bottom: 20px; letter-spacing: 1px; text-transform: uppercase;">Estado de Fuerza Operativa</div>
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--color-text-muted); font-size: 0.9rem; font-weight: 500;">Técnicos Desplegados:</span>
                                        <span style="font-weight: 900; color: white; font-size: 1.1rem;">${tecnicos.length}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="color: var(--color-text-muted); font-size: 0.9rem; font-weight: 500;">Carga Operativa Total:</span>
                                        <span style="font-weight: 900; color: white; font-size: 1.1rem;">${ots.filter(o => o.estado !== 'completada').length} OT's</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReportes() {
            if (currentRole === 'tecnico') return `<div class="view-content"><h3>Restringido</h3><p>Solo personal administrativo puede ver reportes y finanzas.</p></div>`;

            const supervisiónHtml = tecnicos.map(t => {
                const logs = laborLogs.filter(l => l.idTec === t.id);
                const totalHoras = calculateTotalHours(logs);
                const turnoHoras = 9;
                const extra = Math.max(0, totalHoras - turnoHoras);

                const lastLog = logs.length > 0 ? logs[logs.length - 1] : null;
                const statusLabel = lastLog ? lastLog.action.replace(/_/g, ' ').toUpperCase() : 'SIN ACTIVIDAD';
                const statusColor = lastLog ? (lastLog.action === 'fin' ? 'var(--color-success)' : 'var(--color-warning)') : 'var(--color-text-muted)';

                // Detalle de actividad reciente
                const activityHtml = logs.slice(-3).reverse().map(l => `
                    <div style="font-size: 0.6rem; color: var(--color-text-muted); display: flex; justify-content: space-between; margin-top: 2px;">
                        <span>${l.action.replace(/_/g, ' ')}</span>
                        <span>${new Date(l.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                `).join('');

                return `
                    <div class="card" style="margin-bottom: 0.8rem; padding: 1rem; border-left: 4px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; display: flex; gap: 12px; align-items: flex-start;">
                                ${t.foto ?
                        `<img src="${t.foto}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--color-border); margin-top: 4px;">` :
                        `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-surface-hover); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: var(--color-text-muted); border: 1px solid var(--color-border); margin-top: 4px;">${t.nombre.charAt(0)}</div>`
                    }
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; font-size: 1rem; color: white;">${t.nombre}</div>
                                    <div style="font-size: 0.75rem; color: ${statusColor}; font-weight: 800; margin-top: 2px;">● ${statusLabel}</div>
                                    <div style="margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 5px;">
                                        ${activityHtml || '<div style="font-size: 0.6rem;">No hay registros hoy</div>'}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px;">
                                <div style="font-size: 0.9rem; font-weight: 800; color: var(--color-primary);">${totalHoras.toFixed(2)}h</div>
                                <div style="font-size: 0.55rem; color: var(--color-text-muted); text-transform: uppercase;">Laborales</div>
                                <div style="font-size: 0.75rem; font-weight: 700; color: ${extra > 0 ? 'var(--color-danger)' : 'var(--color-success)'}; margin-top: 4px;">
                                    +${extra.toFixed(2)}h Extra
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="view-content">
                    <h3>Supervisión de Productividad</h3>
                    <p style="font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 1rem;">Comparativa de labor reportada vs turnos asignados.</p>
                    ${supervisiónHtml}
                    
                    <h3 style="margin-top: 2rem;">Reportes Gerenciales</h3>
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="card">
                            <h4 style="margin-bottom: 10px; color: var(--color-primary); display: flex; align-items: center; gap: 8px;">
                                <span class="material-symbols-rounded">verified</span> Calidad Semanal
                            </h4>
                            <p style="font-size: 0.75rem; color: var(--color-text-muted); min-height: 40px;">Métricas de reincidencia y cumplimiento de tiempos históricos.</p>
                            <button onclick="downloadQualityReport()" class="btn btn-primary" style="width: 100%; margin-top: 10px; font-weight: 700;">
                                <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: bottom;">download</span> Generar PDF Calidad
                            </button>
                        </div>

                    </div>
                    
                    <h3 style="margin-top: 2rem;">Competición y Liderazgo</h3>
                    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
                         <div class="card">
                            <h4 style="margin-bottom: 10px; color: var(--color-primary);">Cierres por Técnico (Hoy)</h4>
                            <div style="height: 200px;">
                                <canvas id="chart-performance"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h4 style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                <span style="color: gold;">🏆</span> Ranking Mensual (Empleado del Mes)
                            </h4>
                            <div style="height: 200px;">
                                <canvas id="chart-monthly-leaders"></canvas>
                            </div>
                        </div>
                    </div>

                    </div>

                    <!-- MONTHLY CLOSURE SECTION -->
                    <div class="card" style="margin-top: 2.5rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(30, 41, 59, 0.5)); border: 2px solid var(--color-danger); padding: 28px;">
                        <h3 style="margin-bottom: 15px; color: var(--color-danger); display: flex; align-items: center; gap: 12px; font-size: 1.3rem;">
                            <span class="material-symbols-rounded" style="font-size: 32px;">archive</span> Cierre de Mes
                        </h3>
                        <p style="font-size: 0.9rem; color: var(--color-text-muted); line-height: 1.7; margin-bottom: 22px;">
                            Genera un reporte maestro completo del período y libera espacio en la nube eliminando fotos y archivando OTs completadas. 
                            <strong style="color: var(--color-warning);">Esta acción es irreversible.</strong>
                        </p>
                        <button onclick="ejecutarCierreMensual()" class="btn" style="width: 100%; background: var(--color-danger); color: white; font-weight: 800; font-size: 1.05rem; padding: 18px; border: none; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                            <span class="material-symbols-rounded" style="font-size: 22px; vertical-align: middle; margin-right: 10px;">download</span>
                            EXPORTAR Y CERRAR MES
                        </button>
                    </div>

                    <div style="margin-top: 1rem; text-align: right;">


                    <div style="margin-top: 1rem; text-align: right;">
                        <button class="btn" style="font-size: 0.7rem; color: var(--color-text-muted); text-decoration: underline;" onclick="alert('Funcionalidad de exportación CSV en desarrollo.')">
                            <span class="material-symbols-rounded" style="font-size: 14px; vertical-align: middle;">table_view</span> Exportar Data Raw (CSV / Excel)
                        </button>
                    </div>

                </div>
            `;
        }

        function calculateTotalHours(logs) {
            if (logs.length < 2) return 0;
            let totalMs = 0;
            let start = null;
            let colStart = null;
            let colTotal = 0;

            logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            logs.forEach(l => {
                if (l.action === 'inicio') start = new Date(l.timestamp);
                if (l.action === 'colacion_inicio') colStart = new Date(l.timestamp);
                if (l.action === 'colacion_fin' && colStart) {
                    colTotal += (new Date(l.timestamp) - colStart);
                    colStart = null;
                }
                if (l.action === 'fin' && start) {
                    totalMs += (new Date(l.timestamp) - start);
                    start = null;
                }
            });

            // Si aún está trabajando...
            if (start) {
                totalMs += (new Date() - start);
            }
            // Descontar colación
            return (totalMs - colTotal) / (1000 * 60 * 60);
        }

        // Nueva función para detectar al "Bombero" del turno (Más reactivo)
        function getLiderReactiveTurno() {
            // 1. Obtener OTs de hoy que sean Correctivas o Alta Prioridad
            const today = new Date().toISOString().split('T')[0];
            const reactiveOTs = ots.filter(o =>
                (o.tipo === 'correctivo' || o.tipo === 'reactivo' || o.prioridad === 'ALTA' || o.prioridad === 'URGENTE') &&
                (o.fechaCreacion && o.fechaCreacion.startsWith(today))
            );

            // 2. Contar por técnico
            const counts = {};
            reactiveOTs.forEach(o => {
                if (!o.asignadoId) return;
                counts[o.asignadoId] = (counts[o.asignadoId] || 0) + 1;
            });

            // 3. Encontrar el máximo
            let maxId = null;
            let maxCount = -1;
            for (const [id, count] of Object.entries(counts)) {
                if (count > maxCount) {
                    maxCount = count;
                    maxId = parseInt(id);
                }
            }

            // Si nadie tiene OTs hoy, fallback al titular
            if (!maxId && tecnicos.length > 0) return tecnicos.find(t => t.isTitular)?.id || tecnicos[0].id;
            return maxId;
        }

        function renderPersonal() {
            if (currentRole === 'tecnico') return `<div class="view-content"><h3>Restringido</h3><p>Solo administradores pueden gestionar el personal.</p></div>`;

            const liderId = getLiderReactiveTurno(); // Detectar quién está "apagando incendios" hoy

            const list = tecnicos.length === 0 ? '<div style="text-align: center; color: var(--color-text-muted); padding: 2rem;">No hay personal registrado.</div>' :
                tecnicos.map(t => {
                    const isLider = (t.id === liderId);
                    const ringColor = isLider ? '#fbbf24' : (t.origen === 'planta' ? 'var(--color-primary)' : 'var(--color-warning)');
                    const glowStyle = isLider ? 'box-shadow: 0 0 15px rgba(251, 191, 36, 0.4); border-color: #fbbf24;' : (t.isTitular ? 'border-color: #f87171;' : 'border-color: transparent;');

                    const avatar = t.foto ?
                        `<img src="${t.foto}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid ${ringColor};">` :
                        `<div style="width: 40px; height: 40px; border-radius: 50%; background: ${ringColor}; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">${t.nombre.charAt(0)}</div>`;

                    return `
                <div class="card" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem; padding: 0.8rem; border: 1px solid transparent; ${glowStyle}">
                    ${avatar}
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;">
                            ${t.nombre}
                            ${isLider ? '<span style="background: #fbbf24; color: black; font-size: 0.5rem; padding: 2px 6px; border-radius: 8px; font-weight:800;">🔥 EN TURNO</span>' : ''}
                            ${t.isTitular ? '<span style="background: #f87171; color: white; font-size: 0.5rem; padding: 2px 5px; border-radius: 4px;">TITULAR</span>' : ''}
                        </div>
                        <div style="font-size: 0.7rem; color: var(--color-text-muted);">${t.especialidad} | ${t.userCode}</div>
                        <div style="font-size: 0.65rem; color: var(--color-primary); margin-top: 2px;">
                            Turno: ${t.turno ? t.turno.inicio : '08:00'} a ${t.turno ? t.turno.fin : '18:00'}
                            (${t.turno ? t.turno.colacion : 60} min col.)
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.85rem; font-weight: 700; color: ${t.eficacia > 90 ? 'var(--color-success)' : 'var(--color-warning)'};">${t.eficacia}%</div>
                        <div style="font-size: 0.6rem; color: var(--color-text-muted);">Eficacia</div>
                    </div>
                    <button onclick="editTecnico(${t.id})" class="btn" style="padding: 5px;"><span class="material-symbols-rounded" style="font-size: 18px;">edit</span></button>
                </div>
            `;
                }).join('');

            return `
                <div class="view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Gestión de Personal</h3>
                        <button onclick="openModalTecnico()" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">+ Nuevo Técnico</button>
                    </div>
                    ${list}
                </div>
            `;
        }

        // --- GANTT CHART MODULE ---
        function renderGantt() {
            // 1. Filter Scheduled Tasks
            const scheduled = ots.filter(o => o.tipo === 'programado' || o.tipo === 'preventivo');

            // Ensure we have some future tasks for demo purposes
            if (scheduled.length < 3) {
                // Inject fake future tasks just for visualization if backlog is empty
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 2);
                const future1 = { id: 9001, titulo: "Mant. Mensual Chiller", equipoId: 2, asignadoId: 1, tipo: 'programado', fechaCreacion: nextWeek.toISOString(), duracionDias: 3 };
                const future2 = { id: 9002, titulo: "Renovación Luminarias Lobby", equipoId: 5, asignadoId: 2, tipo: 'programado', fechaCreacion: new Date(nextWeek.getTime() + 86400000 * 5).toISOString(), duracionDias: 2 };
                scheduled.push(future1, future2);
            }

            // 2. Setup Timeline Params
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 2); // Start a bit before today
            const daysToShow = 14;
            const timelineDates = [];

            for (let i = 0; i < daysToShow; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                timelineDates.push(d);
            }

            // 3. Render Header
            const cols = timelineDates.map(d => {
                const isToday = d.toISOString().split('T')[0] === new Date().toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('es-CL', { weekday: 'short' });
                const dayNum = d.getDate();
                return `
            <div style="text-align: center; border-right: 1px solid var(--color-border); padding: 5px; background: ${isToday ? 'rgba(59, 130, 246, 0.2)' : 'transparent'};">
                <div style="font-size: 0.6rem; text-transform: uppercase; color: var(--color-text-muted);">${dayName}</div>
                <div style="font-size: 0.8rem; font-weight: bold; color: ${isToday ? 'var(--color-primary)' : 'var(--color-text)'};">${dayNum}</div>
            </div>
        `;
            }).join('');

            // 4. Render Rows
            const rows = scheduled.map(task => {
                const tStart = new Date(task.fechaCreacion);
                // Calculate offset days from timeline start
                const diffTime = tStart - startDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const duration = task.duracionDias || 1; // Default 1 day width if not specified

                // Calculate grid position
                // Grid starts at column 2 (1 is label), so start = diffDays + 2
                // Prevent negative starts or starts beyond view
                if (diffDays < 0 || diffDays >= daysToShow) return '';

                const gridStart = diffDays + 1;
                const gridEnd = gridStart + duration;

                const eqName = equipos.find(e => e.id === task.equipoId)?.nombre || "Equipo General";
                const tecName = tecnicos.find(t => t.id === task.asignadoId)?.nombre || "Sin Asignar";

                return `
            <div style="display: contents;">
                <div style="padding: 10px; border-bottom: 1px solid var(--color-border); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <div style="font-weight: bold; color: white;">${task.titulo}</div>
                    <div style="font-size: 0.7rem; color: var(--color-text-muted);">${eqName} • ${tecName}</div>
                </div>
                <div style="grid-column: 1 / span ${daysToShow}; display: grid; grid-template-columns: repeat(${daysToShow}, 1fr); align-items: center; border-bottom: 1px solid var(--color-border); position: relative; height: 50px;">
                    <!-- Grid Lines Background -->
                    ${timelineDates.map(d => `<div style="border-right: 1px solid rgba(255,255,255,0.05); height: 100%;"></div>`).join('')}
                    
                    <!-- Task Bar -->
                    <div style="
                        grid-column: ${gridStart} / ${gridEnd}; 
                        background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); 
                        height: 24px; 
                        border-radius: 4px; 
                        position: absolute; 
                        top: 13px; 
                        left: 2px; 
                        right: 2px; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        display: flex; align-items: center; padding: 0 8px;
                        font-size: 0.7rem; font-weight: bold; text-shadow: 0 1px 2px black;
                        cursor: pointer;
                        z-index: 10;
                    " onclick="alert('Detalle: ${task.titulo}')">
                        ${duration > 1 ? task.titulo : ''}
                    </div>
                </div>
            </div>
        `;
            }).join('');

            return `
        <div class="view-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Planificación de Mantenimiento (Gantt)</h3>
                <button class="btn btn-primary" onclick="alert('Funcionalidad de Agendar en desarrollo')">+ Agendar Tarea</button>
            </div>

            <div class="card" style="padding: 0; overflow-x: auto;">
                <div style="display: grid; grid-template-columns: 200px 1fr; min-width: 800px;">
                    <!-- Header Left -->
                    <div style="padding: 10px; border-right: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); background: rgba(0,0,0,0.2);">
                        TAREA / EQUIPO
                    </div>
                    <!-- Header Timeline -->
                    <div style="display: grid; grid-template-columns: repeat(${daysToShow}, 1fr); border-bottom: 1px solid var(--color-border); background: rgba(0,0,0,0.2);">
                        ${cols}
                    </div>

                    <!-- Body -->
                    ${rows}
                </div>
                ${rows.length === 0 ? '<div style="padding: 20px; text-align: center; color: var(--color-text-muted);">No hay tareas programadas para los próximos días.</div>' : ''}
            </div>
        </div>
    `;
        }

        // --- CONTRACTOR PORTAL MODULE ---
        function renderContratistas() {
            // 1. Find External OTs (Linked to Assets with servicio: 'externo')
            const externalOTs = ots.filter(o => {
                const eq = equipos.find(e => e.id === o.equipoId);
                return eq && eq.servicio === 'externo';
            });

            // Mock Providers Database
            const providers = [
                { name: "ClimaCorp S.A.", service: "Climatización", rating: 4.8 },
                { name: "Ascensores Schindler", service: "Transporte Vertical", rating: 4.9 },
                { name: "Calderas Chile", service: "Termodinámica", rating: 4.5 }
            ];

            const list = externalOTs.length === 0 ? '<div style="text-align: center; color: var(--color-text-muted); padding: 2rem;">No hay trabajos externos activos.</div>' :
                externalOTs.map(ot => {
                    const eq = equipos.find(e => e.id === ot.equipoId);
                    const provider = providers.find(p => p.service === (eq.especialidad === 'Clima' ? 'Climatización' : (eq.especialidad.includes('Mec') ? 'Ascensores Schindler' : 'Calderas Chile'))) || providers[0];

                    return `
            <div class="card" style="border-left: 4px solid var(--color-accent);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div style="font-size: 0.7rem; color: var(--color-accent); font-weight: bold; text-transform: uppercase; margin-bottom: 4px;">
                            ${provider.name} • OT #${ot.id}
                        </div>
                        <h4 style="margin: 0; font-size: 1rem;">${ot.titulo}</h4>
                        <div style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 4px;">
                            ${eq.nombre} • ${ot.estado.toUpperCase()}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.8rem; font-weight: bold;">${new Date(ot.fechaCreacion).toLocaleDateString()}</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--color-border); display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <button class="btn" style="width: 100%; border: 1px dashed var(--color-text-muted); color: var(--color-text-muted); font-size: 0.7rem;" onclick="alert('Simulación: Abriendo gestor de archivos para subir informe PDF.')">
                            <span class="material-symbols-rounded" style="font-size: 14px; vertical-align: middle;">upload_file</span> Subir Informe
                        </button>
                    </div>
                    <div style="flex: 1;">
                        ${ot.estado === 'completada' ?
                            `<button class="btn btn-primary" style="width: 100%; font-size: 0.7rem; background: var(--color-success);" onclick="alert('✅ Factura aprobada para pago.')">
                                <span class="material-symbols-rounded" style="font-size: 14px; vertical-align: middle;">check_circle</span> Aprobar Pago
                            </button>` :
                            `<button class="btn" style="width: 100%; font-size: 0.7rem; background: var(--color-warning); color: black;" onclick="alert('Notificación enviada al proveedor.')">
                                <span class="material-symbols-rounded" style="font-size: 14px; vertical-align: middle;">notifications</span> Urgir Atención
                            </button>`
                        }
                    </div>
                </div>
            </div>
            `;
                }).join('');

            return `
        <div class="view-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Gestión de Contratistas</h3>
                <button class="btn btn-primary">+ Nuevo Proveedor</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                ${providers.map(p => `
                    <div class="card" style="text-align: center; padding: 10px;">
                        <div style="font-weight: bold;">${p.name}</div>
                        <div style="font-size: 0.7rem; color: var(--color-text-muted);">${p.service}</div>
                        <div style="color: gold; font-size: 0.8rem;">★ ${p.rating}</div>
                    </div>
                `).join('')}
            </div>

            <h4 style="margin-bottom: 10px; color: var(--color-text-muted);">Órdenes de Trabajo Externas</h4>
            ${list}
        </div>
    `;
        }

        // --- GLOBAL APP CONFIGURATION (EDITABLE) ---
        const APP_CONFIG = {
            // Datos de la Empresa / Hotel (Para PDFs y Reportes)
            companyName: "Hotel Plaza El Bosque Ebro",
            companyAddress: "Ebro 2828, Las Condes, Santiago",
            companyPhone: "+56 2 2498 1800",
            companyEmail: "reservas@plazaelbosque.cl",
            companyWebsite: "www.plazaelbosque.cl",
            // Logo URL: Usaremos un placeholder elegante si no carga el externo
            companyLogo: "https://www.plazaelbosque.cl/wp-content/uploads/2021/08/logo-hpb-ebro.svg",

            // Datos del Responsable (Firma Digital)
            signerName: "TU NOMBRE AQUÍ", // EDITAR: Tu nombre real
            signerRole: "JEFE DE MANTENIMIENTO", // EDITAR: Cargo aspira o actual

            // Configuración de Sistema
            appVersion: "v2.6.0-PRO",
            systemName: "XELONIA uptime"
        };

        // Cargar configuración guardada por el usuario (si existe)
        try {
            const savedConfig = JSON.parse(localStorage.getItem('cmms_branding_config'));
            if (savedConfig) {
                Object.assign(APP_CONFIG, savedConfig);
                console.log("Branding config loaded from storage:", APP_CONFIG);
            }
        } catch (e) {
            console.error("Error loading branding config:", e);
        }

        // --- GLOBAL STATE ---
        function openModal(eq = null) {
            const modal = document.getElementById('modal-equipo');
            if (!modal) return;

            document.getElementById('modal-title').innerText = eq ? "Editar Equipo" : "Nueva Ficha Técnica";

            // Restricción Financiera para Técnicos
            const finSec = document.getElementById('eq-financial-section');
            if (finSec) finSec.style.display = currentRole === 'admin' ? 'block' : 'none';

            if (eq) {
                document.getElementById('eq-id').value = eq.id;
                document.getElementById('eq-nombre').value = eq.nombre;
                document.getElementById('eq-area').value = eq.area;
                document.getElementById('eq-valor-mercado').value = eq.valorMercado || "";
                document.getElementById('eq-valor-adq').value = eq.valorAdquisicion || "";
                document.getElementById('eq-horas').value = eq.horas || 0;
                document.getElementById('eq-freq').value = eq.freq || 250;
                document.getElementById('eq-estado').value = eq.estado || 'activo';
                document.getElementById('eq-especialidad').value = eq.especialidad || "General";
                document.getElementById('eq-is-critico').checked = eq.isCritico || false;
                document.getElementById('eq-notas').value = eq.notas || "";
                document.getElementById('eq-diagnostico').value = eq.diagnostico || "";

                // Fields that might not be in eq yet
                if (document.getElementById('eq-marca')) document.getElementById('eq-marca').value = eq.marca || "";
                if (document.getElementById('eq-modelo')) document.getElementById('eq-modelo').value = eq.modelo || "";
                if (document.getElementById('eq-capacidad')) document.getElementById('eq-capacidad').value = eq.capacidad || "";
                if (document.getElementById('eq-refrigerante')) document.getElementById('eq-refrigerante').value = eq.refrigerante || "";
                if (document.getElementById('eq-tension')) document.getElementById('eq-tension').value = eq.tension || "";
                if (document.getElementById('eq-compresor')) document.getElementById('eq-compresor').value = eq.compresor || "";
                if (document.getElementById('eq-fecha-inicio')) document.getElementById('eq-fecha-inicio').value = eq.fechaInicio || "";
                if (document.getElementById('eq-responsable')) document.getElementById('eq-responsable').value = eq.responsableId || "";

                toggleDiagField();

                const preview = document.getElementById('foto-preview');
                const img = document.getElementById('preview-img');
                if (eq.foto) {
                    img.src = eq.foto;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            } else {
                // Clear all fields for new equipment
                document.getElementById('eq-id').value = "";
                document.getElementById('eq-nombre').value = "";
                document.getElementById('eq-area').value = "";
                document.getElementById('eq-valor-mercado').value = "";
                document.getElementById('eq-valor-adq').value = "";
                document.getElementById('eq-horas').value = "0";
                document.getElementById('eq-freq').value = "250";
                document.getElementById('eq-estado').value = "activo";
                document.getElementById('eq-is-critico').checked = false;
                document.getElementById('eq-notas').value = "";
                document.getElementById('eq-diagnostico').value = "";

                if (document.getElementById('eq-marca')) document.getElementById('eq-marca').value = "";
                if (document.getElementById('eq-modelo')) document.getElementById('eq-modelo').value = "";
                if (document.getElementById('eq-capacidad')) document.getElementById('eq-capacidad').value = "";
                if (document.getElementById('eq-refrigerante')) document.getElementById('eq-refrigerante').value = "";
                if (document.getElementById('eq-tension')) document.getElementById('eq-tension').value = "";
                if (document.getElementById('eq-compresor')) document.getElementById('eq-compresor').value = "";
                if (document.getElementById('eq-fecha-inicio')) document.getElementById('eq-fecha-inicio').value = "2026-01-01";
                if (document.getElementById('eq-responsable')) document.getElementById('eq-responsable').value = "";

                toggleDiagField();
                document.getElementById('eq-especialidad').value = "General";
                document.getElementById('foto-preview').style.display = 'none';
                document.getElementById('eq-foto').value = "";
            }

            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('modal-equipo');
            if (modal) modal.style.display = 'none';
        }

        // --- DETALLES DE EQUIPO ---
        function openDetails(id) {
            const eq = equipos.find(e => e.id === id);
            if (!eq) return;

            document.getElementById('det-nombre').innerText = eq.nombre;
            document.getElementById('det-marca-modelo').innerText = (eq.marca || 'Genérico') + (eq.modelo ? ' / ' + eq.modelo : '');
            document.getElementById('det-area').innerText = eq.area;
            document.getElementById('det-capacidad').innerText = eq.capacidad || 'N/A';
            document.getElementById('det-refrigerante').innerText = eq.refrigerante || 'N/A';
            document.getElementById('det-tension').innerText = eq.tension || 'N/A';
            document.getElementById('det-compresor').innerText = eq.compresor || 'N/A';
            document.getElementById('det-horas').innerText = (eq.horas || 0) + ' h';
            document.getElementById('det-freq').innerText = (eq.freq || 0) + ' h';
            document.getElementById('det-prox').innerText = (eq.horas && eq.freq ? (Math.ceil(eq.horas / eq.freq) * eq.freq) : 'N/A') + ' h';
            document.getElementById('det-notes').innerText = eq.notas || 'Sin notas adicionales.';
            document.getElementById('det-fecha-inicio').innerText = eq.fechaInicio || '01/01/2026';

            // Cargar Foto
            const detFoto = document.getElementById('det-foto');
            const detNoFoto = document.getElementById('det-no-foto');
            if (eq.foto) {
                detFoto.src = eq.foto;
                detFoto.style.display = 'block';
                detNoFoto.style.display = 'none';
            } else {
                detFoto.style.display = 'none';
                detNoFoto.style.display = 'flex';
            }

            // --- LÓGICA MONITOR DE SALUD Y FINANZAS ---
            const dispo = eq.dispo || 100;
            const gauge = document.getElementById('dispo-gauge');
            const dispoVal = document.getElementById('det-dispo-val');
            const saludTitle = document.getElementById('salud-title');
            const saludMsg = document.getElementById('salud-msg');
            const healthCont = document.getElementById('salud-container');
            const alertaInv = document.getElementById('alerta-inversion');

            const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });
            const costoAcum = eq.costoMantAcumulado || 0;
            const valorMkt = eq.valorMercado || 1; // Evitar división por cero
            const ratioFinanciero = (costoAcum / valorMkt) * 100;

            dispoVal.innerText = dispo + '%';
            gauge.style.strokeDasharray = `${dispo}, 100`;

            // Reset UI
            alertaInv.style.display = 'none';
            healthCont.style.border = '1px solid rgba(255,255,255,0.05)';

            if (ratioFinanciero > 80 && currentRole === 'admin') {
                gauge.style.stroke = 'var(--color-danger)';
                saludTitle.innerText = "ALERTA FINANCIERA";
                saludTitle.style.color = 'var(--color-danger)';
                saludMsg.innerHTML = `<b style="color:white;">Gastos vs Valor: ${ratioFinanciero.toFixed(1)}%</b><br>El costo de mantenimiento se acerca al valor del activo. Evaluar CAPEX.`;
                healthCont.style.borderColor = 'rgba(239, 68, 68, 0.4)';
                alertaInv.style.display = 'block';
                alertaInv.style.background = 'rgba(239, 68, 68, 0.2)';
            } else if (dispo < 85 || (ratioFinanciero > 80 && currentRole === 'tecnico')) {
                gauge.style.stroke = 'var(--color-warning)';
                saludTitle.innerText = ratioFinanciero > 80 ? "REVISIÓN REQUERIDA" : "Atención Requerida";
                saludTitle.style.color = 'var(--color-warning)';
                saludMsg.innerText = ratioFinanciero > 80 ? "El equipo requiere una inspección técnica profunda por desgaste acumulado." : "Disponibilidad en declive. Programar mantenimiento preventivo.";
                healthCont.style.borderColor = 'rgba(245, 158, 11, 0.3)';
            } else {
                gauge.style.stroke = 'var(--color-success)';
                saludTitle.innerText = "Operación Óptima";
                saludTitle.style.color = 'var(--color-success)';
                saludMsg.innerText = "El activo mantiene niveles de disponibilidad y costos saludables.";
                healthCont.style.borderColor = 'rgba(16, 185, 129, 0.2)';
            }

            // Inyectar mini-sección financiera en el historial o antes
            const financialHtml = currentRole === 'admin' ? `
                <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase; margin-bottom: 12px;">Desempeño Financiero (MANAGER)</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 0.85rem; font-weight: 700;">${fmt.format(costoAcum)}</div>
                            <div style="font-size: 0.55rem; color: var(--color-text-muted);">INVERSIÓN MANT. ACC.</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; font-weight: 700; color: ${ratioFinanciero > 50 ? 'var(--color-warning)' : 'var(--color-success)'};">${ratioFinanciero.toFixed(1)}%</div>
                            <div style="font-size: 0.55rem; color: var(--color-text-muted);">ÍNDICE GASTO/VALOR</div>
                        </div>
                    </div>
                </div>
            ` : '';

            // Renderizar Historial Dinámico
            const histContainer = document.getElementById('det-historial');
            let historialHtml = '';
            if (eq.historial && eq.historial.length > 0) {
                historialHtml = eq.historial.map(h => {
                    return `
                        <div style="border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                                <div style="color: var(--color-primary); font-size: 0.75rem; font-weight: bold; text-transform: uppercase;">${h.tarea}</div>
                                <div style="font-size: 0.75rem; color: var(--color-text-muted);">${h.fecha}</div>
                            </div>
                            <div style="font-size: 0.85rem; margin-bottom: 8px; color: #e2e8f0;">${h.desc}</div>
                            <div style="display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: var(--color-text-muted);">
                                <span>Técnico: ${h.tecnico}</span>
                                ${currentRole === 'admin' ? `<span style="margin-left: auto; color: var(--color-success); font-weight: 700;">${fmt.format(h.costo || 0)}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                historialHtml = '<div style="font-size: 0.8rem; color: var(--color-text-muted); padding: 10px; text-align: center;">No hay intervenciones registradas.</div>';
            }

            histContainer.innerHTML = financialHtml + historialHtml;

            // QUICK-FIX BUTTON INJECTION
            const quickFixContainer = document.getElementById('quick-fix-container');
            if (quickFixContainer) {
                // Buscar la última intervención exitosa (no preventiva) con descripción
                const lastFix = eq.historial && eq.historial.length > 0
                    ? eq.historial.find(h => h.desc && h.desc.length > 10 && !h.tipo?.includes('programado'))
                    : null;

                if (lastFix) {
                    quickFixContainer.innerHTML = `
                        <button onclick="mostrarQuickFix('${eq.nombre.replace(/'/g, "\\'")}', '${lastFix.desc.replace(/'/g, "\\'")}', '${lastFix.tecnico}', '${lastFix.fecha}')" 
                                class="btn" 
                                style="width: 100%; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(168, 85, 247, 0.1)); 
                                       border: 1px solid rgba(59, 130, 246, 0.3); color: var(--color-primary); 
                                       display: flex; align-items: center; justify-content: center; gap: 8px; 
                                       padding: 12px; font-weight: 700; font-size: 0.75rem;">
                            <span class="material-symbols-rounded" style="font-size: 18px;">bolt</span>
                            QUICK-FIX: Ver última solución
                        </button>
                    `;
                } else {
                    quickFixContainer.innerHTML = '';
                }
            }

            // EQUIPMENT-SPECIFIC MANUALS FILTER
            const manualsContainer = document.getElementById('equipment-manuals-section');
            if (manualsContainer) {
                // Filtrar manuales relevantes por categoría del equipo o nombre
                const areaCategories = {
                    'Clima': ['Clima', 'HVAC'],
                    'Electricidad': ['Eléctrico', 'Electricidad'],
                    'Hidráulica': ['Hidráulico', 'Hidráulica'],
                    'Mec': ['Mecánico', 'Mecánica'],
                };

                const relevantCategories = Object.entries(areaCategories)
                    .filter(([key]) => eq.area && eq.area.includes(key))
                    .flatMap(([, values]) => values);

                const relevantManuals = biblioteca.filter(manual =>
                    relevantCategories.includes(manual.categoria) ||
                    manual.titulo.toLowerCase().includes(eq.nombre.toLowerCase()) ||
                    (eq.marca && manual.titulo.toLowerCase().includes(eq.marca.toLowerCase()))
                );

                if (relevantManuals.length > 0) {
                    manualsContainer.innerHTML = `
                        <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 10px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span class="material-symbols-rounded" style="color: var(--color-primary); font-size: 20px;">description</span>
                                <h4 style="margin: 0; font-size: 0.8rem; color: var(--color-primary); text-transform: uppercase;">📚 Documentación Técnica</h4>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${relevantManuals.map(m => `
                                    <div style="background: rgba(255,255,255,0.03); border-radius: 6px; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 0.75rem; font-weight: 700;">${m.titulo}</div>
                                            <div style="font-size: 0.65rem; color: var(--color-text-muted); margin-top: 2px;">${m.descripcion || m.tipo}</div>
                                        </div>
                                        <button onclick="abrirManual('${m.url}')" class="btn" style="padding: 6px 12px; font-size: 0.65rem; background: rgba(59, 130, 246, 0.2); color: var(--color-primary); border: 1px solid rgba(59, 130, 246, 0.3);">
                                            <span class="material-symbols-rounded" style="font-size: 14px;">open_in_new</span>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    manualsContainer.innerHTML = '';
                }
            }

            const badge = document.getElementById('det-status-badge');
            if (badge) {
                badge.innerText = eq.estado.toUpperCase();
                badge.style.background = eq.estado === 'activo' ? 'rgba(16, 185, 129, 0.1)' : (eq.estado === 'alerta' ? 'rgba(245, 158, 11, 0.1)' : 'rgba(239, 68, 68, 0.1)');
                badge.style.color = eq.estado === 'activo' ? 'var(--color-success)' : (eq.estado === 'alerta' ? 'var(--color-warning)' : 'var(--color-danger)');
            }

            document.getElementById('btn-delete').onclick = () => deleteEquipo(eq.id);
            document.getElementById('btn-edit-det').onclick = () => {
                closeDetails();
                openModal(eq);
            };

            renderDispoChart(eq);
            document.getElementById('modal-detalle').style.display = 'flex';
        }

        function renderDispoChart(eq) {
            const ctx = document.getElementById('dispoChart') ? document.getElementById('dispoChart').getContext('2d') : null;
            if (!ctx) return;

            if (window.myDispoChart) {
                window.myDispoChart.destroy();
            }

            const hist = eq.dispo_history || [85, 90, 88, 92, 90, eq.dispo];
            const labels = hist.map((_, i) => `T-${hist.length - 1 - i}`);

            window.myDispoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Disponibilidad %',
                        data: hist,
                        borderColor: '#3b82f6',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 40, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // --- GRÁFICOS AVANZADOS (DASHBOARD v3.3) ---
        function initDashboardCharts() {
            if (currentRole !== 'admin') return;
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js no cargado, reintentando...");
                setTimeout(initDashboardCharts, 200);
                return;
            }

            // Chart: Cumplimiento de Planificación (3-way split)
            const ctxPie = document.getElementById('chart-pie-scheduled');
            if (ctxPie) {
                const progCount = ots.filter(o => o.tipo === 'programado').length;
                const corrCount = ots.filter(o => o.tipo === 'correctivo' || (o.tipo === 'no_programado' && o.prioridad !== 'ALTA')).length;
                const reacCount = ots.filter(o => o.tipo === 'reactivo' || (o.tipo === 'no_programado' && o.prioridad === 'ALTA')).length;

                new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: ['Programado', 'Correctivo', 'Reactivo'],
                        datasets: [{
                            data: [progCount, corrCount, reacCount],
                            backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#94a3b8',
                                    boxWidth: 10,
                                    font: { size: 9 },
                                    generateLabels: (chart) => {
                                        const data = chart.data;
                                        if (data.labels.length && data.datasets.length) {
                                            return data.labels.map((label, i) => {
                                                const value = data.datasets[0].data[i];
                                                const meta = chart.getDatasetMeta(0);
                                                const style = meta.controller.getStyle(i);
                                                return {
                                                    text: `${label}: ${value}`,
                                                    fillStyle: style.backgroundColor,
                                                    strokeStyle: style.borderColor,
                                                    lineWidth: style.borderWidth,
                                                    hidden: isNaN(data.datasets[0].data[i]) || meta.data[i].hidden,
                                                    index: i,
                                                    fontColor: '#ffffff' // Force White (v2)
                                                };
                                            });
                                        }
                                        return [];
                                    },
                                    color: '#ffffff' // Force White (v3+)
                                }
                            }
                        }
                    }
                });
            }

            // Chart: Cierres por Técnico
            const ctxPerf = document.getElementById('chart-performance');
            if (ctxPerf) {
                // Filter for TODAY
                const today = new Date().toISOString().split('T')[0];
                const dataRaw = tecnicos.map(t => {
                    return laborLogs.filter(l => l.idTec === t.id && l.action === 'fin' && l.timestamp.startsWith(today)).length;
                });
                new Chart(ctxPerf, {
                    type: 'bar',
                    data: {
                        labels: tecnicos.map(t => t.nombre.split(' ')[0]),
                        datasets: [{
                            label: 'Cierres (Hoy)',
                            data: dataRaw,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 9 } } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 9 } } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Chart: Leaderboard Mensual (Acumulado)
            const ctxLeaders = document.getElementById('chart-monthly-leaders');
            if (ctxLeaders) {
                // Filter for Current Month
                const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM

                // Count closures per tech this month
                const monthlyStats = tecnicos.map(t => {
                    const count = laborLogs.filter(l => l.idTec === t.id && l.action === 'fin' && l.timestamp.startsWith(currentMonth)).length;
                    return { name: t.nombre.split(' ')[0], count: count, id: t.id };
                });

                // Sort Descending
                monthlyStats.sort((a, b) => b.count - a.count);

                // Assign Podium Colors
                const colors = monthlyStats.map((_, i) => {
                    if (i === 0) return '#FFD700'; // Gold
                    if (i === 1) return '#C0C0C0'; // Silver
                    if (i === 2) return '#CD7F32'; // Bronze
                    return '#3b82f6'; // Blue for the rest
                });

                new Chart(ctxLeaders, {
                    type: 'bar',
                    data: {
                        labels: monthlyStats.map(s => s.name),
                        datasets: [{
                            label: 'Cierres (Mes)',
                            data: monthlyStats.map(s => s.count),
                            backgroundColor: colors,
                            borderRadius: 4,
                            borderWidth: 1,
                            borderColor: 'rgba(255,255,255,0.1)'
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bars
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', font: { size: 9 } } },
                            y: { grid: { display: false }, ticks: { color: '#ffffff', font: { weight: 'bold' } } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // --- MANEJO DE FOTOS Y REGISTRO ---
        let pendingOT = null;
        let pendingActionType = null;
        let tempConsumo = []; // Para guardar consumos antes de confirmar

        function populateRepuestosSelect() {
            const select = document.getElementById('reg-repuesto-select');
            if (!select) return;
            select.innerHTML = '<option value="">Seleccionar Repuesto...</option>' +
                repuestos.map(r => {
                    // Construir la ubicación física si existe
                    let ubicacion = '';
                    if (r.zona || r.pasillo) {
                        const zona = r.zona || '?';
                        const pasillo = r.pasillo || '?';
                        const estante = r.estante || '?';
                        const nivel = r.nivel || '?';
                        ubicacion = ` 📍 ${zona}/${pasillo}-${estante}-${nivel}`;
                    }
                    return `<option value="${r.id}">${r.nombre} (Stock: ${r.stock})${ubicacion}</option>`;
                }).join('');
        }

        function addRepuestoRow() {
            const select = document.getElementById('reg-repuesto-select');
            const cantInput = document.getElementById('reg-repuesto-cant');
            const rid = parseInt(select.value);
            const cant = parseInt(cantInput.value);

            if (!rid || !cant || cant <= 0) return alert("Seleccione repuesto y cantidad válida.");

            const rep = repuestos.find(r => r.id === rid);
            if (rep.stock < cant) return alert("Stock insuficiente en bodega.");

            // Agregar al array temporal
            tempConsumo.push({ id: rep.id, nombre: rep.nombre, cant: cant, precio: rep.precio });
            renderTempConsumo();

            // Limpiar inputs
            select.value = "";
            cantInput.value = "";
        }

        function removeRepuestoRow(index) {
            tempConsumo.splice(index, 1);
            renderTempConsumo();
        }

        function renderTempConsumo() {
            const list = document.getElementById('reg-repuestos-list');
            list.innerHTML = tempConsumo.map((c, i) => `
                <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 4px; margin-bottom: 5px;">
                    <span>${c.nombre} x${c.cant}</span>
                    <span onclick="removeRepuestoRow(${i})" class="material-symbols-rounded" style="font-size: 14px; cursor: pointer; color: var(--color-danger);">delete</span>
                </div>
            `).join('');
        }

        function abrirRegistroFoto(otId, type) {
            pendingOT = ots.find(o => o.id === otId);
            pendingActionType = type;

            const modal = document.getElementById('modal-registro-trabajo');
            const titulo = document.getElementById('reg-titulo');
            const instruccion = document.getElementById('reg-instruccion');
            const feedbackContainer = document.getElementById('reg-feedback-container');

            // Reset modal
            document.getElementById('reg-foto-input').value = "";
            document.getElementById('reg-foto-preview').style.display = 'none';
            document.getElementById('reg-condiciones').value = "";
            document.getElementById('reg-diagnostico').value = "";

            // RESET REPUESTOS
            tempConsumo = [];
            document.getElementById('reg-repuestos-list').innerHTML = "";
            populateRepuestosSelect();

            if (type === 'inicio' || type === 'levantamiento') {
                titulo.innerHTML = `<span class="material-symbols-rounded" style="color: var(--color-primary);">${type === 'inicio' ? 'play_circle' : 'visibility'}</span> Foto de Estado Inicial`;
                instruccion.innerText = "Registra una foto del equipo y sus condiciones al recibirlo.";
                feedbackContainer.style.display = 'block'; // Mostrar para el levantamiento si aplica
                document.getElementById('reg-cond-group').style.display = 'none';
                document.getElementById('reg-diag-group').style.display = 'none';

                if (type === 'levantamiento') {
                    document.getElementById('reg-levantamiento-group').style.display = 'block';
                    document.getElementById('reg-levantamiento-val').value = pendingOT.levantamiento || "";
                } else {
                    document.getElementById('reg-levantamiento-group').style.display = 'none';
                }
            } else {
                titulo.innerHTML = '<span class="material-symbols-rounded" style="color: var(--color-success);">check_circle</span> Foto de Cierre Operativo';
                instruccion.innerText = "Registra foto del equipo operativo y tu diagnóstico técnico.";
                feedbackContainer.style.display = 'block';
                document.getElementById('reg-levantamiento-group').style.display = 'none';
                document.getElementById('reg-cond-group').style.display = 'block';
                document.getElementById('reg-diag-group').style.display = 'block';
            }

            modal.style.display = 'flex';
        }

        function closeModalRegistro() {
            document.getElementById('modal-registro-trabajo').style.display = 'none';
            document.getElementById('reg-levantamiento-group').style.display = 'none';
            document.getElementById('reg-cond-group').style.display = 'block';
            document.getElementById('reg-diag-group').style.display = 'block';
            pendingOT = null;
            pendingActionType = null;
        }

        const regFileInput = document.getElementById('reg-foto-input');
        if (regFileInput) {
            regFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        // Optimizar imagen para no saturar LocalStorage
                        const img = new Image();
                        img.onload = function () {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 600; // Suficiente para evidencia técnica
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            document.getElementById('reg-preview-img').src = canvas.toDataURL('image/jpeg', 0.7);
                            document.getElementById('reg-foto-preview').style.display = 'block';
                        }
                        img.src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        document.getElementById('btn-confirmar-registro').onclick = function () {
            try {
                const foto = document.getElementById('reg-preview-img').src;
                const cond = document.getElementById('reg-condiciones').value;
                const diag = document.getElementById('reg-diagnostico').value;

                const isAdmin = currentRole === 'admin';
                const hasFoto = (foto && foto.startsWith('data:'));

                if (!isAdmin && !hasFoto) {
                    return alert("La fotografía es obligatoria para certificar el estado.");
                }

                if (!pendingOT) return closeModalRegistro();

                if (pendingActionType === 'inicio' || pendingActionType === 'levantamiento') {
                    pendingOT.foto_inicio = hasFoto ? foto : null;
                    if (pendingActionType === 'levantamiento') {
                        const val = document.getElementById('reg-levantamiento-val').value.trim();
                        if (!val) return alert("Por favor escribe el levantamiento antes de la foto.");
                        pendingOT.levantamiento = val;
                        pendingOT.estado = 'revision';
                    }
                    logLabor(pendingOT.id, 'inicio');
                } else {
                    pendingOT.foto_fin = hasFoto ? foto : null;
                    pendingOT.comentario_tecnico = diag;
                    pendingOT.condiciones_finales = cond;

                    // --- PROCESAR CONSUMO DE REPUESTOS ---
                    if (tempConsumo.length > 0) {
                        let totalMateriales = 0;
                        if (!pendingOT.consumos) pendingOT.consumos = [];

                        tempConsumo.forEach(c => {
                            // Descontar stock real
                            const realRep = repuestos.find(r => r.id === c.id);
                            if (realRep) {
                                realRep.stock -= c.cant;
                                totalMateriales += (c.precio * c.cant);
                            }
                            pendingOT.consumos.push(c);
                        });
                        pendingOT.costo_materiales = totalMateriales;
                    }

                    logLabor(pendingOT.id, 'fin');
                }

                closeModalRegistro();
                navigate('ots');
            } catch (err) {
                console.error("Error al guardar:", err);
                alert("Error crítico al guardar: " + err.message);
            }
        };

        function closeDetails() {
            const modal = document.getElementById('modal-detalle');
            if (modal) modal.style.display = 'none';
        }

        function deleteEquipo(id) {
            if (!confirm("¿Seguro que deseas eliminar este equipo? Se borrará todo su historial.")) return;
            equipos = equipos.filter(e => e.id !== id);
            persist();
            closeDetails();
            navigate('activos');
        }

        // Preview de imagen
        const fileInput = document.getElementById('eq-foto');
        if (fileInput) {
            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = document.getElementById('preview-img');
                        if (img) img.src = event.target.result;
                        const preview = document.getElementById('foto-preview');
                        if (preview) preview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        function simularEnvio(tipo) {
            const texto = document.getElementById('req-texto').value;
            const email = document.getElementById('req-email').value;
            if (!texto) return alert("Por favor escribe el requerimiento antes de enviar.");

            // Detect duplicate request
            const lastSent = localStorage.getItem('last_req');
            if (lastSent && lastSent === texto) {
                alert('Este requerimiento ya fue enviado previamente.');
                return;
            }
            localStorage.setItem('last_req', texto);

            if (tipo === 'email') {
                if (!email) return alert("Por favor define un correo de destino.");
                alert(`Simulando envío a: ${email}\n\nContenido:\n${texto}`);
                // Process request and suggest assignment
                processRequerimiento(texto);
            } else {
                alert("Generando archivo requerimientos.xlsx...\n\nContenido: " + texto + "\n\nDescarga iniciada.");
                // Generate Excel download
                downloadExcel(texto);
                // Process request and suggest assignment
                processRequerimiento(texto);
            }
            document.getElementById('req-texto').value = "";
        }
        // Helper: parse request text and suggest technician/equipment assignment
        function processRequerimiento(texto) {
            const lower = texto.toLowerCase();
            const equipo = equipos.find(e => e.nombre && e.nombre.toLowerCase().includes(lower));
            if (!equipo) {
                alert('No se encontró un equipo coincidente en el requerimiento para sugerir asignación.');
                return;
            }
            const candidatos = tecnicos.filter(t => t.especialidad === equipo.especialidad);
            if (candidatos.length === 0) {
                alert('No hay técnicos con la especialidad requerida para el equipo encontrado.');
                return;
            }
            const tecnico = candidatos.reduce((best, cur) => {
                const bestTareas = ots.filter(o => o.asignadoId === best.id && o.estado !== "completada").length;
                const curTareas = ots.filter(o => o.asignadoId === cur.id && o.estado !== "completada").length;
                return curTareas < bestTareas ? cur : best;
            }, candidatos[0]);
            alert(`Sugerencia automática: asignar al técnico ${tecnico.nombre} (Especialidad: ${tecnico.especialidad}) para el equipo ${equipo.nombre}.`);
        }

        // Helper: generate a simple Excel (CSV) download with the request text
        function downloadExcel(texto) {
            const csvContent = "data:text/csv;charset=utf-8," + encodeURIComponent("Requerimiento\n" + texto.replace(/\n/g, " "));
            const link = document.createElement('a');
            link.setAttribute('href', csvContent);
            link.setAttribute('download', 'requerimiento.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderDetalleTecnico(id) {
            const t = tecnicos.find(tec => tec.id === id);
            if (!t) return;

            const content = document.getElementById('main-content');
            const tareas = ots.filter(o => o.asignadoId === t.id && o.estado !== 'completada');
            const fmt = (num) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(num);

            // Algoritmo de recomendación simple: evitar equipos ya asignados
            const equiposAsignadosIds = ots
                .filter(o => o.asignadoId === t.id && o.estado !== 'completada')
                .map(o => o.equipoId);

            const recomendada = equipos
                .filter(e => e.especialidad === t.especialidad && e.estado !== 'activo' && !equiposAsignadosIds.includes(e.id))
                .sort((a, b) => (b.isCritico ? 1 : 0) - (a.isCritico ? 1 : 0))[0];

            content.innerHTML = `
                <div class="view-content">
                    <button onclick="navigate('dashboard')" class="btn" style="margin-bottom: 1rem; color: var(--color-text-muted); font-size: 0.7rem; display: flex; align-items: center; gap: 5px;">
                        <span class="material-symbols-rounded" style="font-size: 16px;">arrow_back</span> VOLVER AL DASHBOARD
                    </button>

                    <div class="card" style="display: flex; gap: 20px; align-items: flex-start;">
                        <img src="${t.foto}" style="width: 80px; height: 80px; border-radius: 12px; object-fit: cover; border: 2px solid var(--color-primary);">
                        <div style="flex: 1;">
                            <h3 style="margin: 0;">${t.nombre}</h3>
                            <div style="font-size: 0.8rem; color: var(--color-primary); font-weight: 700; text-transform: uppercase;">Especialidad: ${t.especialidad}</div>
                            <div style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 5px;">
                                Salario: ${fmt(t.salario || 0)} | Costo HH: ${fmt(t.costoHora || 0)}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 800; color: ${t.eficacia > 90 ? 'var(--color-success)' : 'var(--color-warning)'};">${t.eficacia}%</div>
                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">EFICACIA ACTUAL</div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <h4>Tareas Activas (${tareas.length})</h4>
                        ${tareas.length === 0 ? '<p style="font-size: 0.75rem; color: var(--color-text-muted);">Sin tareas pendientes.</p>' :
                    tareas.map(o => `
                            <div class="card" style="padding: 10px; margin-bottom: 8px; border-left: 3px solid var(--color-warning);">
                                <div style="font-size: 0.85rem; font-weight: 700;">${o.titulo}</div>
                                <div style="font-size: 0.65rem; color: var(--color-text-muted);">${o.estado.toUpperCase()} | Prioridad: ${o.prioridad}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="margin-top: 2rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--color-success);">
                            <span class="material-symbols-rounded">psychology</span>
                            <h4 style="margin: 0;">Asignación Recomendada por Sistema</h4>
                        </div>
                        <p style="font-size: 0.75rem; color: #94a3b8; margin: 8px 0 15px 0;">Basado en la especialidad del técnico y la criticidad de los activos fuera de servicio.</p>

                        ${recomendada ? `
                            <div class="card" style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 0;">
                                <div style="font-size: 0.9rem; font-weight: 700;">${recomendada.nombre}</div>
                                <div style="font-size: 0.7rem; color: var(--color-danger); font-weight: 800; margin-top: 4px;">
                                    ACTIVO VITAL CON FALLA - PRIORIDAD MÁXIMA
                                </div>
                                <button onclick="asignarTareaRecomendada(${t.id}, ${recomendada.id})" class="btn btn-primary" style="width: 100%; margin-top: 15px; font-weight: 800;">ASIGNAR REQUERIMIENTO AHORA</button>
                            </div>
                        ` : '<p style="font-size: 0.75rem; color: var(--color-success); font-weight: 700;">No hay urgencias críticas para esta especialidad.</p>'}
                    </div>
                </div>
            `;
        }

        function asignarTareaRecomendada(tecId, eqId) {
            // Doble validación para evitar duplicados accidentales
            const yaAsignada = ots.some(o => o.asignadoId === tecId && o.equipoId === eqId && o.estado !== 'completada');
            if (yaAsignada) return alert("Este equipo ya tiene una tarea activa asignada a este técnico.");

            const eq = equipos.find(e => e.id === eqId);
            const newOT = {
                id: Date.now(),
                titulo: "Reparación Recomendada: " + eq.nombre,
                descripcion: "Tarea asignada automáticamente por recomendación de sistema basada en especialidad técnica.",
                asignadoId: tecId,
                prioridad: "ALTA",
                estado: "ejecucion",
                tipo: "correctivo"
            };
            ots.push(newOT);
            persist();
            alert("Tarea asignada correctamente.");
            renderDetalleTecnico(tecId);
            document.getElementById('modal-importar').style.display = 'flex';
        }

        function openModalImportar() {
            document.getElementById('modal-importar').style.display = 'flex';
        }

        function closeModalImportar() {
            document.getElementById('modal-importar').style.display = 'none';
            document.getElementById('import-text').value = '';
            document.getElementById('import-file').value = '';
            document.getElementById('import-preview').innerHTML = '';
        }

        async function procesarImportacion() {
            const text = document.getElementById('import-text').value.trim();
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            let registros = [];

            if (file) {
                // Procesar Excel/CSV
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Asumimos encabezados en fila 0 o sin encabezados
                // Mapeo simple: Col 0 -> Equipo, Col 1 -> Descripción
                json.forEach((row, idx) => {
                    if (idx === 0 && row[0] && row[0].toString().toLowerCase().includes('equipo')) return; // Skip header
                    if (row.length >= 2) {
                        registros.push({
                            equipo: row[0],
                            descripcion: row[1],
                            prioridad: row[2] || 'MEDIA'
                        });
                    }
                });
            } else if (text) {
                // Procesar Texto de correo
                // Formato flexible: Detectar líneas o bloques
                const lines = text.split('\n');
                lines.forEach(line => {
                    if (line.length > 5) {
                        // Intento básico de extracción
                        registros.push({
                            equipo: line.split('|')[0] || 'General',
                            descripcion: line,
                            prioridad: 'MEDIA'
                        });
                    }
                });
            } else {
                return alert("Por favor ingresa texto o sube un archivo.");
            }

            mostrarPrevisualizacionImport(registros);
        }

        function mostrarPrevisualizacionImport(registros) {
            const container = document.getElementById('import-preview');
            let html = '<h4 style="margin: 15px 0 10px; color: var(--color-primary);">Vista Previa de Importación</h4>';

            registros.forEach((reg, idx) => {
                // Logica de deteccion inteligente
                const eqMatch = equipos.find(e => e.nombre.toLowerCase().includes(reg.equipo.toString().toLowerCase()));
                const equipoFinal = eqMatch || { id: null, nombre: "NO ENCONTRADO (" + reg.equipo + ")", especialidad: "General" };

                // Sugerencia Tecnico
                const tecnicosEsp = tecnicos.filter(t => t.especialidad === equipoFinal.especialidad);
                // Ordenar por carga (menos OTs activas primero)
                tecnicosEsp.sort((a, b) => {
                    const cargaA = ots.filter(o => o.asignadoId === a.id && o.estado !== 'archivada').length;
                    const cargaB = ots.filter(o => o.asignadoId === b.id && o.estado !== 'archivada').length;
                    return cargaA - cargaB;
                });
                const tecnicoSugerido = tecnicosEsp.length > 0 ? tecnicosEsp[0] : tecnicos[0]; // Fallback

                // Prioridad
                let prio = 'MEDIA';
                const desc = reg.descripcion.toLowerCase();
                if (desc.includes('urgente') || desc.includes('fallo') || desc.includes('emergencia')) prio = 'ALTA';

                html += `
                    <div id="reg-import-${idx}" class="card" style="padding: 10px; margin-bottom: 8px; border-left: 3px solid ${prio === 'ALTA' ? 'var(--color-danger)' : 'var(--color-primary)'}">
                        <div style="font-size: 0.7rem; font-weight: bold;">${equipoFinal.nombre} <span style="font-weight:400; color:var(--color-text-muted)">(${equipoFinal.especialidad || 'General'})</span></div>
                        <div style="font-size: 0.8rem; margin: 4px 0;">${reg.descripcion}</div>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                            <select id="imp-tec-${idx}" class="form-control" style="font-size: 0.7rem; padding: 4px;">
                                ${tecnicos.map(t => `<option value="${t.id}" ${t.id === tecnicoSugerido.id ? 'selected' : ''}>${t.nombre} (${t.especialidad})</option>`).join('')}
                            </select>
                            <select id="imp-prio-${idx}" class="form-control" style="font-size: 0.7rem; padding: 4px; width: 80px;">
                                <option value="ALTA" ${prio === 'ALTA' ? 'selected' : ''}>ALTA</option>
                                <option value="MEDIA" ${prio === 'MEDIA' ? 'selected' : ''}>MEDIA</option>
                                <option value="BAJA" ${prio === 'BAJA' ? 'selected' : ''}>BAJA</option>
                            </select>
                            <button onclick="confirmarImportacionIndividual(${idx}, '${equipoFinal.id}', 'reg-import-${idx}')" class="btn btn-primary" style="padding: 4px 10px; font-size: 0.7rem;">ACEPTAR</button>
                        </div>
                         <input type="hidden" id="imp-desc-${idx}" value="${reg.descripcion}">
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function confirmarImportacionIndividual(idx, eqId, cardId) {
            const tecId = parseInt(document.getElementById(`imp-tec-${idx}`).value);
            const prio = document.getElementById(`imp-prio-${idx}`).value;
            const desc = document.getElementById(`imp-desc-${idx}`).value;

            // Crear OT
            const newOT = {
                id: Date.now() + idx,
                titulo: "REQUERIMIENTO IMPORTADO",
                descripcion: desc,
                prioridad: prio,
                asignadoId: tecId,
                estado: 'levatamiento', // Directo a flujo
                equipoId: eqId !== 'null' ? parseInt(eqId) : null,
                fechaCreacion: new Date().toISOString()
            };

            ots.push(newOT);
            persist();

            // Feedback visual
            const card = document.getElementById(cardId);
            card.innerHTML = `<div style="color: var(--color-success); font-weight: bold; text-align: center;">✓ SOLICITUD CREADA</div>`;
            setTimeout(() => card.remove(), 1500);
        }

        async function downloadPDFReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES');
            const timeStr = now.toLocaleTimeString('es-ES');

            // --- HEADER CORPORATIVO PREMIUM ---
            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 210, 40, 'F');

            // Logo H5
            doc.setFillColor(59, 130, 246);
            doc.circle(20, 20, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text("H5", 17, 21.5);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("REPORTE EJECUTIVO GERENCIAL", 35, 18);
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.text("CMMS ADVANCED - GESTIÓN DE ACTIVOS Y MANTENIMIENTO", 35, 25);
            doc.text(`Generado: ${dateStr} ${timeStr}`, 145, 18);

            let yPos = 50;

            // --- 1. RESUMEN FINANCIERO (VALIDADO) ---
            const valorTotalActivos = equipos.reduce((sum, e) => sum + (e.valorMercado || 0), 0);
            const costoTotalMantenimiento = equipos.reduce((sum, e) => sum + (e.costoMantAcumulado || 0), 0);
            const ratio = valorTotalActivos > 0 ? ((costoTotalMantenimiento / valorTotalActivos) * 100).toFixed(2) : "0.00";

            doc.setTextColor(30, 41, 59);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("1. Resumen Financiero de Activos (YTD)", 14, yPos);
            yPos += 8;

            doc.autoTable({
                startY: yPos,
                head: [['Concepto', 'Monto Transado', 'Estado / Evaluación']],
                body: [
                    ['Valoración Total Activos (CAPEX)', new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(valorTotalActivos), 'Vigente'],
                    ['Gasto Acumulado Mant. (OPEX)', new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(costoTotalMantenimiento), 'Controlado'],
                    ['Ratio Eficiencia Gasto/Valor', `${ratio}%`, parseFloat(ratio) > 5 ? 'ALERTA > 5%' : 'ÓPTIMO']
                ],
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 10, cellPadding: 4 }
            });
            yPos = doc.previousAutoTable.finalY + 15;

            // --- 2. RESUMEN OPERATIVO ---
            const totalEq = equipos.length || 1; // Evitar division por cero
            const equiposOk = equipos.filter(e => e.estado === 'activo').length;
            const dispoGlobal = ((equiposOk / totalEq) * 100).toFixed(1);
            const criticosMalos = equipos.filter(e => e.criticidad === 'AAA' && e.estado !== 'activo').length;

            doc.setFontSize(14);
            doc.text("2. Indicadores Operativos Clave (KPI)", 14, yPos);
            yPos += 8;
            doc.autoTable({
                startY: yPos,
                head: [['Métrica de Disponibilidad', 'Valor Actual', 'Meta / Benchmark']],
                body: [
                    ['Disponibilidad Global de Planta', `${dispoGlobal}%`, '> 95.0%'],
                    ['Activos Críticos en Falla (AAA)', `${criticosMalos} Equipos`, '0 Incidencias'],
                    ['Total Alarmas Activas', `${equipos.length - equiposOk}`, 'Tendencia Baja']
                ],
                theme: 'striped',
                headStyles: { fillColor: [16, 185, 129] },
                styles: { fontSize: 10, cellPadding: 4 }
            });
            yPos = doc.previousAutoTable.finalY + 15;

            // --- 3. ÚLTIMAS ACTIVIDADES ---
            doc.setFontSize(14);
            doc.text("3. Historial Reciente de Intervención", 14, yPos);
            yPos += 8;

            const completadas = ots.filter(o => o.estado === 'completada');
            const lastOts = completadas.slice(0, 8).map(o => {
                const eq = equipos.find(e => e.id === o.equipoId);
                return [
                    eq ? eq.nombre : 'S/A',
                    o.titulo.substring(0, 40),
                    o.prioridad,
                    o.fechaFin || '-'
                ];
            });

            if (lastOts.length > 0) {
                doc.autoTable({
                    startY: yPos,
                    head: [['Equipo', 'Tarea Realizada', 'Prioridad', 'Fecha Cierre']],
                    body: lastOts,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 3 },
                    headStyles: { fillColor: [71, 85, 105] }
                });
            } else {
                doc.setFontSize(10);
                doc.setFont("helvetica", "italic");
                doc.setTextColor(150);
                doc.text("No se registran actividades completadas en el historial reciente.", 14, yPos + 5);
            }

            // Footer de Página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Página ${i} de ${pageCount} | Reservado para uso Gerencial | CMMS Advanced v2.0`, 14, 285);
            }

            doc.save(`REPORTE_GERENCIAL_${Date.now()}.pdf`);
        }

        async function downloadQualityReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES');

            // --- HEADER PREMIUM ---
            doc.setFillColor(30, 41, 59);
            doc.rect(0, 0, 210, 40, 'F');

            doc.setFillColor(249, 115, 22); // Orange Accent
            doc.rect(0, 38, 210, 2, 'F');

            // Logo H5
            doc.setFillColor(59, 130, 246);
            doc.circle(20, 20, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.text("H5", 17, 21.5);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("REPORTE DE CALIDAD Y PRODUCTIVIDAD", 35, 18);
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text("DEPARTAMENTO DE CONTROL TÉCNICO & RRHH", 35, 26);
            doc.text(`EMISIÓN: ${dateStr}`, 160, 20);

            let yPos = 55;

            // --- CÁLCULOS Y PREPROCESAMIENTO ---
            // 1. Costos y HH por Técnico
            const techData = tecnicos.map(t => {
                const logs = laborLogs.filter(l => l.idTec === t.id && l.action === 'fin');

                // Calculamos HH reales (simuladas en base logs)
                // Para demo, asumimos que cada 'fin' son 2 horas promedio si no hay dato exacto
                const hhOrdinarias = logs.length * 2;

                // Horas extra (Simulamos que el 20% de las tareas son fuera de horario)
                const hhExtras = Math.floor(hhOrdinarias * 0.2);

                // Valor hora
                const salario = t.salario || 600000; // Fallback
                const valorHora = Math.round(salario / 180);
                const valorExtra = Math.round(valorHora * 1.5);

                const costoOrdinario = (hhOrdinarias - hhExtras) * valorHora;
                const costoExtra = hhExtras * valorExtra;
                const costoTotal = costoOrdinario + costoExtra;

                // Eficiencia (Cierres vs Total Asignado)
                const totalAsignado = ots.filter(o => o.asignadoId === t.id).length;
                const totalCerrado = ots.filter(o => o.asignadoId === t.id && o.estado === 'completada').length;
                const eficiencia = totalAsignado > 0 ? Math.round((totalCerrado / totalAsignado) * 100) : 0;

                return {
                    nombre: t.nombre,
                    especialidad: t.especialidad,
                    hh: hhOrdinarias,
                    extras: hhExtras,
                    costo: costoTotal,
                    eficiencia: eficiencia
                };
            }).sort((a, b) => b.eficiencia - a.eficiencia);

            // --- 1. RANKING EFICIENCIA ---
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("1. Ranking de Eficiencia Operativa", 14, yPos);
            yPos += 8;

            doc.autoTable({
                startY: yPos,
                head: [['Técnico', 'Departamento', 'Eficiencia (%)', 'Nivel de Desempeño']],
                body: techData.map(t => [
                    t.nombre,
                    t.especialidad,
                    `${t.eficiencia}%`,
                    t.eficiencia > 85 ? 'DISTINGUIDO' : (t.eficiencia > 60 ? 'CUMPLE' : 'MEJORABLE')
                ]),
                theme: 'striped',
                headStyles: { fillColor: [56, 189, 248] },
                styles: { fontSize: 10 }
            });
            yPos = doc.previousAutoTable.finalY + 15;

            // --- 2. AUDITORÍA DE COSTOS LABORALES ---
            doc.setFontSize(14);
            doc.text("2. Análisis de Costo por Mano de Obra", 14, yPos);
            yPos += 8;

            doc.autoTable({
                startY: yPos,
                head: [['Técnico', 'HH Turno', 'Costo Turno', 'HH Extras', 'Costo Extras', 'TOTAL ($)']],
                body: techData.map(t => {
                    const salary = tecnicos.find(tec => tec.nombre === t.nombre)?.salario || 750000;
                    const valHora = Math.round(salary / 180);
                    const cNormal = (t.hh - t.extras) * valHora;
                    const cExtra = t.extras * Math.round(valHora * 1.5);

                    return [
                        t.nombre,
                        `${t.hh - t.extras}h`,
                        new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(cNormal),
                        t.extras > 0 ? `${t.extras}h (!)` : '0h',
                        new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(cExtra),
                        new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(cNormal + cExtra)
                    ];
                }),
                theme: 'grid',
                headStyles: { fillColor: [249, 115, 22] },
                columnStyles: {
                    2: { halign: 'right' },
                    3: { textColor: [220, 38, 38], fontStyle: 'bold', halign: 'center' },
                    4: { textColor: [220, 38, 38], halign: 'right' },
                    5: { fontStyle: 'bold', halign: 'right' }
                }
            });
            yPos = doc.previousAutoTable.finalY + 15;

            // --- 3. DETALLE POR TÉCNICO (PÁGINA NUEVA) ---
            doc.addPage();
            yPos = 20;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("3. Desglose Individual de Intervenciones", 14, yPos);
            yPos += 10;

            techData.forEach(t => {
                if (yPos > 240) { doc.addPage(); yPos = 20; }

                doc.setFontSize(11);
                doc.setTextColor(59, 130, 246);
                doc.text(`Planilla: ${t.nombre} | Especialidad: ${t.especialidad}`, 14, yPos);
                yPos += 5;

                const trabajos = ots.filter(o => o.asignadoId === t.id && o.estado === 'completada').slice(0, 5);

                if (trabajos.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['ID OT', 'Activo', 'Acción Realizada', 'Fecha']],
                        body: trabajos.map(o => {
                            const eq = equipos.find(e => e.id === o.equipoId);
                            return [`#${o.id}`, eq ? eq.nombre : 'Gral', o.titulo.substring(0, 30), o.fechaFin || '-'];
                        }),
                        theme: 'plain',
                        styles: { fontSize: 8 },
                        headStyles: { fontStyle: 'bold', textColor: [100, 100, 100] }
                    });
                    yPos = doc.previousAutoTable.finalY + 12;
                } else {
                    doc.setFontSize(9);
                    doc.setTextColor(150);
                    doc.text("Sin registros de cierre bajo este técnico.", 20, yPos + 4);
                    yPos += 12;
                }
            });

            // --- 4. ATRIBUCIÓN DE COSTOS (EQUIPOS) ---
            if (yPos > 240) { doc.addPage(); yPos = 20; } else { yPos += 10; }

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("4. Top 5: Equipos con Mayor Consumo de Mano de Obra", 14, yPos);
            yPos += 8;

            const costByAsset = {};
            laborLogs.forEach(l => {
                const ot = ots.find(o => o.id === l.idOT);
                if (ot) {
                    const eq = equipos.find(e => e.id === ot.equipoId);
                    if (eq) {
                        if (!costByAsset[eq.nombre]) costByAsset[eq.nombre] = 0;
                        costByAsset[eq.nombre] += (ot.costo || 25000);
                    }
                }
            });

            const top5Assets = Object.entries(costByAsset)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, cost]) => [name, new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(cost)]);

            doc.autoTable({
                startY: yPos,
                head: [['Equipo / Activo', 'Costo Mano de Obra Asignado']],
                body: top5Assets.length > 0 ? top5Assets : [['Sin datos suficientes', '-']],
                theme: 'striped',
                headStyles: { fillColor: [100, 116, 139] }
            });

            // Footer Multi-página
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Página ${i} de ${pageCount} | Reporte de Calidad Operativa | CMMS Advanced`, 105, 290, { align: 'center' });
            }
            doc.save(`REPORTE_CALIDAD_${Date.now()}.pdf`);
        }

        function simularIncidenteMayor() {
            if (!confirm("⚠️ SIMULACIÓN DE EMERGENCIA 360° ⚠️\n\nSe generará un escenario de crisis total:\n1. Inyección de Flota de Activos Diversos (KPIs)\n2. Falla Crítica de Equipos (AAA)\n3. Levantamientos Pendientes de Aprobación\n4. Agotamiento de Stock Crítico\n\n¿Proceder con la prueba completa?")) return;

            // 0. Inyección de Flota si hay pocos equipos (para ver los KPIs)
            if (equipos.length < 10) {
                const nuevosEquipos = [
                    { id: Date.now() + 1, nombre: "UMA Piso 5 (Norte)", area: "Piso 5", especialidad: "Clima", criticidad: "AAA", estado: "activo", dispo: 100, horas: 1200, freq: 500, historial: [], costoMantAcumulado: 0, valorMercado: 4500000 },
                    { id: Date.now() + 2, nombre: "Subestación Eléctrica T-2", area: "Sótano", especialidad: "Electricidad", criticidad: "AAA", estado: "activo", dispo: 100, horas: 4500, freq: 1000, historial: [], costoMantAcumulado: 0, valorMercado: 12000000 },
                    { id: Date.now() + 3, nombre: "Bomba Impulsora Agua Potable", area: "Sala Bombas", especialidad: "Hidráulica", criticidad: "AAA", estado: "activo", dispo: 100, horas: 800, freq: 500, historial: [], costoMantAcumulado: 0, valorMercado: 3200000 },
                    { id: Date.now() + 4, nombre: "Ascensor Servicio 01", area: "Núcleo B", especialidad: "Mecánica", criticidad: "AAA", estado: "activo", dispo: 100, horas: 8500, freq: 2000, historial: [], costoMantAcumulado: 0, valorMercado: 25000000 },
                    { id: Date.now() + 5, nombre: "Puerta Principal Automática", area: "Lobby", especialidad: "Infraestructura", criticidad: "AA", estado: "activo", dispo: 100, horas: 1500, freq: 1000, historial: [], costoMantAcumulado: 0, valorMercado: 1500000 }
                ];
                equipos.push(...nuevosEquipos);
            }

            // 1. Identificar y Dañar Equipos Críticos
            const eqClima = equipos.find(e => e.especialidad === 'Clima');
            const eqElec = equipos.find(e => e.especialidad === 'Electricidad');
            const eqHidra = equipos.find(e => e.especialidad === 'Hidráulica');

            if (eqClima) { eqClima.estado = 'peligro'; eqClima.dispo = 15; eqClima.diagnostico = "COMPRESOR TRABADO"; }
            if (eqElec) { eqElec.estado = 'peligro'; eqElec.dispo = 5; eqElec.diagnostico = "FALLA FASE C"; }
            if (eqHidra) { eqHidra.estado = 'alerta'; eqHidra.dispo = 60; eqHidra.diagnostico = "FUGA EN SELLO MECÁNICO"; }

            // 2. Generar Levantamientos (Revisiones Pendientes)
            const tec = tecnicos[0] || { id: 1, nombre: "Técnico Root" };
            const nuevasOTs = [
                {
                    id: Date.now() + 10,
                    titulo: "Reparación UMA 5 - Urgente",
                    descripcion: "Se requiere cambio de kit de rodamientos y carga de refrigerante.",
                    levantamiento: "Técnico en terreno confirma que el compresor no parte. Se midió amperaje y está fuera de rango. Requiere repuestos inmediatos.",
                    estado: "revision",
                    prioridad: "ALTA",
                    asignadoId: tec.id,
                    equipoId: eqClima ? eqClima.id : null,
                    fechaCreacion: new Date().toISOString()
                },
                {
                    id: Date.now() + 11,
                    titulo: "Falla Tablero General T-2",
                    descripcion: "Revisión de protecciones térmicas por sobrecalentamiento.",
                    levantamiento: "Se detectó punto caliente en barra principal (120°C). Se recomienda apagar celda y reajustar torque.",
                    estado: "revision",
                    prioridad: "ALTA",
                    asignadoId: tec.id,
                    equipoId: eqElec ? eqElec.id : null,
                    fechaCreacion: new Date().toISOString()
                }
            ];
            ots.push(...nuevasOTs);

            // 3. Agotar Stock de Insumos Estratégicos
            repuestos.forEach(r => {
                if (r.nombre.toLowerCase().includes('filtro') || r.nombre.toLowerCase().includes('gas') || r.nombre.toLowerCase().includes('rodamiento')) {
                    r.stock = 0;
                }
            });

            // 4. Disparar SOS Global
            const sosMsg = "⚠️ FALLA MAYOR EN SISTEMAS CRÍTICOS: PROCEDER A EVALUACIÓN DE DAÑOS";
            localStorage.setItem('cmms_global_sos', JSON.stringify([{
                id: Date.now(),
                type: '🔥 INCENDIO / FALLA 360',
                loc: 'Sótano / Sala Máquinas',
                msg: sosMsg,
                active: true,
                timestamp: new Date().toISOString()
            }]));

            // TRIGGER SENSORY ALERT (Global)
            const alertaGlobal = {
                id: Date.now(),
                tipo: 'urgente',
                mensaje: sosMsg,
                timestamp: Date.now(),
                confirmados: []
            };

            localStorage.setItem('cmms_alert', JSON.stringify(alertaGlobal));

            // PUBLICAR EN FIREBASE PARA TODOS LOS DISPOSITIVOS
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                const db = firebase.firestore();
                db.collection('cmms').doc('alerts').set({
                    ...alertaGlobal,
                    active: true
                }).then(() => {
                    console.log("🚨 SOS Global published to cloud");
                }).catch(err => {
                    console.error("❌ Error publishing SOS:", err);
                });
            }


            persist();

            // Efecto visual de "Alerta Permanente" en la sesión actual
            document.body.style.border = "4px solid var(--color-danger)";
            setTimeout(() => {
                document.body.style.border = "none";
            }, 5000);

            alert("🚨 ESCENARIO DE CRISIS ACTIVADO 🚨\n\n1. Nuevos activos inyectados para KPIs.\n2. Equipos críticos fallando.\n3. Levantamientos pendientes (Requieren aprobación).\n4. Quiebre de Stock total en insumos básicos.");
            navigate('dashboard');
        }

        function forzarCierreOT(id) {
            const ot = ots.find(o => o.id === id);
            if (!ot) return;

            if (!confirm(`¿Forzar cierre administrativo de la OT #${id}: "${ot.titulo}"?\n\nEsto simulará que el técnico completó el trabajo.`)) return;

            // Simular lógica de cierre
            ot.estado = 'completada';
            ot.comentario_tecnico = "Cierre administrativo forzado (Testing Mode).";
            ot.condiciones_finales = "Equipo operativo tras intervención forzada.";
            ot.horas = 2; // Simulado
            ot.costo = 50000; // Simulado
            ot.archivado = false; // Para que aparezca en auditoría
            ot.fechaFin = new Date().toISOString().split('T')[0];

            // Registrar Log para que cuente en gráficos
            laborLogs.push({
                idOT: ot.id,
                idTec: ot.asignadoId,
                action: 'fin',
                timestamp: new Date().toISOString()
            });

            // Actualizar equipo
            const eq = equipos.find(e => e.id === ot.equipoId);
            if (eq) {
                eq.estado = 'activo';
                eq.dispo = 100;
                // Add to history
                if (!eq.historial) eq.historial = [];
                eq.historial.unshift({
                    fecha: new Date().toISOString().split('T')[0],
                    tarea: ot.titulo,
                    tecnico: "ADMIN FORCE",
                    desc: "Cierre forzado en pruebas.",
                    costo: 50000,
                    tipo: ot.tipo
                });
            }

            persist();
            logManagementAction('Fuerza Admin', `Cierre forzado de OT #${id}`, 'gavel');
            alert("OT Cerrada Forzosamente. Gráficos y Reportes actualizados.");
            navigate('dashboard');
        }

        function generarDatosDemo() {
            if (!confirm("Esto generará datos de prueba avanzados (incluyendo Infraestructura, Pintura, Calderas, etc.). ¿Continuar?")) return;

            // 0. RESTAURACIÓN DE TÉCNICOS (Fix para "Solo Juan")
            const missingMarta = !tecnicos.find(t => t.nombre.includes("Marta"));
            const missingDiego = !tecnicos.find(t => t.nombre.includes("Diego"));

            if (tecnicos.length < 5 || missingMarta || missingDiego) {
                console.log("Detectada lista de técnicos incompleta o desactualizada. Restaurando equipo completo...");
                tecnicos = JSON.parse(JSON.stringify(defaultTecnicos)); // Deep copy backup
                localStorage.setItem('cmms_tecnicos', JSON.stringify(tecnicos)); // FORCE SAVE IMMEDIATELY
                localStorage.setItem('pending_demo_gen', 'true'); // Flag para auto-ejecutar al volver
                alert("♻️ Se ha restaurado la planilla completa de técnicos. La página se recargará y generará los datos automáticamente.");
                location.reload();
                return;
            }

            // 0.1 ACTUALIZACIÓN AUTOMÁTICA DE ROLES
            const diego = tecnicos.find(t => t.id === 7 || t.nombre.includes('Diego'));
            if (diego) {
                diego.especialidad = 'Infraestructura';
                persist();
            }

            // 1. Simular Equipos Críticos y de Infraestructura
            const demoEquipos = [
                { nombre: 'Chiller Centrifugo 01', area: 'Sala Máquinas', especialidad: 'Clima', estado: 'activo' },
                { nombre: 'Caldera Principal ACS', area: 'Sala Calderas', especialidad: 'Termodinámica', estado: 'peligro' },
                { nombre: 'Generador Emergencia', area: 'Patio Trasero', especialidad: 'Electricidad', estado: 'activo' },
                { nombre: 'Bomba de Agua Potable 1', area: 'Sala Bombas', especialidad: 'Hidráulica', estado: 'alerta' },
                { nombre: 'Ascensor Servicio', area: 'Lobby', especialidad: 'Mecánica', estado: 'peligro' },
                { nombre: 'Fachada Norte (Pintura)', area: 'Exterior', especialidad: 'Infraestructura', estado: 'alerta' },
                { nombre: 'Reja Perimetral Acceso', area: 'Exterior', especialidad: 'Infraestructura', estado: 'activo' },
                { nombre: 'Baños Lobby Central', area: 'Lobby', especialidad: 'Infraestructura', estado: 'activo' },
                { nombre: 'Techo Sala Eventos', area: 'Piso 2', especialidad: 'Infraestructura', estado: 'activo' }
            ];

            demoEquipos.forEach((d, i) => {
                let tecEsp = tecnicos.find(t => t.especialidad === d.especialidad);
                if (!tecEsp && d.especialidad === 'Termodinámica') tecEsp = tecnicos.find(t => t.especialidad === 'Mecánica');
                if (!tecEsp) tecEsp = tecnicos.find(t => t.especialidad === 'General') || tecnicos[0];

                const eqId = Date.now() + i;
                const historial = [];

                // Simular historial para KPIs (MTTR/MTBF)
                if (d.estado !== 'activo' || i % 2 === 0) {
                    const baseDate = new Date();
                    baseDate.setDate(baseDate.getDate() - 45);

                    for (let j = 0; j < 3; j++) {
                        const repairDate = new Date(baseDate);
                        repairDate.setDate(repairDate.getDate() + (j * 15));

                        const otId = eqId + 1000 + j;
                        const durationHrs = 2 + Math.random() * 6;

                        historial.push({
                            fecha: repairDate.toISOString().split('T')[0],
                            tarea: "Reparación " + (j + 1),
                            tecnico: tecEsp.nombre,
                            especialidad: tecEsp.especialidad,
                            desc: "Intervención técnica programada.",
                            costo: 15000 + Math.random() * 20000,
                            tipo: 'correctivo'
                        });

                        laborLogs.push({
                            idOT: otId, idTec: tecEsp.id, action: 'inicio',
                            timestamp: new Date(repairDate.getTime()).toISOString()
                        });
                        laborLogs.push({
                            idOT: otId, idTec: tecEsp.id, action: 'fin',
                            timestamp: new Date(repairDate.getTime() + durationHrs * 3600000).toISOString()
                        });

                        ots.push({
                            id: otId, titulo: "Reparación " + (j + 1), asignadoId: tecEsp.id,
                            estado: 'completada', equipoId: eqId, tipo: 'correctivo', archivado: true,
                            fechaCreacion: repairDate.toISOString()
                        });
                    }
                }

                equipos.push({
                    id: eqId,
                    nombre: d.nombre,
                    marca: 'SimulatedAsset',
                    modelo: 'Gen-2025',
                    area: d.area,
                    estado: d.estado,
                    isCritico: d.estado === 'peligro' || d.nombre.includes('Caldera'),
                    especialidad: d.especialidad,
                    responsableId: tecEsp.id,
                    fechaInicio: '2025-01-01',
                    dispo: d.estado === 'activo' ? 100 : 80,
                    historial: historial,
                    costoMantAcumulado: historial.reduce((acc, h) => acc + h.costo, 0)
                });
            });

            // 2. Simular OTs con narrativa realista
            const escenarios = [
                { titulo: "Retoque Pintura Hab 301-310", tipo: "programado", prio: "MEDIA", esp: "Infraestructura" },
                { titulo: "Fuga en WC Discapacitados", tipo: "correctivo", prio: "ALTA", esp: "Infraestructura" },
                { titulo: "Soldadura Bisagra Portón", tipo: "correctivo", prio: "MEDIA", esp: "Infraestructura" },
                { titulo: "Filtro Aire Bloqueado Chiller", tipo: "preventivo", prio: "MEDIA", esp: "Clima" },
                { titulo: "Ruido Anormal Motor Ascensor", tipo: "correctivo", prio: "ALTA", esp: "Mecánica" },
                { titulo: "Fuga Gas Válvula Caldera", tipo: "correctivo", prio: "ALTA", esp: "Termodinámica" }
            ];

            for (let i = 0; i < 6; i++) {
                const escenario = escenarios[i % escenarios.length];
                const eq = equipos.find(e => e.especialidad === escenario.esp) || equipos[Math.floor(Math.random() * equipos.length)];
                const tec = tecnicos.find(t => t.id === eq.responsableId) || tecnicos[0];

                const estados = ['levantamiento', 'revision', 'ejecucion'];
                const randEstado = estados[Math.floor(Math.random() * estados.length)];

                ots.push({
                    id: Date.now() + 200 + i,
                    titulo: escenario.titulo,
                    descripcion: "Simulación automática basada en escenario operativo común.",
                    prioridad: escenario.prio,
                    asignadoId: tec.id,
                    estado: randEstado,
                    equipoId: eq.id,
                    fechaCreacion: new Date().toISOString(),
                    archivado: false,
                    tipo: escenario.tipo
                });
            }

            // 2.1 Simular OTs COMPLETADAS HOY (Para Gráficos de Rendimiento Día)
            const tareasHoy = ["Limpieza Filtros", "Revisión Tablero", "Ajuste Válvula", "Cambio Luminaria", "Engrase Rodamiento"];
            tecnicos.slice(0, 5).forEach((t, i) => { // Asegurar que al menos 5 técnicos tengan cierres hoy
                const otId = Date.now() + 5000 + i;
                const horaInicio = new Date();
                horaInicio.setHours(9 + i, 0, 0, 0); // Esparcir en el día
                const horaFin = new Date(horaInicio);
                horaFin.setHours(horaInicio.getHours() + 1);

                ots.push({
                    id: otId,
                    titulo: tareasHoy[i % tareasHoy.length] + " (Rápida)",
                    asignadoId: t.id,
                    estado: 'completada',
                    equipoId: 1, // Genérico
                    tipo: 'programado',
                    fechaCreacion: new Date().toISOString()
                });

                laborLogs.push({ idOT: otId, idTec: t.id, action: 'inicio', timestamp: horaInicio.toISOString() });
                laborLogs.push({ idOT: otId, idTec: t.id, action: 'fin', timestamp: horaFin.toISOString() });
            });

            // 3. Simular Hallazgos de Herramientas y Seguridad (NUEVO)
            // 3. Simular Hallazgos de Herramientas y Seguridad (NUEVO)
            toolLogs.push({
                id: Date.now() + 999,
                tecnico: "Juan Pérez",
                itemId: 102,
                tipo: 'tool',
                nombre: 'Multímetro Fluke',
                estado: 'daniado',
                fecha: new Date().toISOString()
            });

            persist();
            // location.reload(); <-- ELIMINADO para evitar confusión visual
            renderCurrentView(); // Refrescar vista inmediatamente
            alert("✅ DATOS GENERADOS CON ÉXITO\n\n- Se han actualizado los KPIs.\n- Se han creado OTs de prueba.\n- El Dashboard debe reflejar los cambios ahora.");
            document.getElementById('app-loader').style.display = 'none'; // Asegurar que no quede loader pegado
        }

        function toggleDiagField() {
            const st = document.getElementById('eq-estado').value;
            const div = document.getElementById('div-diag');
            if (div) div.style.display = (st === 'activo') ? 'none' : 'block';
        }

        function saveEquipo() {
            const id = document.getElementById('eq-id').value;
            const nombre = document.getElementById('eq-nombre').value;
            const area = document.getElementById('eq-area').value;
            const marca = document.getElementById('eq-marca') ? document.getElementById('eq-marca').value : "";
            const modelo = document.getElementById('eq-modelo') ? document.getElementById('eq-modelo').value : "";
            const capacidad = document.getElementById('eq-capacidad') ? document.getElementById('eq-capacidad').value : "";
            const refrigerante = document.getElementById('eq-refrigerante') ? document.getElementById('eq-refrigerante').value : "";
            const tension = document.getElementById('eq-tension') ? document.getElementById('eq-tension').value : "";
            const compresor = document.getElementById('eq-compresor') ? document.getElementById('eq-compresor').value : "";
            const horas = document.getElementById('eq-horas').value;
            const freq = document.getElementById('eq-freq').value;
            const isCritico = document.getElementById('eq-is-critico').checked;
            const estado = document.getElementById('eq-estado').value;
            const diagnostico = document.getElementById('eq-diagnostico') ? document.getElementById('eq-diagnostico').value : "";
            const notas = document.getElementById('eq-notas').value;
            const fechaInicio = document.getElementById('eq-fecha-inicio') ? document.getElementById('eq-fecha-inicio').value : "2026-01-01";
            const especialidad = document.getElementById('eq-especialidad').value;
            const responsableId = document.getElementById('eq-responsable') ? parseInt(document.getElementById('eq-responsable').value) : null;
            const previewImg = document.getElementById('preview-img');
            const previewVisible = document.getElementById('foto-preview').style.display !== 'none';
            const foto = (previewImg && previewVisible) ? previewImg.src : null;

            const valorMercado = parseFloat(document.getElementById('eq-valor-mercado').value) || 0;
            const valorAdq = parseFloat(document.getElementById('eq-valor-adq').value) || 0;

            if (!nombre || !area) return alert("Nombre y Área son obligatorios.");

            if (id) {
                // Update
                const idx = equipos.findIndex(e => e.id == id);
                if (idx !== -1) {
                    equipos[idx] = {
                        ...equipos[idx],
                        nombre, area, marca, modelo,
                        capacidad, refrigerante, tension, compresor,
                        horas: parseInt(horas) || 0,
                        freq: parseInt(freq) || 0,
                        isCritico,
                        estado, notas, fechaInicio,
                        diagnostico: estado !== 'activo' ? diagnostico : '',
                        especialidad, responsableId,
                        valorMercado, valorAdquisicion: valorAdq,
                        foto: (foto && foto.startsWith('data:')) ? foto : (foto ? equipos[idx].foto : null)
                    };
                }
            } else {
                // New
                equipos.push({
                    id: Date.now(),
                    nombre, area, marca, modelo,
                    capacidad, refrigerante, tension, compresor,
                    horas: parseInt(horas) || 0,
                    freq: parseInt(freq) || 0,
                    isCritico,
                    estado, notas, fechaInicio,
                    diagnostico: estado !== 'activo' ? diagnostico : '',
                    especialidad, responsableId,
                    valorMercado, valorAdquisicion: valorAdq,
                    foto: (foto && foto.startsWith('data:')) ? foto : null,
                    dispo: 100,
                    historial: [],
                    costoMantAcumulado: 0
                });
            }

            persist();
            closeModal();
            navigate('activos');
        }

        function saveRegistroTrabajo() {
            const otId = parseInt(document.getElementById('reg-id').value);
            const horas = parseFloat(document.getElementById('reg-horas').value) || 0;
            const insumosValue = parseFloat(document.getElementById('reg-insumos').value) || 0;
            const desc = document.getElementById('reg-desc').value;
            const estadoFinal = document.getElementById('reg-estado-equipo').value;

            if (!desc) return alert("Describe la actividad realizada.");

            const ot = ots.find(o => o.id === otId);
            if (!ot) return;

            const eq = equipos.find(e => e.id === ot.equipoId) || equipos.find(e => e.nombre === ot.titulo || ot.titulo.includes(e.nombre));
            const tec = tecnicos.find(t => t.id === ot.asignadoId);

            // Calcular costo de la tarea (HH * costoHora + Insumos)
            const costoHH = tec && tec.costoHora ? (tec.costoHora * horas) : (4500 * horas); // Fallback rate
            const costoTotalTarea = costoHH + insumosValue;

            // --- OFFLINE INTERCEPTION ---
            if (isOffline) {
                // Store in Queue
                const pendingAction = {
                    type: 'OT_CLOSE',
                    timestamp: new Date().toISOString(),
                    payload: {
                        id: otId,
                        desc: desc,
                        horas: horas,
                        costo: costoTotalTarea,
                        estadoFinal: estadoFinal
                    }
                };
                syncQueue.push(pendingAction);
                localStorage.setItem('cmms_sync_queue', JSON.stringify(syncQueue));
                updateSyncQueueUI();

                // Optimistic UI Update (Optional, but let's keep it 'pending' visually)
                // For this demo, we will just mark it locally as "EN COLA" to visualize
                // Note: We DON'T change ot.estado to 'completada' yet in the main DB to simulate "not on server"

                alert("💾 Guardado en Cola de Sincronización (Offline)");
                closeModalRegistro();
                navigate('ots'); // Go back to list
                return;
            }

            ot.estado = 'completada';
            ot.comentario_tecnico = desc;
            ot.horas = horas;
            ot.costo = costoTotalTarea;
            ot.archivado = false;

            if (eq) {
                eq.estado = estadoFinal;
                if (estadoFinal === 'activo') eq.dispo = 100;

                eq.costoMantAcumulado = (eq.costoMantAcumulado || 0) + costoTotalTarea;

                const record = {
                    fecha: new Date().toISOString().split('T')[0],
                    tarea: ot.titulo,
                    tecnico: tec ? tec.nombre : 'S/A',
                    especialidad: tec ? tec.especialidad : 'General',
                    desc: desc,
                    costo: costoTotalTarea,
                    tipo: ot.tipo || 'no_programado'
                };
                if (!eq.historial) eq.historial = [];
                eq.historial.unshift(record);
            }

            laborLogs.push({ idOT: otId, idTec: ot.asignadoId, action: 'fin', timestamp: new Date().toISOString() });

            persist();
            closeModalRegistro();
            navigate('personal_dashboard');
        }

        // --- ACCIONES DE PERSONAL ---
        function openModalTecnico(t = null) {
            const modal = document.getElementById('modal-tecnico');
            if (t) {
                document.getElementById('modal-tecnico-title').innerText = "Editar Técnico";
                document.getElementById('tec-id').value = t.id;
                document.getElementById('tec-nombre').value = t.nombre;
                document.getElementById('tec-nombre').value = t.nombre;

                // SKILLS MATRIX POPULATION
                // Normalize skills: If array, use it. If string (legacy), wrap it. If missing, empty.
                const userSkills = (t.skills && Array.isArray(t.skills)) ? t.skills : (t.especialidad ? [t.especialidad] : []);

                document.querySelectorAll('#tec-skills-container input').forEach(input => {
                    input.checked = userSkills.includes(input.value);
                });

                // SUPERVISOR LOCK (Admin or Self-Edit ONLY ONCE)
                const skillInputs = document.querySelectorAll('#tec-skills-container input');
                const isSelf = (currentRole === 'tecnico' && currentUser && currentUser.id === t.id);

                // Allow edit if: Admin OR (Self AND Not Locked)
                const canEditSkills = (currentRole === 'admin') || (isSelf && !t.profileLocked);

                // DEBUG PROBE
                if (isSelf) {
                    console.log(`Debug: User=${currentUser.nombre}, Locked=${t.profileLocked}, CanEdit=${canEditSkills}`);
                    // Uncomment the alert below if you really need to scream at the user
                    // alert(`Debug Mode:\nLocked: ${t.profileLocked}\nCan Edit: ${canEditSkills}`); 
                }

                if (canEditSkills) {
                    skillInputs.forEach(i => i.disabled = false);
                    document.getElementById('lbl-especialidades').innerHTML = '✅ Especialidades (Seleccione Múltiples)';
                } else {
                    skillInputs.forEach(i => i.disabled = true);
                    const msg = (isSelf && t.profileLocked) ? '(PERFIL BLOQUEADO - CONTACTE AL SUPERVISOR)' : '(SOLO LECTURA)';
                    document.getElementById('lbl-especialidades').innerHTML = `Especialidades <span style="color:var(--color-danger); font-size:0.6rem;">${msg}</span>`;
                }

                // Protect Sensitive Fields if not Admin
                document.getElementById('tec-eficacia').disabled = (currentRole !== 'admin');
                document.getElementById('tec-salario').disabled = (currentRole !== 'admin');
                document.getElementById('tec-is-titular').disabled = (currentRole !== 'admin');

                document.getElementById('tec-eficacia').value = t.eficacia;
                document.getElementById('tec-salario').value = t.salario || "";

                // Helper to update HH display
                const costoHora = t.costoHora || (t.salario ? (t.salario / 180).toFixed(0) : 0);
                document.getElementById('tec-costo-hora-display').value = costoHora;

                // Cargar nuevos campos
                document.getElementById('tec-is-titular').checked = t.isTitular || false;
                document.getElementById('tec-turno-inicio').value = t.turno ? t.turno.inicio : "08:00";
                document.getElementById('tec-turno-fin').value = t.turno ? t.turno.fin : "18:00";

            } else {
                document.getElementById('modal-tecnico-title').innerText = "Nuevo Técnico";
                document.getElementById('tec-id').value = "";
                document.getElementById('tec-nombre').value = "";
                document.getElementById('tec-nombre').value = "";
                // Reset Skills
                document.querySelectorAll('#tec-skills-container input').forEach(input => input.checked = false);
                // SUPERVISOR LOCK (Admin Only)
                const skillInputs = document.querySelectorAll('#tec-skills-container input');
                if (currentRole !== 'admin') {
                    skillInputs.forEach(i => i.disabled = true);
                } else {
                    skillInputs.forEach(i => i.disabled = false);
                }
                document.getElementById('tec-eficacia').value = "100";
                document.getElementById('tec-salario').value = "";
                document.getElementById('tec-costo-hora-display').value = "";

                document.getElementById('tec-is-titular').checked = false;
                document.getElementById('tec-turno-inicio').value = "08:00";
                document.getElementById('tec-turno-fin').value = "18:00";
            }
            modal.style.display = 'flex';
        }

        function updateCalculatedHH() {
            const salario = parseFloat(document.getElementById('tec-salario').value) || 0;
            // Cálculo basado en 30 días (Mes comercial) y jornada estándar (8h/día efectiva)
            const hh = (salario / 30 / 8).toFixed(0);
            document.getElementById('tec-costo-hora-display').value = hh;
        }

        function closeModalTecnico() {
            document.getElementById('modal-tecnico').style.display = 'none';
        }

        // --- FUNCIONES DE BALANCEO DE CARGA ---
        let balanceCandidates = [];
        let balanceTargetId = null;

        function openBalanceModal() {
            // 1. Identify Overloaded Tech (Max active OTs)
            const activeOTs = ots.filter(o => o.estado !== 'completada');
            const counts = tecnicos.map(t => {
                return { id: t.id, name: t.nombre, count: activeOTs.filter(o => o.asignadoId === t.id).length, skills: t.skills || [t.especialidad] };
            });

            const max = counts.reduce((prev, current) => (prev.count > current.count) ? prev : current);
            const min = counts.reduce((prev, current) => (prev.count < current.count) ? prev : current);

            if (max.count - min.count < 2) return alert("El desbalance no es suficiente para sugerir cambios automáticos.");

            balanceTargetId = min.id;

            // 2. Filter Movable Tasks (Skill Match)
            const sourceOTs = activeOTs.filter(o => o.asignadoId === max.id && o.estado === 'levantamiento'); // Only move not-started

            // Skill Check: Can 'min' do these tasks?
            const movableOTs = sourceOTs.filter(o => {
                const eq = equipos.find(e => e.id === o.equipoId);
                const spec = eq ? eq.especialidad : 'General';
                // Check if target tech has this skill
                return min.skills.includes(spec) || min.skills.includes('General');
            });

            if (movableOTs.length === 0) return alert(`No hay tareas compatibles para mover de ${max.name} a ${min.name}. Verifique especialidades.`);

            // 3. Populate Modal
            document.getElementById('bal-src-name').innerText = max.name.split(' ')[0];
            document.getElementById('bal-src-count').innerText = `${max.count} Tareas`;

            document.getElementById('bal-tgt-name').innerText = min.name.split(' ')[0];
            document.getElementById('bal-tgt-count').innerText = `${min.count} Tareas`;

            const list = document.getElementById('balance-tasks-list');
            list.innerHTML = movableOTs.map(o => `
                <div style="display: flex; gap: 10px; align-items: center; padding: 6px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <input type="checkbox" class="bal-chk" value="${o.id}" checked>
                    <div style="font-size: 0.7rem; text-align: left;">
                        <div style="font-weight: bold; color: white;">#${o.id} - ${o.titulo}</div>
                        <div style="color: var(--color-text-muted);">${o.prioridad}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('modal-balance').style.display = 'flex';
        }

        function closeBalanceModal() {
            document.getElementById('modal-balance').style.display = 'none';
        }

        function executeBalance() {
            const checkboxes = document.querySelectorAll('.bal-chk:checked');
            if (checkboxes.length === 0) return;

            let count = 0;
            checkboxes.forEach(cb => {
                const ot = ots.find(o => o.id == cb.value);
                if (ot && balanceTargetId) {
                    ot.asignadoId = balanceTargetId;
                    count++;
                }
            });

            persist();
            alert(`✅ Reasignación Exitosa: ${count} tareas movidas.`);
            closeBalanceModal();
            navigate('dashboard'); // Refresh
        }

        function saveTecnico() {
            const id = document.getElementById('tec-id').value;
            const nombre = document.getElementById('tec-nombre').value;
            // Removed especialidad select reading
            const eficacia = parseInt(document.getElementById('tec-eficacia').value) || 0;
            const salario = parseFloat(document.getElementById('tec-salario').value) || 0;
            const costoHora = (salario / 30 / 8).toFixed(0);

            if (!nombre) return alert("Nombre es obligatorio.");

            const skills = Array.from(document.querySelectorAll('#tec-skills-container input:checked')).map(cb => cb.value);
            if (skills.length === 0) skills.push('General');

            const tecData = {
                nombre,
                eficacia,
                especialidad: skills[0], // Primary for legacy compatibility
                skills: skills,
                salario,
                costoHora: parseInt(costoHora),
                isTitular: document.getElementById('tec-is-titular').checked,
                turno: {
                    inicio: document.getElementById('tec-turno-inicio').value,
                    fin: document.getElementById('tec-turno-fin').value,
                    colacion: 60
                }
            };

            // LOCK PROFILE IF SAVED BY TECHNICIAN (One-Time Entry)
            if (currentRole === 'tecnico') {
                tecData.profileLocked = true;
            }

            if (id) {
                const idx = tecnicos.findIndex(t => t.id == id);
                if (idx !== -1) {
                    // Preserve existing lock if Admin is editing (don't unlock automatically, allow admin to unset if they want - for now just preserve old state if not explicitly setting)
                    // Actually, if Admin saves, we might want to keep it locked or unlock it? 
                    // Let's say: Admin edits -> Lock status preserved (or set to whatever logic fits). 
                    // For now, only Tech sets it to true. Admin doesn't change it unless we add a UI toggle.
                    // But we merge existing data, so if it was true, it stays true.

                    const oldData = tecnicos[idx];
                    tecnicos[idx] = { ...oldData, ...tecData };

                    // Specific override: If Admin is saving, maybe they want to Keep it locked? 
                    // If Tech saves, it Becomes locked.
                }
            } else {
                tecnicos.push({
                    id: Date.now(),
                    userCode: nombre.split(' ')[0].toUpperCase(),
                    password: '123',
                    ...tecData
                });
            }

            persist();
            closeModalTecnico();
            navigate('personal');
        }

        function editTecnico(id) {
            const t = tecnicos.find(x => x.id === id);
            if (t) openModalTecnico(t);
        }

        // Preview de imagen para Técnico
        const tecFileInput = document.getElementById('tec-foto');
        if (tecFileInput) {
            tecFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = new Image();
                        img.onload = function () {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 200;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            document.getElementById('tec-preview-img').src = canvas.toDataURL('image/jpeg', 0.7);
                            document.getElementById('tec-foto-preview').style.display = 'block';
                        }
                        img.src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // Preview de imagen para Equipo
        const eqFileInput = document.getElementById('eq-foto');
        if (eqFileInput) {
            eqFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = new Image();
                        img.onload = function () {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 600;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            document.getElementById('preview-img').src = canvas.toDataURL('image/jpeg', 0.8);
                            document.getElementById('foto-preview').style.display = 'block';
                        }
                        img.src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        function login() {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const error = document.getElementById('login-error');

            if (user.toLowerCase() === 'admin' && pass === 'admin') {
                currentRole = 'admin';
                currentUser = { nombre: 'Administrator' };
                sessionStorage.setItem('cmms_session', JSON.stringify({ role: 'admin', user: currentUser }));
                startApp();
            } else {
                const tec = tecnicos.find(t => t.userCode.toLowerCase() === user.toLowerCase() && t.password === pass);
                if (tec) {
                    currentRole = 'tecnico';
                    currentUser = tec;
                    sessionStorage.setItem('cmms_session', JSON.stringify({ role: 'tecnico', user: tec }));
                    startApp();
                } else {
                    error.style.display = 'block';
                    error.innerText = "Usuario o contraseña incorrectos";
                }
            }
        }

        // --- AUDIO UNLOCKER FOR MOBILE ---
        let globalAudioCtx = null;

        function unlockAudio() {
            if (!globalAudioCtx) {
                globalAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (globalAudioCtx.state === 'suspended') {
                globalAudioCtx.resume();
            }
            // Play silent buffer
            const buffer = globalAudioCtx.createBuffer(1, 1, 22050);
            const source = globalAudioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(globalAudioCtx.destination);
            source.start(0);
            console.log("🔊 Audio Context Resumed");
        }

        function logout() {
            sessionStorage.removeItem('cmms_session');
            sessionStorage.setItem('explicit_logout', 'true'); // Bandera para no auto-loguear
            location.reload();
        }

        function startApp() {
            unlockAudio(); // Unlock audio on first interaction
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';

            const title = currentRole === 'admin' ? 'SUPERVISOR - PC' : 'TÉCNICO - MOBILE';
            document.getElementById('app-title').innerText = title;

            const sidebarOTs = document.getElementById('nav-ots');
            if (sidebarOTs) {
                sidebarOTs.innerHTML = currentRole === 'admin' ?
                    '<span class="material-symbols-rounded">assignment_turned_in</span> Auditoría y Cierres' :
                    '<span class="material-symbols-rounded">assignment</span> Mis Tareas';
            }

            // Actualizar interfaz según rol
            const roleBadge = document.getElementById('role-badge');
            roleBadge.innerText = currentRole === 'admin' ? 'SUPERVISOR - PC' : 'TÉCNICO - MÓVIL';
            roleBadge.style.background = currentRole === 'admin' ? 'rgba(59,130,246,0.2)' : 'rgba(245,158,11,0.1)';
            roleBadge.style.borderColor = currentRole === 'admin' ? 'var(--color-primary)' : 'var(--color-warning)';
            roleBadge.style.color = currentRole === 'admin' ? 'var(--color-primary)' : 'var(--color-warning)';

            // Refuerzo visual para el header en Admin
            const header = document.querySelector('header');
            if (header) {
                header.style.borderBottom = currentRole === 'admin' ? '2px solid var(--color-primary)' : '1px solid var(--color-border)';
            }

            // Actualizar avatar en Header
            const avatarHeader = document.getElementById('header-avatar-container');
            if (avatarHeader && currentUser) {
                if (currentUser.foto) {
                    avatarHeader.innerHTML = `<img src="${currentUser.foto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-primary);">`;
                } else {
                    avatarHeader.innerHTML = `<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--color-surface-hover); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--color-primary); border: 1px solid var(--color-primary); font-size: 0.8rem;">${(currentUser.nombre || 'A').charAt(0)}</div>`;
                }
            }

            // Show floating buttons (AI Assistant and Refresh)
            const aiButton = document.getElementById('ai-chat-button');
            const refreshButton = document.getElementById('refresh-button');
            if (aiButton) aiButton.style.display = 'flex';
            if (refreshButton) refreshButton.style.display = 'flex';

            applyRolePermissions();
            navigate(currentRole === 'admin' ? 'dashboard' : 'ots');

            // FIREBASE: Activar listeners en tiempo real (INLINE para asegurar ejecución)
            console.log("🔥 Attempting to start Firebase real-time listeners...");
            console.log("🔥 currentUser:", currentUser);
            console.log("🔥 firebase available:", typeof firebase !== 'undefined');

            if (typeof firebase !== 'undefined' && firebase.firestore && currentUser) {
                const db = firebase.firestore();
                console.log("🎧 Starting real-time listeners for user:", currentUser.nombre);

                // Listener de OTs
                let previousMyOTIds = ots.filter(o => o.asignadoId === currentUser.id).map(o => o.id);
                console.log("📋 Initial OT IDs for", currentUser.nombre, ":", previousMyOTIds);

                db.collection('cmms').doc('ots').onSnapshot((doc) => {
                    console.log("📋 OT snapshot received!");
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.lista && Array.isArray(data.lista)) {
                            const misOTsEnCloud = data.lista.filter(o => o.asignadoId === currentUser.id);
                            const nuevasOTs = misOTsEnCloud.filter(o => !previousMyOTIds.includes(o.id));

                            console.log("📋 My OTs in cloud:", misOTsEnCloud.length);
                            console.log("📋 New OTs detected:", nuevasOTs.length);

                            if (nuevasOTs.length > 0) {
                                nuevasOTs.forEach(nuevaOT => {
                                    console.log("📋 New OT received from cloud:", nuevaOT.titulo);

                                    // Disparar alerta sensorial
                                    if (typeof activarAlertaSensorial === 'function') {
                                        activarAlertaSensorial({
                                            mensaje: `Nueva tarea asignada: ${nuevaOT.titulo}`,
                                            tipo: 'urgente'
                                        });
                                    } else {
                                        console.warn("⚠️ activarAlertaSensorial not available");
                                    }
                                });
                            }

                            // Actualizar el array completo
                            ots.length = 0;
                            ots.push(...data.lista);

                            // Actualizar snapshot previo
                            previousMyOTIds = ots.filter(o => o.asignadoId === currentUser.id).map(o => o.id);

                            // Actualizar vista si estamos en la pantalla de OTs
                            if (nuevasOTs.length > 0 && currentPage === 'ots') {
                                navigate('ots');
                            }
                        }
                    }
                });
                console.log("✅ OT listener active");

                // Listener de alertas
                db.collection('cmms').doc('alerts').onSnapshot((doc) => {
                    console.log("🔔 Alert snapshot received!");
                    if (doc.exists) {
                        const alertData = doc.data();

                        if (alertData.active && alertData.mensaje) {
                            const yaConfirmada = alertData.confirmados && alertData.confirmados.includes(currentUser.id);
                            const isForMe = !alertData.targetId || alertData.targetId === currentUser.id;
                            const esVigente = (Date.now() - alertData.timestamp) < 3600000;

                            console.log("🔔 Alert check:", { yaConfirmada, isForMe, esVigente });

                            if (esVigente && !yaConfirmada && isForMe) {
                                console.log("🔔 Triggering alert:", alertData.mensaje);
                                if (typeof activarAlertaSensorial === 'function') {
                                    activarAlertaSensorial(alertData);
                                }
                            }
                        }
                    }
                });
                console.log("✅ Alert listener active");
            } else {
                console.error("❌ Cannot start listeners - Firebase or currentUser not available");
            }
        }

        // --- LÓGICA DE TRIAJE INTEGIGENTE ---
        function procesarTriaje() {
            const text = document.getElementById('triaje-input').value.trim();
            if (!text) return alert("Pega un requerimiento para analizar.");

            // Análisis básico (Simulando IA)
            const lowText = text.toLowerCase();
            let prioridad = "BAJA";
            if (lowText.includes("urgente") || lowText.includes("falla") || lowText.includes("no funciona") || lowText.includes("emergencia") || lowText.includes("agua") || lowText.includes("luz")) {
                prioridad = "ALTA";
            }

            // Sugerencia de técnico basada en especialidad y carga (simulado)
            // En una app real esto consultaría laborLogs y especialidad del técnico.
            const sugerido = tecnicos[0]; // Por defecto el primero (demo)

            const resultCont = document.getElementById('triaje-result-container');
            resultCont.innerHTML = `
                <div class="card" style="border-left: 4px solid ${prioridad === 'ALTA' ? 'var(--color-danger)' : 'var(--color-primary)'}; background: rgba(255,255,255,0.03);">
                    <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800; margin-bottom: 5px;">RESULTADO DEL ANÁLISIS:</div>
                    <div style="font-size: 0.85rem; font-weight: 700;">${text}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <div>
                            <label style="font-size: 0.6rem; color: var(--color-text-muted);"> PRIORIDAD SUGERIDA</label>
                            <select id="tri-prioridad" class="form-control" style="font-size: 0.75rem; padding: 4px;">
                                <option value="ALTA" ${prioridad === 'ALTA' ? 'selected' : ''}>ALTA</option>
                                <option value="MEDIA">MEDIA</option>
                                <option value="BAJA" ${prioridad === 'BAJA' ? 'selected' : ''}>BAJA</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.6rem; color: var(--color-text-muted);"> TÉCNICO SUGERIDO</label>
                            <select id="tri-tecnico" class="form-control" style="font-size: 0.75rem; padding: 4px;">
                                ${tecnicos.map(t => `<option value="${t.id}" ${t.id === sugerido.id ? 'selected' : ''}>${t.nombre} (${t.especialidad})</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <button onclick="despacharOT()" class="btn btn-primary" style="width: 100%; margin-top: 15px; font-weight: 800;">CONFIRMAR Y DESPACHAR ALERTA</button>
                </div>
            `;
            resultCont.style.display = 'block';
        }

        function despacharOT() {
            const text = document.getElementById('triaje-input').value;
            const prio = document.getElementById('tri-prioridad').value;
            const tecId = parseInt(document.getElementById('tri-tecnico').value);

            const newOT = {
                id: Date.now(),
                titulo: text.substring(0, 30) + (text.length > 30 ? '...' : ''),
                descripcion: text,
                prioridad: prio,
                asignadoId: tecId,
                estado: 'ejecucion',
                notificado: false
            };

            ots.push(newOT);
            persist();

            // PUBLICAR OT EN FIREBASE PARA SINCRONIZACIÓN
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                const db = firebase.firestore();
                db.collection('cmms').doc('ots').set({
                    lista: ots,
                    lastUpdate: Date.now()
                }).then(() => {
                    console.log("📋 OT published to cloud:", newOT.id);
                }).catch(err => {
                    console.error("❌ Error publishing OT:", err);
                });
            }

            // Simular el disparo de la alerta sensorial para el técnico (vía canal de datos/socket en una app real)
            if (prio === 'ALTA') {
                dispararAlertaSensorial(tecId, "NUEVA TAREA URGENTE: " + newOT.titulo);
            }

            alert("Orden despachada con éxito.");
            document.getElementById('triaje-input').value = "";
            document.getElementById('triaje-result-container').style.display = 'none';
            navigate('dashboard');
        }

        // --- SISTEMA SENSORIAL (VIBRACIÓN Y SONIDO) ---
        function dispararReunion(tipo) {
            const loc = document.getElementById('meeting-location').value;
            const timeInput = document.getElementById('meeting-time').value;

            let msg = "";
            if (tipo === 'urgente') {
                msg = `¡REUNIÓN URGENTE! Presentarse de inmediato en: ${loc}`;
            } else {
                const dateObj = timeInput ? new Date(timeInput) : null;
                const formattedTime = dateObj ? dateObj.toLocaleString('es-ES', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : "Próximamente";
                msg = `REUNIÓN PROGRAMADA: ${formattedTime} en ${loc}`;
            }

            // Guardamos la alerta en localStorage de forma persistente
            const alertId = Date.now();
            localStorage.setItem('cmms_alert', JSON.stringify({
                id: alertId,
                tipo: tipo,
                mensaje: msg,
                timestamp: alertId,
                confirmados: [] // Lista de IDs de técnicos que ya confirmaron
            }));

            // Dashboard Admin: Abrir monitor
            document.getElementById('meeting-monitor').style.display = 'block';
            document.getElementById('attendees-list').innerHTML = '<div style="color: var(--color-warning);">Esperando confirmaciones...</div>';

            logManagementAction('Comunicaciones', `Citación de reunión en ${loc}`, 'campaign');

            // Auto-disparar para el técnico logueado (Simulación)
            if (currentRole === 'tecnico') {
                const alerta = JSON.parse(localStorage.getItem('cmms_alert'));
                activarAlertaSensorial(alerta);
            }
        }

        function dispararAlertaSensorial(tecId, msg) {
            // Persistimos la alerta para que otros dispositivos (o el mismo en f5) la retomen
            const alertId = Date.now();
            const alerta = {
                id: alertId,
                tipo: 'urgente',
                mensaje: msg,
                timestamp: alertId,
                confirmados: [],
                targetId: tecId // Target specific technician
            };

            localStorage.setItem('cmms_alert', JSON.stringify(alerta));

            // PUBLICAR EN FIREBASE PARA SINCRONIZACIÓN MULTI-DISPOSITIVO
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                const db = firebase.firestore();
                db.collection('cmms').doc('alerts').set({
                    ...alerta,
                    active: true
                }).then(() => {
                    console.log("📢 Alert published to cloud");
                }).catch(err => {
                    console.error("❌ Error publishing alert:", err);
                });
            }

            // Si somos el target, activamos inmediato
            if (currentUser && currentUser.id === tecId) {
                activarAlertaSensorial(alerta);
            }
        }

        function activarAlertaSensorial(alerta) {
            // Trigger native notification
            if (typeof sendSystemNotification === 'function') {
                sendSystemNotification(
                    alerta.tipo === 'urgente' ? "🚨 ALERTA CRÍTICA" : "🔔 Notificación CMMS",
                    alerta.mensaje,
                    alerta.tipo
                );
            }

            const modal = document.getElementById('modal-notificatoria');
            const titulo = document.getElementById('notif-titulo');
            const mensaje = document.getElementById('notif-mensaje');
            const card = document.getElementById('notif-modal-card');

            titulo.innerText = alerta.tipo === 'urgente' ? '¡ALERTA URGENTE!' : 'AVISO DE REUNIÓN';
            mensaje.innerText = alerta.mensaje;
            card.style.borderColor = alerta.tipo === 'urgente' ? 'var(--color-danger)' : 'var(--color-primary)';

            modal.style.display = 'flex';

            // 1. Vibración (Compatible con Android)
            if ("vibrate" in navigator) {
                const urgencyPattern = Array(14).fill([500, 200]).flat();
                const pattern = alerta.tipo === 'urgente' ? urgencyPattern : [200, 100, 200];
                navigator.vibrate(pattern);
            }

            // 1.5 Flash Visual (Para iOS/Todos)
            let flashCount = 0;
            const flashInterval = setInterval(() => {
                document.body.style.backgroundColor = flashCount % 2 === 0 ? 'var(--color-danger)' : 'var(--color-background)';
                flashCount++;
                if (flashCount > 10 || modal.style.display === 'none') {
                    clearInterval(flashInterval);
                    document.body.style.backgroundColor = 'var(--color-background)';
                }
            }, 300);


            // 2. Sonido (Usando el contexto desbloqueado)
            if (globalAudioCtx) {
                const oscillator = globalAudioCtx.createOscillator();
                const gainNode = globalAudioCtx.createGain();

                oscillator.type = alerta.tipo === 'urgente' ? 'sawtooth' : 'sine';
                oscillator.frequency.setValueAtTime(alerta.tipo === 'urgente' ? 440 : 880, globalAudioCtx.currentTime);

                // Volumen alto
                gainNode.gain.setValueAtTime(0.5, globalAudioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, globalAudioCtx.currentTime + 5);

                oscillator.connect(gainNode);
                gainNode.connect(globalAudioCtx.destination);

                oscillator.start();
                oscillator.stop(globalAudioCtx.currentTime + 5);
            }
        }

        // Función para confirmar asistencia a la alerta y navegar según rol
        function confirmarAsistencia() {
            // Cerrar el modal de alerta
            const modal = document.getElementById('modal-notificatoria');
            if (modal) {
                modal.style.display = 'none';
            }

            // Navegar según el rol del usuario
            // Admin va al dashboard, Técnicos van a sus tareas
            if (currentRole === 'admin') {
                navigate('dashboard');
            } else {
                navigate('ots');  // Técnicos van a "Mis Tareas"
            }
        }

        // --- GESTIÓN DE PERFIL SUPERVISOR ---
        function openModalPerfil() {
            if (currentRole === 'tecnico') {
                if (currentUser) openModalTecnico(currentUser);
                return;
            }
            if (currentRole !== 'admin') return;

            const adminData = JSON.parse(localStorage.getItem('cmms_admin_data')) || { nombre: 'Administrator', foto: null };
            document.getElementById('perf-nombre').value = adminData.nombre;
            document.getElementById('perf-preview-img').src = adminData.foto || '';

            const validadas = ots.filter(o => o.estado === 'archivada').length;
            document.getElementById('perf-ots-validadas').innerText = validadas;

            // --- POPULATE BRANDING CONFIG ---
            // Usamos APP_CONFIG que ya puede tener datos cargados de localStorage
            if (document.getElementById('conf-company-name')) {
                document.getElementById('conf-company-name').value = APP_CONFIG.companyName || '';
                document.getElementById('conf-company-address').value = APP_CONFIG.companyAddress || '';
                document.getElementById('conf-company-phone').value = APP_CONFIG.companyPhone || '';
                document.getElementById('conf-signer-name').value = APP_CONFIG.signerName || '';
                document.getElementById('conf-signer-role').value = APP_CONFIG.signerRole || '';
            }

            // ADD NOTIFICATION BUTTON IF SUPPORTED
            const notifBtnContainer = document.getElementById('perf-notif-container');
            if ("Notification" in window && Notification.permission !== 'granted') {
                notifBtnContainer.innerHTML = `<button onclick="requestNotificationPermission()" class="btn" style="width:100%; margin-top:10px; background:var(--color-primary); color:white;">🔔 Activar Notificaciones de Sistema</button>`;
            } else {
                notifBtnContainer.innerHTML = `<div style="text-align:center; color:var(--color-success); font-size:0.8rem; margin-top:10px;">✅ Notificaciones Activas</div>`;
            }

            document.getElementById('modal-perfil').style.display = 'flex';
        }

        // --- GESTIÓN DE TÉCNICOS ---
        function openModalTecnico(tecnico = null) {
            const modal = document.getElementById('modal-tecnico');
            const title = document.getElementById('modal-tecnico-title');

            if (tecnico) {
                // Edit mode
                title.innerText = 'Editar Técnico';
                document.getElementById('tec-id').value = tecnico.id;
                document.getElementById('tec-nombre').value = tecnico.nombre;
                document.getElementById('tec-pin').value = tecnico.pin || '';
                document.getElementById('tec-eficacia').value = tecnico.eficacia || 100;
                document.getElementById('tec-salario').value = tecnico.salario || 0;
                document.getElementById('tec-is-titular').checked = tecnico.isTitular || false;
                document.getElementById('tec-turno-inicio').value = tecnico.turno?.inicio || '08:00';
                document.getElementById('tec-turno-fin').value = tecnico.turno?.fin || '18:00';

                // Set skills checkboxes
                const checkboxes = document.querySelectorAll('#tec-skills-container input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                if (tecnico.especialidad) {
                    const skills = Array.isArray(tecnico.especialidad) ? tecnico.especialidad : [tecnico.especialidad];
                    skills.forEach(skill => {
                        const checkbox = Array.from(checkboxes).find(cb => cb.value === skill);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                // New mode
                title.innerText = 'Nuevo Técnico';
                document.getElementById('tec-id').value = '';
                document.getElementById('tec-nombre').value = '';
                document.getElementById('tec-pin').value = '';
                document.getElementById('tec-eficacia').value = 100;
                document.getElementById('tec-salario').value = 0;
                document.getElementById('tec-is-titular').checked = false;
                document.getElementById('tec-turno-inicio').value = '08:00';
                document.getElementById('tec-turno-fin').value = '18:00';

                const checkboxes = document.querySelectorAll('#tec-skills-container input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
            }

            // ADD NOTIFICATION BUTTON FOR TECHS (Self-Edit)
            if (tecnico && currentUser && tecnico.id === currentUser.id) {
                const notifBtnContainer = document.getElementById('tec-notif-container');
                if (notifBtnContainer) {
                    if ("Notification" in window && Notification.permission !== 'granted') {
                        notifBtnContainer.innerHTML = `<button onclick="requestNotificationPermission()" class="btn" style="width:100%; margin-top:10px; background:var(--color-primary); color:white;">🔔 Activar Alertas</button>`;
                    } else {
                        notifBtnContainer.innerHTML = `<div style="text-align:center; color:var(--color-success); font-size:0.8rem; margin-top:10px;">✅ Alertas Activas</div>`;
                    }
                }
            }

            modal.style.display = 'flex';
        }

        function closeModalTecnico() {
            document.getElementById('modal-tecnico').style.display = 'none';
        }

        function saveTecnico() {
            const id = document.getElementById('tec-id').value;
            const nombre = document.getElementById('tec-nombre').value;
            const pin = document.getElementById('tec-pin').value;
            const eficacia = parseInt(document.getElementById('tec-eficacia').value) || 100;
            const salario = parseInt(document.getElementById('tec-salario').value) || 0;
            const isTitular = document.getElementById('tec-is-titular').checked;
            const turnoInicio = document.getElementById('tec-turno-inicio').value;
            const turnoFin = document.getElementById('tec-turno-fin').value;

            // Get selected skills
            const checkboxes = document.querySelectorAll('#tec-skills-container input[type="checkbox"]:checked');
            const especialidad = Array.from(checkboxes).map(cb => cb.value).join(', ') || 'General';

            if (!nombre) {
                alert('❌ El nombre del técnico es obligatorio.');
                return;
            }

            // Validate PIN if provided
            if (pin && pin.length > 0) {
                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    alert('❌ El PIN debe tener exactamente 4 dígitos numéricos.');
                    return;
                }
            }

            const costoHora = Math.round(salario / 180);

            if (id) {
                // Update existing
                const idx = tecnicos.findIndex(t => t.id == id);
                if (idx !== -1) {
                    tecnicos[idx] = {
                        ...tecnicos[idx],
                        nombre,
                        pin: pin || tecnicos[idx].pin || '1111',
                        especialidad,
                        eficacia,
                        salario,
                        costoHora,
                        isTitular,
                        turno: { inicio: turnoInicio, fin: turnoFin, colacion: 60 }
                    };
                }
            } else {
                // Create new
                const newTec = {
                    id: Date.now(),
                    nombre,
                    userCode: nombre.substring(0, 2).toUpperCase() + '00' + (tecnicos.length + 1),
                    pin: pin || '1111',
                    especialidad,
                    foto: `https://ui-avatars.com/api/?name=${encodeURIComponent(nombre)}&background=3b82f6&color=fff`,
                    salario,
                    costoHora,
                    isTitular,
                    origen: 'planta',
                    empresa: 'Hotel 5*',
                    eficacia,
                    turno: { inicio: turnoInicio, fin: turnoFin, colacion: 60 }
                };
                tecnicos.push(newTec);
            }

            persist();
            closeModalTecnico();
            alert('✅ Técnico guardado exitosamente.' + (pin ? '\n🔐 PIN configurado correctamente.' : ''));
            renderCurrentView();
        }

        function closeModalPerfil() {
            document.getElementById('modal-perfil').style.display = 'none';
        }

        function savePerfil() {
            const nombre = document.getElementById('perf-nombre').value;
            const previewImg = document.getElementById('perf-preview-img');
            const foto = previewImg ? previewImg.src : '';
            const pin = document.getElementById('perf-pin').value;

            // Validate PIN if changed
            if (pin && pin.length > 0) {
                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    alert('❌ El PIN debe tener exactamente 4 dígitos numéricos.');
                    return;
                }
                // Save new admin PIN
                ADMIN_PIN = pin;
                localStorage.setItem('cmms_admin_pin', pin);
            }

            const adminData = {
                nombre: nombre || 'Administrator',
                foto: (foto && foto.startsWith('data:')) ? foto : (JSON.parse(localStorage.getItem('cmms_admin_data'))?.foto || null)
            };

            localStorage.setItem('cmms_admin_data', JSON.stringify(adminData));

            if (currentRole === 'admin') {
                currentUser.nombre = adminData.nombre;
                currentUser.foto = adminData.foto;
            }

            startApp();
            closeModalPerfil();
            alert('✅ Perfil guardado exitosamente.' + (pin ? '\n🔐 Tu nuevo PIN ha sido actualizado.' : ''));
        }

        function saveBrandingConfig() {
            const newConfig = {
                companyName: document.getElementById('conf-company-name').value || APP_CONFIG.companyName,
                companyAddress: document.getElementById('conf-company-address').value || APP_CONFIG.companyAddress,
                companyPhone: document.getElementById('conf-company-phone').value || APP_CONFIG.companyPhone,
                signerName: document.getElementById('conf-signer-name').value || APP_CONFIG.signerName,
                signerRole: document.getElementById('conf-signer-role').value || APP_CONFIG.signerRole
            };

            // 1. Guardar en localStorage
            localStorage.setItem('cmms_branding_config', JSON.stringify(newConfig));

            // 2. Actualizar estado actual
            Object.assign(APP_CONFIG, newConfig);

            alert("✅ Configuración de Branding guardada con éxito.\nLos futuros PDFs usarán estos datos.");
        }

        const perfFileInput = document.getElementById('perf-foto-input');
        if (perfFileInput) {
            perfFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = new Image();
                        img.onload = function () {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 200;
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            document.getElementById('perf-preview-img').src = canvas.toDataURL('image/jpeg', 0.7);
                        }
                        img.src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        function confirmarAsistencia() {
            document.getElementById('modal-notificatoria').style.display = 'none';
            if ("vibrate" in navigator) navigator.vibrate(0); // Detener vibración

            // Notificar al supervisor agregando a la lista de confirmados en la alerta actual
            const alertData = localStorage.getItem('cmms_alert');
            if (alertData) {
                let alertObj = JSON.parse(alertData);
                if (!alertObj.confirmados.includes(currentUser.id)) {
                    alertObj.confirmados.push(currentUser.id);
                    localStorage.setItem('cmms_alert', JSON.stringify(alertObj));

                    // También guardamos en la lista histórica de confirmaciones para el monitor
                    let confirmations = JSON.parse(localStorage.getItem('cmms_confirmations')) || [];
                    confirmations.push({ nombre: currentUser.nombre, hora: new Date().toLocaleTimeString(), alertId: alertObj.id });
                    localStorage.setItem('cmms_confirmations', JSON.stringify(confirmations));
                }
            }
        }

        // Timer para check de confirmaciones en Admin y ALERTAS en Técnicos
        setInterval(() => {
            if (currentRole === 'admin' && document.getElementById('meeting-monitor')?.style.display === 'block') {
                const confs = JSON.parse(localStorage.getItem('cmms_confirmations')) || [];
                const list = document.getElementById('attendees-list');
                if (confs.length > 0) {
                    list.innerHTML = confs.map(c => `
                        <div style="background: var(--color-success); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.65rem;">
                            ${c.nombre} (${c.hora})
                        </div>
                    `).join('');
                }
            }

            // Check de Alertas para Técnicos (Simulación de tiempo real)
            if (currentRole === 'tecnico') {
                const alertData = localStorage.getItem('cmms_alert');
                if (alertData) {
                    const alertObj = JSON.parse(alertData);

                    // Verificamos si esta alerta NO ha sido confirmada por el usuario actual
                    const yaConfirmada = alertObj.confirmados && alertObj.confirmados.includes(currentUser.id);
                    const alreadyShown = document.getElementById('modal-notificatoria').style.display === 'flex';

                    // Check if alert is for me (Targeted) or Global (no targetId)
                    const isForMe = !alertObj.targetId || alertObj.targetId === currentUser.id;

                    // Si es una alerta vigente (ej: de la última hora) y no confirmada
                    const esVigente = (Date.now() - alertObj.timestamp) < 3600000;

                    if (esVigente && !yaConfirmada && !alreadyShown && isForMe) {
                        activarAlertaSensorial(alertObj);
                    }
                }
            }
        }, 2000);

        // --- SOS TÁCTICO GLOBAL ---
        let sosConfig = JSON.parse(localStorage.getItem('cmms_sos_config')) || {
            types: ['🔥 INCENDIO', '💧 INUNDACIÓN', '🏥 ACCIDENTE', '🔒 SEGURIDAD', '☣️ FUGA GAS'],
            locs: ['Lobby', 'Cocina', 'Restaurante', 'Piscina', 'Habitaciones', 'Sótano', 'Sala Bombas', 'Calderas']
        };

        let selectedSOSType = null;
        let selectedSOSLoc = null;

        function openSOSPanel() {
            document.getElementById('modal-sos').style.display = 'flex';
            renderSOSTactical();
        }

        function closeSOSPanel() {
            document.getElementById('modal-sos').style.display = 'none';
            selectedSOSType = null;
            selectedSOSLoc = null;
            document.getElementById('sos-preview').style.display = 'none';
        }

        function renderSOSTactical() {
            const typeCont = document.getElementById('sos-types-container');
            const locCont = document.getElementById('sos-locs-container');

            typeCont.innerHTML = `<div style="font-weight:bold; color:var(--color-accent); margin-bottom:5px;">¿QUÉ PASA?</div>` +
                sosConfig.types.map(t => `
                <div class="tactical-btn ${selectedSOSType === t ? 'selected' : ''}" onclick="selectSOS('type', '${t}')">
                    ${t}
                </div>
            `).join('');

            locCont.innerHTML = `<div style="font-weight:bold; color:var(--color-success); margin-bottom:5px;">¿DÓNDE?</div>` +
                sosConfig.locs.map(l => `
                <div class="tactical-btn ${selectedSOSLoc === l ? 'selected' : ''}" onclick="selectSOS('loc', '${l}')">
                    ${l}
                </div>
            `).join('');
        }

        function selectSOS(kind, val) {
            if (kind === 'type') selectedSOSType = val;
            if (kind === 'loc') selectedSOSLoc = val;

            renderSOSTactical();

            if (selectedSOSType && selectedSOSLoc) {
                const preview = document.getElementById('sos-preview');
                const msg = document.getElementById('sos-msg-preview');
                msg.innerText = `${selectedSOSType} EN ${selectedSOSLoc}`;
                preview.style.display = 'block';
                // Auto scroll to bottom
                preview.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function confirmSOS() {
            // Usa la función existente dispararReunion('urgente') pero inyectando el mensaje custom
            const msg = `¡ALERTA TÁCTICA! ${selectedSOSType} EN ${selectedSOSLoc.toUpperCase()}`;

            // Bypass manual de dispararReunion para mensaje custom
            // 1. Crear alerta
            const alertId = Date.now();
            localStorage.setItem('cmms_alert', JSON.stringify({
                id: alertId,
                tipo: 'urgente',
                mensaje: msg,
                timestamp: alertId,
                confirmados: []
            }));

            // 2. Abrir monitor si estamos en Dashboard
            const monitor = document.getElementById('meeting-monitor');
            if (monitor) {
                monitor.style.display = 'block';
                document.getElementById('attendees-list').innerHTML = '<div style="color: var(--color-warning);">Emergencia Activada. Esperando confirmaciones...</div>';
            }

            // 3. Auto-disparar local
            activarAlertaSensorial({ tipo: 'urgente', mensaje: msg });

            logManagementAction('Emergencia', `Activado SOS: ${selectedSOSType}`, 'emergency');

            closeSOSPanel();
            navigate('dashboard'); // Ir al dashboard para ver el monitor
        }

        // Configuración SOS
        function toggleSOSConfig() {
            const viewTac = document.getElementById('sos-view-tactical');
            const viewConf = document.getElementById('sos-view-config');

            if (viewTac.style.display === 'none') {
                viewTac.style.display = 'block';
                viewConf.style.display = 'none';
                renderSOSTactical(); // Refresh changes
            } else {
                viewTac.style.display = 'none';
                viewConf.style.display = 'block';
                renderSOSConfigList();
            }
        }

        function renderSOSConfigList() {
            const tList = document.getElementById('config-types-list');
            const lList = document.getElementById('config-locs-list');

            tList.innerHTML = sosConfig.types.map((t, i) => `
                <div class="config-list-item">
                    <span>${t}</span>
                    <button onclick="removeSOSItem('types', ${i})" style="background:none; border:none; color:var(--color-danger); cursor:pointer;">X</button>
                </div>
            `).join('');

            lList.innerHTML = sosConfig.locs.map((l, i) => `
                <div class="config-list-item">
                    <span>${l}</span>
                    <button onclick="removeSOSItem('locs', ${i})" style="background:none; border:none; color:var(--color-danger); cursor:pointer;">X</button>
                </div>
            `).join('');
        }

        function addSOSItem(list) {
            const input = document.getElementById(list === 'types' ? 'new-sos-type' : 'new-sos-loc');
            const val = input.value.trim();
            if (!val) return;

            sosConfig[list].push(val);
            localStorage.setItem('cmms_sos_config', JSON.stringify(sosConfig));
            input.value = '';
            renderSOSConfigList();
        }

        function removeSOSItem(list, idx) {
            sosConfig[list].splice(idx, 1);
            localStorage.setItem('cmms_sos_config', JSON.stringify(sosConfig));
            renderSOSConfigList();
        }

        // ========== SHOWROOM PRESENTATION SYSTEM ==========
        let showroomState = {
            active: false,
            paused: false,
            currentScene: 0,
            timeouts: []
        };

        const SHOWROOM_SCENES = [
            {
                id: 1,
                name: "Simulación de Crisis",
                duration: 10000,
                actions: [
                    {
                        delay: 0, fn: () => {
                            closeModalPerfil();
                            // Close any open modals
                            const modals = document.querySelectorAll('.modal-overlay');
                            modals.forEach(m => m.style.display = 'none');
                            navigate('dashboard');
                        }
                    },
                    { delay: 1500, fn: () => highlightElement('.dashboard-grid', 'Indicadores en tiempo real') },
                    {
                        delay: 3500, fn: () => {
                            // Simulate crisis without opening modal
                            // Just trigger the visual alerts
                            const criticalEquipos = equipos.filter(e => e.criticidad === 'alta').slice(0, 3);
                            criticalEquipos.forEach(eq => {
                                eq.estado = 'peligro';
                                eq.dispo = Math.max(50, eq.dispo - 30);
                            });

                            // Create some urgent OTs
                            const urgentOT = {
                                id: Date.now(),
                                titulo: "EMERGENCIA: Falla crítica detectada",
                                descripcion: "Sistema de emergencia activado",
                                prioridad: "ALTA",
                                estado: "ejecucion",
                                asignadoId: tecnicos[0]?.id
                            };
                            ots.unshift(urgentOT);

                            // Refresh dashboard
                            navigate('dashboard');
                        }
                    },
                    { delay: 6000, fn: () => highlightElement('.kpi-card', 'KPIs de alerta activados') }
                ]
            },
            {
                id: 2,
                name: "Rastreo de Respuesta",
                duration: 8000,
                actions: [
                    { delay: 0, fn: () => navigate('muro') },
                    { delay: 2000, fn: () => highlightElement('.muro-container', 'Control de técnicos en tiempo real') },
                    { delay: 5000, fn: () => highlightElement('.tech-status-card', 'Estado y ubicación del equipo') }
                ]
            },
            {
                id: 3,
                name: "Control de Costos",
                duration: 8000,
                actions: [
                    { delay: 0, fn: () => navigate('bodega') },
                    { delay: 2000, fn: () => highlightElement('.bodega-kpis', 'Valor total del inventario') },
                    { delay: 5000, fn: () => highlightElement('.zone-grid', 'Organización por zonas y pasillos') }
                ]
            },
            {
                id: 4,
                name: "Cumplimiento Legal",
                duration: 8000,
                actions: [
                    { delay: 0, fn: () => navigate('personal') },
                    { delay: 2000, fn: () => highlightElement('.personal-grid', 'Equipo de mantenimiento') },
                    {
                        delay: 5000, fn: () => {
                            const firstTech = tecnicos[0];
                            if (firstTech) {
                                highlightElement('.personal-grid', 'Generación de certificados PDF');
                            }
                        }
                    }
                ]
            }
        ];

        function startShowroom() {
            if (showroomState.active) return;

            showroomState.active = true;
            showroomState.paused = false;
            showroomState.currentScene = 0;

            document.getElementById('showroom-overlay').style.display = 'block';

            runShowroomScene(0);
        }

        function runShowroomScene(sceneIndex) {
            if (!showroomState.active || sceneIndex >= SHOWROOM_SCENES.length) {
                stopShowroom();
                return;
            }

            const scene = SHOWROOM_SCENES[sceneIndex];
            showroomState.currentScene = sceneIndex;

            // Update UI
            document.getElementById('showroom-scene-name').innerText = scene.name;
            document.getElementById('showroom-progress').innerText = `Escena ${sceneIndex + 1} de ${SHOWROOM_SCENES.length}`;

            // Execute scene actions
            scene.actions.forEach(action => {
                const timeout = setTimeout(() => {
                    if (!showroomState.paused && showroomState.active) {
                        action.fn();
                    }
                }, action.delay);
                showroomState.timeouts.push(timeout);
            });

            // Schedule next scene
            const nextSceneTimeout = setTimeout(() => {
                if (!showroomState.paused && showroomState.active) {
                    runShowroomScene(sceneIndex + 1);
                }
            }, scene.duration);
            showroomState.timeouts.push(nextSceneTimeout);
        }

        function toggleShowroomPause() {
            showroomState.paused = !showroomState.paused;
            const btn = document.getElementById('showroom-pause-btn');

            if (showroomState.paused) {
                btn.innerHTML = '<span class="material-symbols-rounded" style="font-size: 16px;">play_arrow</span>';
                btn.style.background = 'rgba(16, 185, 129, 0.2)';
                btn.style.borderColor = 'var(--color-success)';
                btn.style.color = 'var(--color-success)';
                hideSpotlight();
            } else {
                btn.innerHTML = '<span class="material-symbols-rounded" style="font-size: 16px;">pause</span>';
                btn.style.background = 'rgba(245, 158, 11, 0.2)';
                btn.style.borderColor = 'var(--color-warning)';
                btn.style.color = 'var(--color-warning)';
                // Resume from current scene
                runShowroomScene(showroomState.currentScene);
            }
        }

        function skipShowroomScene() {
            if (!showroomState.active) return;

            // Clear current timeouts
            showroomState.timeouts.forEach(t => clearTimeout(t));
            showroomState.timeouts = [];

            // Move to next scene
            runShowroomScene(showroomState.currentScene + 1);
        }

        function stopShowroom() {
            showroomState.active = false;
            showroomState.paused = false;

            // Clear all timeouts
            showroomState.timeouts.forEach(t => clearTimeout(t));
            showroomState.timeouts = [];

            document.getElementById('showroom-overlay').style.display = 'none';
            hideSpotlight();

            alert('✅ Presentación finalizada.\n\nLa aplicación está lista para uso normal.');
        }

        function highlightElement(selector, message = '') {
            const element = document.querySelector(selector);
            if (!element) return;

            const overlay = document.getElementById('showroom-overlay-dark');
            const spotlight = document.getElementById('showroom-spotlight');
            const label = document.getElementById('showroom-label');
            const labelText = document.getElementById('showroom-label-text');
            const rect = element.getBoundingClientRect();

            // Show dark overlay
            overlay.style.display = 'block';

            // Position and show spotlight
            spotlight.style.display = 'block';
            spotlight.style.left = (rect.left - 10) + 'px';
            spotlight.style.top = (rect.top - 10) + 'px';
            spotlight.style.width = (rect.width + 20) + 'px';
            spotlight.style.height = (rect.height + 20) + 'px';

            // Position and show label above the spotlight
            if (message) {
                labelText.innerText = message;
                label.style.display = 'block';
                label.style.left = (rect.left) + 'px';
                label.style.top = (rect.top - 60) + 'px';
            }

            // Scroll element into view
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideSpotlight() {
            document.getElementById('showroom-overlay-dark').style.display = 'none';
            document.getElementById('showroom-spotlight').style.display = 'none';
            document.getElementById('showroom-label').style.display = 'none';
        }

        // ========== AI CHAT ASSISTANT ==========
        let aiChatHistory = [];

        function toggleAIChat() {
            const panel = document.getElementById('ai-chat-panel');
            const button = document.getElementById('ai-chat-button');

            if (panel.style.display === 'none' || !panel.style.display) {
                panel.style.display = 'block';
                button.style.transform = 'scale(0.9)';
            } else {
                panel.style.display = 'none';
                button.style.transform = 'scale(1)';
            }
        }

        function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const query = input.value.trim();

            if (!query) return;

            // Add user message
            addChatMessage(query, 'user');

            // Process query and get response
            const response = processAIQuery(query);

            // Add AI response
            setTimeout(() => {
                addChatMessage(response, 'ai');
            }, 500);

            input.value = '';
        }

        function addChatMessage(text, type) {
            const container = document.getElementById('ai-chat-messages');

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = type === 'user'
                ? 'background: rgba(168, 85, 247, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #a855f7; text-align: right;'
                : 'background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--color-primary);';

            if (type === 'ai') {
                messageDiv.innerHTML = `
                                <div style="font-size: 0.75rem; color: var(--color-primary); font-weight: 700; margin-bottom: 5px;">XELONIA Assistant</div>
                                <div style="font-size: 0.8rem; line-height: 1.4;">${text}</div>
                            `;
            } else {
                messageDiv.innerHTML = `
                                <div style="font-size: 0.75rem; color: #a855f7; font-weight: 700; margin-bottom: 5px;">Tú</div>
                                <div style="font-size: 0.8rem; line-height: 1.4;">${text}</div>
                            `;
            }

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            // Keep only last 20 messages
            while (container.children.length > 21) {
                container.removeChild(container.children[1]); // Keep welcome message
            }
        }

        function processAIQuery(query) {
            const q = query.toLowerCase();

            // Equipment status queries
            if (q.includes('equipo') || q.includes('falla') || q.includes('alerta') || q.includes('problema')) {
                return analyzeEquipmentStatus();
            }

            // Stock queries
            if (q.includes('stock') || q.includes('repuesto') || q.includes('bodega') || q.includes('inventario')) {
                return analyzeInventory();
            }

            // Cost queries
            if (q.includes('gasto') || q.includes('costo') || q.includes('dinero') || q.includes('presupuesto')) {
                return calculateTotalCosts();
            }

            // Location queries
            if (q.includes('dónde') || q.includes('donde') || q.includes('ubicación') || q.includes('ubicacion')) {
                return findLocation(q);
            }

            // Technician queries
            if (q.includes('técnico') || q.includes('tecnico') || q.includes('personal')) {
                return analyzeTechnicians();
            }

            // Work order queries
            if (q.includes('tarea') || q.includes('trabajo') || q.includes('pendiente')) {
                return analyzeWorkOrders();
            }

            // Default helpful response
            return generateSmartResponse(q);
        }

        function analyzeEquipmentStatus() {
            const alertEquipos = equipos.filter(e => e.estado === 'alerta' || e.estado === 'peligro');
            const activeEquipos = equipos.filter(e => e.estado === 'activo');

            if (alertEquipos.length === 0) {
                return `✅ Excelente noticia: Todos los equipos están operativos. Tienes ${activeEquipos.length} equipos en estado activo.`;
            }

            const critical = alertEquipos.filter(e => e.estado === 'peligro');
            const warnings = alertEquipos.filter(e => e.estado === 'alerta');

            let response = `⚠️ Tienes ${alertEquipos.length} equipo(s) que requieren atención:\n\n`;

            if (critical.length > 0) {
                response += `🔴 CRÍTICO (${critical.length}):\n`;
                critical.forEach(e => {
                    response += `• ${e.nombre} - Disponibilidad: ${e.dispo}%\n`;
                });
            }

            if (warnings.length > 0) {
                response += `\n🟡 ALERTA (${warnings.length}):\n`;
                warnings.forEach(e => {
                    response += `• ${e.nombre} - Disponibilidad: ${e.dispo}%\n`;
                });
            }

            response += `\n💡 Recomendación: Revisa el Dashboard para más detalles.`;

            return response;
        }

        function analyzeInventory() {
            const lowStock = repuestos.filter(r => r.stock <= r.stockMinimo);
            const totalValue = repuestos.reduce((sum, r) => sum + (r.stock * r.precio), 0);

            if (lowStock.length === 0) {
                return `✅ Stock saludable: Todos los repuestos están sobre el mínimo.\n\n📊 Valor total del inventario: $${totalValue.toLocaleString('es-CL')}`;
            }

            let response = `⚠️ Tienes ${lowStock.length} ítem(s) en stock crítico:\n\n`;

            lowStock.forEach(r => {
                response += `• ${r.nombre}: ${r.stock} ${r.unidad} (Mínimo: ${r.stockMinimo})\n`;
                response += `  📍 Ubicación: ${r.zona} - Pasillo ${r.pasillo}, Estante ${r.estante}\n`;
            });

            response += `\n💡 Sugerencia: Genera una OC para reponer estos ítems.`;

            return response;
        }

        function calculateTotalCosts() {
            const completedOTs = ots.filter(o => o.estado === 'completada' || o.estado === 'archivada');
            const totalCost = completedOTs.reduce((sum, ot) => sum + (ot.costo || 0), 0);
            const avgCost = completedOTs.length > 0 ? totalCost / completedOTs.length : 0;

            // Find most expensive equipment
            let maxCost = 0;
            let maxEquipo = null;
            equipos.forEach(e => {
                if (e.costoMantAcumulado > maxCost) {
                    maxCost = e.costoMantAcumulado;
                    maxEquipo = e;
                }
            });

            let response = `💰 Análisis de Costos:\n\n`;
            response += `• Total gastado en OTs: $${totalCost.toLocaleString('es-CL')}\n`;
            response += `• Promedio por OT: $${avgCost.toLocaleString('es-CL')}\n`;
            response += `• OTs completadas: ${completedOTs.length}\n\n`;

            if (maxEquipo) {
                response += `📊 Equipo más costoso:\n`;
                response += `• ${maxEquipo.nombre}: $${maxCost.toLocaleString('es-CL')} acumulado\n`;
                const ratio = (maxCost / maxEquipo.valorMercado) * 100;
                response += `• Ratio Gasto/Valor: ${ratio.toFixed(1)}%\n`;

                if (ratio > 80) {
                    response += `\n⚠️ Alerta: Este equipo ha consumido más del 80% de su valor. Considera reemplazo.`;
                }
            }

            return response;
        }

        function findLocation(query) {
            // Try to find equipment or spare part mentioned
            const words = query.split(' ');

            for (let word of words) {
                // Check equipment
                const equipo = equipos.find(e => e.nombre.toLowerCase().includes(word));
                if (equipo) {
                    return `📍 ${equipo.nombre}:\n• Ubicación: ${equipo.area}\n• Estado: ${equipo.estado.toUpperCase()}\n• Disponibilidad: ${equipo.dispo}%`;
                }

                // Check spare parts
                const repuesto = repuestos.find(r => r.nombre.toLowerCase().includes(word));
                if (repuesto) {
                    return `📍 ${repuesto.nombre}:\n• Zona: ${repuesto.zona}\n• Pasillo: ${repuesto.pasillo}\n• Estante: ${repuesto.estante}, Nivel: ${repuesto.nivel}\n• Stock: ${repuesto.stock} ${repuesto.unidad}`;
                }
            }

            return `🤔 No encontré ese elemento específico. Intenta con el nombre exacto del equipo o repuesto.`;
        }

        function analyzeTechnicians() {
            const plantaTechs = tecnicos.filter(t => t.origen === 'planta');
            const avgEficacia = tecnicos.reduce((sum, t) => sum + (t.eficacia || 100), 0) / tecnicos.length;

            let response = `👥 Equipo de Mantenimiento:\n\n`;
            response += `• Total: ${tecnicos.length} técnicos\n`;
            response += `• Planta: ${plantaTechs.length}\n`;
            response += `• Eficacia promedio: ${avgEficacia.toFixed(1)}%\n\n`;

            response += `Especialidades:\n`;
            const especialidades = {};
            tecnicos.forEach(t => {
                especialidades[t.especialidad] = (especialidades[t.especialidad] || 0) + 1;
            });

            Object.entries(especialidades).forEach(([esp, count]) => {
                response += `• ${esp}: ${count} técnico(s)\n`;
            });

            return response;
        }

        function analyzeWorkOrders() {
            const pending = ots.filter(o => o.estado === 'pendiente' || o.estado === 'ejecucion');
            const highPriority = pending.filter(o => o.prioridad === 'ALTA');

            if (pending.length === 0) {
                return `✅ Excelente: No hay tareas pendientes en este momento.`;
            }

            let response = `📋 Estado de Trabajos:\n\n`;
            response += `• Pendientes: ${pending.length}\n`;
            response += `• Alta prioridad: ${highPriority.length}\n\n`;

            if (highPriority.length > 0) {
                response += `🔴 Urgentes:\n`;
                highPriority.slice(0, 3).forEach(ot => {
                    const tech = tecnicos.find(t => t.id === ot.asignadoId);
                    response += `• OT #${ot.id}: ${ot.titulo}\n`;
                    if (tech) response += `  Asignado a: ${tech.nombre}\n`;
                });
            }

            return response;
        }

        function generateSmartResponse(query) {
            const suggestions = [
                "Puedo ayudarte con:",
                "• Estado de equipos",
                "• Niveles de stock",
                "• Análisis de costos",
                "• Ubicación de equipos/repuestos",
                "• Estado del personal",
                "• Tareas pendientes",
                "",
                "Intenta preguntas como:",
                "- ¿Qué equipos están fallando?",
                "- ¿Cómo está el stock?",
                "- ¿Cuánto hemos gastado?",
                "- ¿Dónde está el compresor?"
            ];

            return suggestions.join('\n');
        }


        /* DISABLED AUTO-LOGIN - Conflicts with splash screen
        window.onload = () => {
            const session = JSON.parse(sessionStorage.getItem('cmms_session'));
            const wasLogout = sessionStorage.getItem('explicit_logout');
 
            // Intro Branding Duration: 5 seconds to let the user see XELONIA
            setTimeout(() => {
                const loader = document.getElementById('app-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    loader.style.transition = 'opacity 0.8s ease';
                    setTimeout(() => loader.style.display = 'none', 800);
                }
 
                if (session) {
                    currentRole = session.role;
                    currentUser = session.user;
 
                    // Si es admin, cargar datos personalizados si existen
                    if (currentRole === 'admin') {
                        const adminData = JSON.parse(localStorage.getItem('cmms_admin_data'));
                        if (adminData) {
                            currentUser.nombre = adminData.nombre;
                            currentUser.foto = adminData.foto;
                        }
                    }
 
                    startApp();
                } else if (wasLogout) {
                    document.getElementById('login-screen').style.display = 'flex';
                } else {
                    currentRole = 'admin';
                    document.getElementById('login-screen').style.display = 'flex';
                }
 
                // CHECK PENDING DEMO GEN
                if (localStorage.getItem('pending_demo_gen') === 'true') {
                    localStorage.removeItem('pending_demo_gen');
                    setTimeout(() => {
                        console.log("Resuming pending demo generation...");
                        generarDatosDemo();
                    }, 1000);
                }
            }, 5000); // 5 seconds branding experience
        }
        */
        window.openModalPerfil = openModalPerfil;
        window.closeModalPerfil = closeModalPerfil;
        window.savePerfil = savePerfil;

        // ========== MÓDULO DE BODEGA ==========
        function renderBodega() {
            // KPIs de Bodega
            const valorTotal = repuestos.reduce((sum, r) => sum + (r.stock * r.precio), 0);
            const stockCritico = repuestos.filter(r => r.stock <= (r.stockMinimo || r.critico));
            const zonas = [...new Set(repuestos.map(r => r.zona).filter(Boolean))];

            const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });
            const isTecnico = currentRole === 'tecnico';

            // Top 5 repuestos más utilizados (basado en el movimiento histórico)
            const movimientos = {};
            ots.filter(o => o.estado === 'completada' && o.repuestosUsados).forEach(o => {
                o.repuestosUsados.forEach(r => {
                    movimientos[r.id] = (movimientos[r.id] || 0) + r.cantidad;
                });
            });
            const topMovimientos = Object.entries(movimientos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([id, cant]) => {
                    const rep = repuestos.find(r => r.id == id);
                    return { nombre: rep?.nombre || 'Desconocido', cantidad: cant };
                });

            return `
                <div class="view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3>📦 ${isTecnico ? 'Localizador de Repuestos' : 'Control de Bodega'}</h3>
                    </div>

                    <!-- KPIs -->
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                        ${!isTecnico ? `
                        <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="font-size: 0.65rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase;">Valorización Total</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-top: 8px;">${fmt.format(valorTotal)}</div>
                        </div>
                        ` : ''}
                        <div class="card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1)); border: 1px solid rgba(239, 68, 68, 0.2);">
                            <div style="font-size: 0.65rem; color: var(--color-danger); font-weight: 800; text-transform: uppercase;">Stock Crítico</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-top: 8px; color: var(--color-danger);">${stockCritico.length}</div>
                            <div style="font-size: 0.6rem; color: var(--color-text-muted); margin-top: 4px;">Repuestos bajo mínimo</div>
                        </div>
                        <div class="card" style="background: rgba(255, 255, 255, 0.03);">
                            <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase;">Zonas Activas</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-top: 8px;">${zonas.length}</div>
                        </div>
                        <div class="card" style="background: rgba(255, 255, 255, 0.03);">
                            <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase;">Total Items</div>
                            <div style="font-size: 1.6rem; font-weight: 900; margin-top: 8px;">${repuestos.length}</div>
                        </div>
                    </div>

                    <!-- Alertas de Stock Crítico -->
                    ${stockCritico.length > 0 ? `
                        <div class="card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 20px;">
                            <h4 style="color: var(--color-danger); margin: 0 0 15px 0; font-size: 0.9rem;">⚠️ ALERTAS DE STOCK CRÍTICO</h4>
                            ${stockCritico.map(r => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <div>
                                        <div style="font-weight: 700; font-size: 0.85rem;">${r.nombre}</div>
                                        <div style="font-size: 0.65rem; color: var(--color-text-muted);">Ubicación: ${r.zona || 'N/A'} / ${r.pasillo || 'N/A'}-${r.estante || 'N/A'}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 1.2rem; font-weight: 900; color: var(--color-danger);">${r.stock}</div>
                                        <div style="font-size: 0.6rem; color: var(--color-text-muted);">Mín: ${r.stockMinimo || r.critico}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Navegación por Zonas -->
                    <div class="card" style="margin-top: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 0.9rem;">🗺️ Mapa de Zonas</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                            ${zonas.map(zona => {
                const itemsEnZona = repuestos.filter(r => r.zona === zona).length;
                return `
                                    <div class="tactical-btn" style="padding: 15px;" onclick="filterByZone('${zona}')">
                                        <div style="font-size: 0.7rem; font-weight: 800; color: var(--color-primary);">${zona}</div>
                                        <div style="font-size: 1.1rem; font-weight: 900; margin-top: 5px;">${itemsEnZona}</div>
                                        <div style="font-size: 0.55rem; color: var(--color-text-muted); margin-top: 2px;">Items</div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    </div>

                    <!-- Inventario Completo -->
                    <div class="card" style="margin-top: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 0.9rem;">📋 Inventario ${isTecnico ? '(Localizador)' : 'Completo'}</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${isTecnico ? `
                                <!-- Vista para Técnico: Solo ubicación y stock -->
                                ${repuestos.map(r => `
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; font-size: 0.75rem;">
                                        <div>
                                            <div style="font-weight: 700;">${r.nombre}</div>
                                            <div style="font-size: 0.65rem; color: var(--color-text-muted);">
                                                📍 ${r.zona || 'Sin zona'} / ${r.pasillo || '--'}-${r.estante || '--'}-${r.nivel || '--'}
                                            </div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: 900; font-size: 1rem; color: ${r.stock <= (r.stockMinimo || r.critico) ? 'var(--color-danger)' : 'var(--color-success)'};">${r.stock}</div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Disponible</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: 700;">${r.stockMinimo || r.critico}</div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Mínimo</div>
                                        </div>
                                    </div>
                                `).join('')}
                            ` : `
                                <!-- Vista para Administrador: Con valores monetarios -->
                                ${repuestos.map(r => `
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; font-size: 0.75rem;">
                                        <div>
                                            <div style="font-weight: 700;">${r.nombre}</div>
                                            <div style="font-size: 0.65rem; color: var(--color-text-muted);">
                                                ${r.zona || 'Sin zona'} / ${r.pasillo || '--'}-${r.estante || '--'}-${r.nivel || '--'}
                                            </div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: 900; font-size: 1rem; color: ${r.stock <= (r.stockMinimo || r.critico) ? 'var(--color-danger)' : 'var(--color-success)'};">${r.stock}</div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Stock</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: 700;">${r.stockMinimo || r.critico}</div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Mínimo</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: 700;">${fmt.format(r.precio)}</div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Precio</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 900; color: var(--color-primary);">${fmt.format(r.stock * r.precio)}</div>
                                            <div style="font-size: 0.6rem; color: var(--color-text-muted);">Valor</div>
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function filterByZone(zona) {
            alert(`Filtro por zona "${zona}" - Funcionalidad en desarrollo`);
        }

        // ========== MÓDULO DE BIBLIOTECA TÉCNICA ==========
        function renderBiblioteca() {
            const isadmin = currentRole === 'admin';
            const categorias = [...new Set(biblioteca.map(m => m.categoria))];

            return `
                <div class="view-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h3>📚 Biblioteca Técnica</h3>
                            <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 5px;">Manuales, diagramas y documentación técnica</p>
                        </div>
                        ${isadmin ? `
                            <button onclick="abrirModalManual()" class="btn btn-primary" style="padding: 10px 20px;">
                                <span class="material-symbols-rounded" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">add</span>
                                Añadir Manual
                            </button>
                        ` : ''}
                    </div>

                    <!-- Categorías -->
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 20px;">
                        ${categorias.map(cat => {
                const count = biblioteca.filter(m => m.categoria === cat).length;
                return `
                                <div class="card" style="cursor: pointer; text-align: center;" onclick="filterBiblioteca('${cat}')">
                                    <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800; text-transform: uppercase;">${cat}</div>
                                    <div style="font-size: 1.4rem; font-weight: 900; margin-top: 8px;">${count}</div>
                                    <div style="font-size: 0.6rem; color: var(--color-text-muted); margin-top: 4px;">Documentos</div>
                                </div>
                            `;
            }).join('')}
                    </div>

                    <!-- Lista de Manuales -->
                    <div class="card">
                        <h4 style="margin: 0 0 15px 0; font-size: 0.9rem;">📖 Documentos Disponibles</h4>
                        <div id="manual-list" style="display: grid; gap: 10px;">
                            ${biblioteca.length > 0 ? biblioteca.map(m => `
                                <div class="card" style="background: rgba(255, 255, 255, 0.02); padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                            <span class="material-symbols-rounded" style="font-size: 24px; color: var(--color-primary);">description</span>
                                            <div>
                                                <div style="font-weight: 700; font-size: 0.9rem;">${m.titulo}</div>
                                                <div style="font-size: 0.65rem; color: var(--color-text-muted);">${m.descripcion}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.65rem; color: var(--color-text-muted); font-weight: 800;">${m.categoria}</div>
                                            <div style="font-size: 0.6rem; background: rgba(59, 130, 246, 0.2); color: var(--color-primary); padding: 2px 8px; border-radius: 4px; margin-top: 3px;">${m.tipo}</div>
                                        </div>
                                        <div style="display: flex; gap: 5px;">
                                            <button onclick="abrirManual('${m.url}')" class="btn btn-primary" style="padding: 8px 12px; font-size: 0.7rem;">
                                                <span class="material-symbols-rounded" style="font-size: 16px;">open_in_new</span>
                                            </button>
                                            ${isadmin ? `
                                                <button onclick="deleteManual(${m.id})" class="btn" style="padding: 8px 12px; background: rgba(239, 68, 68, 0.1); color: var(--color-danger); border: 1px solid rgba(239, 68, 68, 0.2);">
                                                    <span class="material-symbols-rounded" style="font-size: 16px;">delete</span>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div style="text-align: center; color: var(--color-text-muted); padding: 20px;">No hay documentos registrados.</div>'}
                        </div>
                    </div>

                    <!-- Nota informativa -->
                    <div class="card" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); margin-top: 20px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span class="material-symbols-rounded" style="color: var(--color-primary); font-size: 24px;">info</span>
                            <div>
                                <div style="font-weight: 700; font-size: 0.85rem; color: var(--color-primary); margin-bottom: 5px;">Documentación de Equipos</div>
                                <div style="font-size: 0.75rem; color: var(--color-text-muted);">
                                    Los manuales específicos de cada equipo también están disponibles en la <b>Ficha de Detalle</b> del activo correspondiente.
                                </div>
                            </div>
                        </div>
            </div>
                </div>
            `;
        }

        function filterBiblioteca(categoria) {
            alert(`Filtrar por categoría "${categoria}" - Funcionalidad en desarrollo`);
        }

        function abrirManual(url) {
            if (url === '#' || !url) {
                alert('Este es un manual de ejemplo. Registra un enlace real (Drive/Dropbox/OneDrive) para abrir el visor.');
            } else {
                window.open(url, '_blank');
            }
        }

        function deleteManual(id) {
            if (confirm('¿Estás seguro de eliminar este manual de la biblioteca?')) {
                const idx = biblioteca.findIndex(m => m.id === id);
                if (idx !== -1) {
                    biblioteca.splice(idx, 1);
                    persist();
                    navigate('biblioteca');
                }
            }
        }

        function abrirModalManual() {
            const modal = document.getElementById('modal-generic');
            const content = document.getElementById('modal-generic-content');

            content.innerHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">📕 Registrar Nuevo Manual</h3>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 5px; font-weight: 800;">TÍTULO DEL DOCUMENTO</label>
                            <input type="text" id="man-titulo" placeholder="Ej: Manual de Operación Caldera v2" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; color: white;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="display: block; font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 5px; font-weight: 800;">CATEGORÍA</label>
                                <select id="man-cat" style="width: 100%; background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; color: white;">
                                    <option value="Seguridad">Seguridad</option>
                                    <option value="Clima">Clima</option>
                                    <option value="Eléctrico">Eléctrico</option>
                                    <option value="Mecánico">Mecánico</option>
                                    <option value="Hidráulico">Hidráulico</option>
                                    <option value="Infraestructura">Infraestructura</option>
                                    <option value="General">General</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 5px; font-weight: 800;">TIPO</label>
                                <select id="man-tipo" style="width: 100%; background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; color: white;">
                                    <option value="PDF">Documento PDF</option>
                                    <option value="XLSX">Excel / Sheet</option>
                                    <option value="VIDEO">Video Tutorial</option>
                                    <option value="URL">Enlace Web</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 5px; font-weight: 800;">ENLACE DRIVE / CLOUD (OPCIÓN A)</label>
                            <input type="text" id="man-url" placeholder="https://drive.google.com/file/d/..." style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; color: var(--color-primary);">
                            <div style="font-size: 0.6rem; color: var(--color-text-muted); margin-top: 5px;">Asegúrate de que el enlace tenga permisos de lectura para "Cualquiera con el enlace".</div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.7rem; color: var(--color-text-muted); margin-bottom: 5px; font-weight: 800;">DESCRIPCIÓN BREVE</label>
                            <textarea id="man-desc" placeholder="¿Para qué sirve este documento?" style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; color: white; height: 80px;"></textarea>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button onclick="closeModalGeneric()" class="btn" style="flex: 1; padding: 12px;">Cancelar</button>
                        <button onclick="saveManual()" class="btn btn-primary" style="flex: 2; padding: 12px;">Guardar Manual</button>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }

        function saveManual() {
            const titulo = document.getElementById('man-titulo').value;
            const cat = document.getElementById('man-cat').value;
            const tipo = document.getElementById('man-tipo').value;
            const url = document.getElementById('man-url').value;
            const desc = document.getElementById('man-desc').value;

            if (!titulo || !url) {
                alert('El título y el enlace son obligatorios.');
                return;
            }

            const newMan = {
                id: Date.now(),
                titulo: titulo,
                categoria: cat,
                tipo: tipo,
                url: url,
                descripcion: desc
            };

            biblioteca.unshift(newMan);
            persist();
            closeModalGeneric();
            navigate('biblioteca');
        }

        function closeModalGeneric() {
            const modal = document.getElementById('modal-generic');
            if (modal) modal.style.display = 'none';
        }

        // ========== TECH PRO PACK ==========

        // Cronómetro de Tareas
        function startOTTimer(otId) {
            const ot = ots.find(o => o.id === otId);
            if (!ot) return;

            if (ot.timerActive) {
                alert('El cronómetro ya está en marcha para esta tarea.');
                return;
            }

            // NUEVO: Abrir modal de seguridad en lugar de iniciar directamente
            document.getElementById('safety-ot-id').value = otId;

            // Reset checkboxes
            document.querySelectorAll('.safety-item').forEach(cb => cb.checked = false);
            document.getElementById('safety-declaration').checked = false;

            // Abrir modal
            document.getElementById('modal-safety-check').style.display = 'flex';
        }

        function stopOTTimer(otId) {
            const ot = ots.find(o => o.id === otId);
            if (!ot || !ot.timerActive) return;

            const endTime = new Date();
            const startTime = new Date(ot.startTime);
            const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);

            ot.totalHH = (ot.totalHH || 0) + hoursWorked;
            ot.timerActive = false;
            ot.startTime = null;
            persist();
            renderCurrentView();
            alert(`⏹️ Cronómetro detenido. Has trabajado ${hoursWorked.toFixed(2)} horas en esta sesión.\nTotal acumulado: ${ot.totalHH.toFixed(2)} horas.`);
        }

        function confirmSafetyAndStart() {
            const otId = parseInt(document.getElementById('safety-ot-id').value);
            const ot = ots.find(o => o.id === otId);
            if (!ot) return;

            // Validar que todos los checkboxes estén marcados
            const helmet = document.getElementById('safety-helmet').checked;
            const gloves = document.getElementById('safety-gloves').checked;
            const glasses = document.getElementById('safety-glasses').checked;
            const lockout = document.getElementById('safety-lockout').checked;
            const declaration = document.getElementById('safety-declaration').checked;

            if (!declaration) {
                alert('⚠️ Debes aceptar la declaración jurada antes de continuar.');
                return;
            }

            if (!helmet || !gloves || !glasses) {
                const confirmContinue = confirm('⚠️ ADVERTENCIA: No has confirmado todos los EPP básicos (Casco, Guantes, Lentes).\n\n¿Estás seguro de que quieres continuar sin estos elementos? Esta decisión quedará registrada.');
                if (!confirmContinue) return;
            }

            // Crear registro de seguridad (AUDITORÍA)
            const safetyRecord = {
                id: Date.now(),
                otId: otId,
                tecnico: currentUser ? currentUser.nombre : 'Usuario',
                tecnicoId: currentUser ? currentUser.id : null,
                timestamp: new Date().toISOString(),
                epp: {
                    casco: helmet,
                    guantes: gloves,
                    lentes: glasses,
                    bloqueoLOTO: lockout
                },
                declarationAccepted: true
            };

            // Guardar en logs
            safetyLogs.push(safetyRecord);
            localStorage.setItem('cmms_safety_logs', JSON.stringify(safetyLogs));

            // Guardar referencia en la OT
            ot.safetyLogId = safetyRecord.id;

            // AHORA SÍ: Iniciar el cronómetro
            ot.timerActive = true;
            ot.startTime = new Date().toISOString();
            ot.totalHH = ot.totalHH || 0;
            persist();

            // Cerrar modal y actualizar vista
            closeSafetyModal();
            renderCurrentView();
            alert('✅ Declaración de seguridad registrada.\n⏱️ Cronómetro iniciado.');
        }

        function closeSafetyModal() {
            document.getElementById('modal-safety-check').style.display = 'none';
        }

        function mostrarQuickFix(equipoNombre, descripcion, tecnico, fecha) {
            const modal = document.getElementById('modal-generic');
            const content = document.getElementById('modal-generic-content');

            content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 15px; background: linear-gradient(135deg, var(--color-primary), #a855f7); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span class="material-symbols-rounded" style="font-size: 32px; color: white;">bolt</span>
                    </div>
                    <h3 style="margin: 0 0 10px 0; color: var(--color-primary);">⚡ Quick-Fix</h3>
                    <div style="font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 20px;">${equipoNombre}</div>
                    
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 15px; text-align: left; margin-bottom: 20px;">
                        <div style="font-size: 0.65rem; color: var(--color-primary); font-weight: 800; text-transform: uppercase; margin-bottom: 8px;">Última Solución Exitosa:</div>
                        <div style="font-size: 0.85rem; line-height: 1.5; color: white; margin-bottom: 12px;">"${descripcion}"</div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--color-text-muted);">
                            <span>👤 ${tecnico}</span>
                            <span>📅 ${fecha}</span>
                        </div>
                    </div>
                    
                    <button onclick="closeModalGeneric()" class="btn btn-primary" style="width: 100%; padding: 12px; font-weight: 700;">
                        ENTENDIDO
                    </button>
                </div>
            `;
            modal.style.display = 'flex';
        }

        // Quick-Fix: Consultar última solución
        function getQuickFix(equipoId) {
            const equipo = equipos.find(e => e.id === equipoId);
            if (!equipo || !equipo.historial || equipo.historial.length === 0) {
                alert('📚 No hay historial previo para este equipo. Esta sería la primera intervención.');
                return;
            }

            const ultimaIntervencion = equipo.historial[0];
            const mensaje = `
💡 ÚLTIMA SOLUCIÓN APLICADA\n
Fecha: ${ultimaIntervencion.fecha}
Técnico: ${ultimaIntervencion.tecnico}
Tarea: ${ultimaIntervencion.tarea}

Descripción: ${ultimaIntervencion.desc}

${ultimaIntervencion.especialidad ? `Especialidad requerida: ${ultimaIntervencion.especialidad}` : ''}
            `.trim();

            alert(mensaje);
        }

        // Reporte de Incidente de Seguridad
        function reportSafetyIncident() {
            const descripcion = prompt('🚨 REPORTE DE CONDICIÓN INSEGURA\n\nDescribe el riesgo detectado\n(Ejemplo: Cable pelado en sala de bombas, piso resbaladizo en pasillo 3, etc.):');

            if (!descripcion || descripcion.trim() === '') return;

            const newOT = {
                id: Date.now(),
                titulo: '🚨 RIESGO DE SEGURIDAD',
                descripcion: descripcion,
                reportadoPor: currentUser.nombre,
                prioridad: 'ALTA',
                estado: 'pendiente',
                tipo: 'seguridad',
                fecha: new Date().toISOString().split('T')[0]
            };
            ots.push(newOT);
            persist();

            alert('✅ Reporte de seguridad enviado al Supervisor.\nSe ha generado una OT de prioridad ALTA.');

            // Notificar al supervisor si está disponible
            logManagementAction('Seguridad', `Reporte de riesgo: ${descripcion.substring(0, 50)}...`, 'warning');
        }

        // Generar Certificado de Cumplimiento de Seguridad (PDF)
        async function generateSafetyCompliancePDF(tecnicoId) {
            const tecnico = tecnicos.find(t => t.id === tecnicoId);
            if (!tecnico) {
                alert('Técnico no encontrado.');
                return;
            }

            // Filtrar logs de seguridad del técnico
            const tecnicoLogs = safetyLogs.filter(log => log.tecnicoId === tecnicoId);

            if (tecnicoLogs.length === 0) {
                alert(`${tecnico.nombre} no tiene registros de seguridad aún.`);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // --- HEADER CORPORATIVO ---
            // Barra superior oscura
            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 210, 40, 'F');

            // Logo / Nombre Empresa
            doc.setTextColor(245, 158, 11); // Color secundario/dorado
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text(APP_CONFIG.companyName, 15, 15);

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.text(APP_CONFIG.companyAddress, 15, 21);
            doc.text(`Tel: ${APP_CONFIG.companyPhone} | ${APP_CONFIG.companyEmail}`, 15, 26);


            // Título del Documento (Alineado a la derecha)
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("CERTIFICADO DE CUMPLIMIENTO", 195, 15, { align: 'right' });
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.text("REGISTRO DE DECLARACIONES EPP - AUDITORÍA INTERNA", 195, 21, { align: 'right' });

            // Información del Técnico
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("DATOS DEL TÉCNICO", 15, 55);
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.text(`Nombre: ${tecnico.nombre}`, 15, 62);
            doc.text(`ID: ${tecnico.id}`, 15, 68);
            doc.text(`Período: ${new Date().toLocaleDateString()}`, 15, 74);
            doc.text(`Total de Declaraciones: ${tecnicoLogs.length}`, 15, 80);

            // Tabla de Registros
            const tableData = tecnicoLogs.map(log => {
                const ot = ots.find(o => o.id === log.otId);
                const fecha = new Date(log.timestamp).toLocaleString('es-CL');
                const eppStatus = [
                    log.epp.casco ? '✓' : '✗',
                    log.epp.guantes ? '✓' : '✗',
                    log.epp.lentes ? '✓' : '✗',
                    log.epp.bloqueoLOTO ? '✓' : '✗'
                ].join(' | ');

                return [
                    ot ? `#${ot.id}` : 'N/A',
                    fecha,
                    eppStatus,
                    log.declarationAccepted ? 'SÍ' : 'NO'
                ];
            });

            doc.autoTable({
                startY: 90,
                head: [['OT', 'Fecha/Hora', 'EPP (C|G|L|LOTO)', 'Declaración']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [245, 158, 11], fontStyle: 'bold' },
                styles: { fontSize: 7, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 50 },
                    2: { cellWidth: 70 },
                    3: { cellWidth: 30 }
                }
            });

            const finalY = doc.previousAutoTable.finalY + 15;

            // Nota Legal
            doc.setFontSize(7);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(100);
            doc.text("NOTA LEGAL:", 15, finalY);
            doc.text("Este documento certifica que el técnico realizó las declaraciones de seguridad requeridas antes de iniciar cada", 15, finalY + 5);
            doc.text("trabajo. La falta de uso efectivo de EPP a pesar de la declaración constituye una falta grave personal del", 15, finalY + 10);
            doc.text("trabajador y exime de responsabilidad a la empresa en caso de accidente laboral por incumplimiento.", 15, finalY + 15);

            // --- PIE DE PÁGINA (FIRMA) ---
            const firmaY = finalY + 45;

            // Línea de firma
            doc.setDrawColor(30, 41, 59);
            doc.line(120, firmaY, 190, firmaY);

            // Datos del Responsable (Configurables)
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.setTextColor(30, 41, 59);
            doc.text(APP_CONFIG.signerName.toUpperCase(), 120, firmaY + 5);

            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.text(APP_CONFIG.signerRole, 120, firmaY + 10);
            doc.text(APP_CONFIG.companyName, 120, firmaY + 15);

            // Footer bottom page
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(7);
            doc.setTextColor(150);
            doc.text(`${APP_CONFIG.systemName} - Generado el ${new Date().toLocaleString()}`, 105, pageHeight - 10, { align: 'center' });
            doc.text(APP_CONFIG.companyWebsite, 105, pageHeight - 7, { align: 'center' });

            doc.save(`Cumplimiento_Seguridad_${tecnico.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Exponer funciones globalmente
        window.renderBodega = renderBodega;
        window.filterByZone = filterByZone;
        window.renderBiblioteca = renderBiblioteca;
        window.filterBiblioteca = filterBiblioteca;
        window.abrirManual = abrirManual;
        window.deleteManual = deleteManual;
        window.abrirModalManual = abrirModalManual;
        window.saveManual = saveManual;
        window.closeModalGeneric = closeModalGeneric;
        window.mostrarQuickFix = mostrarQuickFix;
        window.startOTTimer = startOTTimer;
        window.stopOTTimer = stopOTTimer;
        window.confirmSafetyAndStart = confirmSafetyAndStart;
        window.closeSafetyModal = closeSafetyModal;
        window.getQuickFix = getQuickFix;
        window.reportSafetyIncident = reportSafetyIncident;
        window.generateSafetyCompliancePDF = generateSafetyCompliancePDF;
    </script>
</body>

<!-- MOBILE BOTTOM NAVIGATION -->
<div class="mobile-nav"
    style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-surface); border-top: 1px solid var(--color-border); z-index: 1000; padding: 8px 0; safe-area-inset-bottom: env(safe-area-inset-bottom);">
    <div style="display: flex; justify-content: space-around; align-items: center; max-width: 600px; margin: 0 auto;">
        <button onclick="navigate('ots')" class="mobile-nav-btn" data-page="ots"
            style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 8px; transition: all 0.2s;">
            <span class="material-symbols-rounded" style="font-size: 24px;">assignment</span>
            <span style="font-size: 0.65rem; font-weight: 500;">Tareas</span>
        </button>
        <button onclick="navigate('activos')" class="mobile-nav-btn" data-page="activos"
            style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 8px; transition: all 0.2s;">
            <span class="material-symbols-rounded" style="font-size: 24px;">precision_manufacturing</span>
            <span style="font-size: 0.65rem; font-weight: 500;">Equipos</span>
        </button>
        <button onclick="navigate('bodega')" class="mobile-nav-btn" data-page="bodega"
            style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 8px; transition: all 0.2s;">
            <span class="material-symbols-rounded" style="font-size: 24px;">inventory_2</span>
            <span style="font-size: 0.65rem; font-weight: 500;">Bodega</span>
        </button>
        <button onclick="navigate('biblioteca')" class="mobile-nav-btn" data-page="biblioteca"
            style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 8px; transition: all 0.2s;">
            <span class="material-symbols-rounded" style="font-size: 24px;">menu_book</span>
            <span style="font-size: 0.65rem; font-weight: 500;">Biblioteca</span>
        </button>
        <button onclick="navigate('perfil')" class="mobile-nav-btn" data-page="perfil"
            style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 8px; transition: all 0.2s;">
            <span class="material-symbols-rounded" style="font-size: 24px;">account_circle</span>
            <span style="font-size: 0.65rem; font-weight: 500;">Perfil</span>
        </button>
    </div>
</div>

<style>
    /* Mobile Navigation Styles */
    @media (max-width: 767px) {
        .mobile-nav {
            display: block !important;
        }

        .mobile-nav-btn.active {
            color: var(--color-primary) !important;
        }

        .mobile-nav-btn:active {
            transform: scale(0.95);
        }

        /* Adjust content padding for mobile nav */
        .content {
            padding-bottom: calc(var(--nav-height) + 20px) !important;
        }
    }

    @media (min-width: 768px) {
        .mobile-nav {
            display: none !important;
        }
    }
</style>

<script>
    // Update mobile nav active state
    let currentPage = 'dashboard'; // Variable global para tracking de página actual

    function updateMobileNav() {
        const buttons = document.querySelectorAll('.mobile-nav-btn');
        buttons.forEach(btn => {
            if (btn.dataset.page === currentPage) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    // Call this when navigate() is called
    const originalNavigate = navigate;
    navigate = function (page) {
        currentPage = page; // Actualizar página actual
        originalNavigate(page);
        updateMobileNav();
    };
</script>

<script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('✅ Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('❌ Service Worker registration failed:', error);
                });
        });
    }

    // PWA Install Prompt
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('💾 PWA Install prompt available');
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;

        // Show custom install banner
        showPWABanner();
    });

    // Show PWA install banner
    function showPWABanner() {
        const banner = document.getElementById('pwa-install-banner');

        // Check if user already dismissed it
        if (localStorage.getItem('pwa_banner_dismissed') === 'true') {
            console.log('User previously dismissed install banner');
            return;
        }

        if (banner && deferredPrompt) {
            // Wait 2 seconds after login to show banner
            setTimeout(() => {
                banner.style.display = 'block';
            }, 2000);
        }
    }

    // Close PWA banner
    function closePWABanner() {
        const banner = document.getElementById('pwa-install-banner');
        if (banner) {
            banner.style.display = 'none';
        }
        // Remember user dismissed it
        localStorage.setItem('pwa_banner_dismissed', 'true');
    }

    // Function to trigger install prompt
    function installPWA() {
        if (deferredPrompt) {
            // Hide the banner
            const banner = document.getElementById('pwa-install-banner');
            if (banner) banner.style.display = 'none';

            // Show the install prompt
            deferredPrompt.prompt();

            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('✅ User accepted the install prompt');
                    alert('¡Perfecto! XELONIA se está instalando en tu teléfono.');
                } else {
                    console.log('❌ User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        } else {
            // Fallback for when event hasn't fired
            alert('Para instalar XELONIA:\n\n1. Toca el menú (⋮) arriba a la derecha\n2. Selecciona "Agregar a pantalla de inicio" o "Instalar aplicación"\n3. Confirma la instalación');
        }
    }

    // Detect when PWA is installed
    window.addEventListener('appinstalled', () => {
        console.log('🎉 XELONIA uptime has been installed!');
        const banner = document.getElementById('pwa-install-banner');
        if (banner) banner.style.display = 'none';
        deferredPrompt = null;

        setTimeout(() => {
            alert('🎉 ¡XELONIA instalada exitosamente!\n\nBusca el ícono de la tortuga en tu pantalla de inicio.');
        }, 500);
    });
</script>

<!-- Notification Logic -->
<!-- Botón flotante de actualización forzada -->
<button id="force-update-btn" style="
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-primary), #2563eb);
    border: none;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    cursor: pointer;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
" onclick="forceAppUpdate()">
    <span class="material-symbols-rounded" style="color: white; font-size: 28px;">sync</span>
</button>

<script>
    // Función para forzar actualización de la App
    async function forceAppUpdate() {
        const btn = document.getElementById('force-update-btn');
        const icon = btn.querySelector('.material-symbols-rounded');

        // Animación de rotación
        icon.style.animation = 'spin 1s linear infinite';

        try {
            // PASO 1: Sincronizar datos a Firebase ANTES de borrar
            console.log('📤 Syncing data to cloud before update...');
            if (typeof firebase !== 'undefined' && firebase.firestore) {
                const db = firebase.firestore();

                // Sincronizar datos del sistema
                await db.collection('cmms').doc('system_data').set({
                    equipos: equipos || [],
                    ots: ots || [],
                    tecnicos: tecnicos || [],
                    repuestos: repuestos || [],
                    laborLogs: laborLogs || [],
                    toolLogs: toolLogs || [],
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                console.log('✅ Data synced to cloud');
            }

            // PASO 2: Desregistrar Service Workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                    console.log('🗑️ Service Worker unregistered');
                }
            }

            // 2. Limpiar todos los cachés
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(
                    cacheNames.map(cacheName => caches.delete(cacheName))
                );
                console.log('🗑️ All caches cleared');
            }

            // 3. Limpiar localStorage y sessionStorage
            localStorage.clear();
            sessionStorage.clear();
            console.log('🗑️ Storage cleared');

            // 4. Mostrar mensaje y recargar
            alert('✅ Datos sincronizados y actualización completada\n\nLa app se recargará con la versión más reciente.');

            // 5. Recargar forzadamente desde el servidor
            window.location.reload(true);

        } catch (error) {
            console.error('❌ Error during force update:', error);
            icon.style.animation = 'none';
            alert('❌ Error al actualizar. Intenta cerrar y abrir la app de nuevo.');
        }
    }

    // Añadir animación de rotación
    const style = document.createElement('style');
    style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    #force-update-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
    }
    #force-update-btn:active {
        transform: scale(0.95);
    }
`;
    document.head.appendChild(style);
</script>

<script src="js/notifications.js"></script>

</html>